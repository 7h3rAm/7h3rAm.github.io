<!DOCTYPE html>
<html lang="en" data-theme-mode="light">
<head>
  <meta charset="utf-8">
  <meta name="author" content="Ankur Tyagi (7h3rAm)">
  <meta name="description" content="Personal Weblog">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Manthan</title>
  <link rel="icon" type="image/webp" sizes="32x32" href="/static/images/manthan-32x32.png.webp">
  <link rel="stylesheet" href="/static/css/base.css">
  <link rel="stylesheet" href="/static/css/atelier-forest-light.css">
  <script src="/static/js/theme.js"></script>
  <script src="/static/js/highlight.min.js"></script>
  <script src="/static/js/hljs-bash.min.js"></script>
  <script src="/static/js/hljs-python.min.js"></script>
  <script src="/static/js/hljs-sql.min.js"></script>
  <script src="/static/js/hljs-powershell.min.js"></script>
  <script src="/static/js/hljs-line-numbers.min.js"></script>
</head>
<body>

<header>
  <div class="header-top">
    <div class="title-wrapper">
      <h1 class="site-title"><a href="/" style="color:inherit;text-decoration:none;">manthan</a></h1>
      <span class="meta">security research | code | writeups</span>
    </div>
    <div class="nav-and-toggles">
      <div class="nav-links">
        <a href="/archive.html">archive</a>
        <a href="/tags.html">tags</a>
        <a href="/stats.html">stats</a>
      </div>
      <div class="toggle-buttons">
        <button class="toggle-btn toggle-theme" onclick="toggleThemeMode()">&#xf05a8;</button>
        <button class="toggle-btn toggle-density" onclick="toggleDensity()">&#xf084f;</button>
        <button class="toggle-btn toggle-width" onclick="toggleWidth()">&#xf084e;</button>
        <button class="toggle-btn toggle-justify" onclick="toggleJustify()">&#xf039;</button>
        <button class="toggle-btn toggle-collapse" onclick="toggleAllSections()">&#xf151;</button>
      </div>
    </div>
  </div>
</header>

<article id="top">
  <div class="post-header">
    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
      <div>
        <h1 class="post-title" style="margin:0;">cigma: A Pure Python Filetype Identification Library</h1>
      </div>
      <div class="meta" style="text-align:right;">
        <div>22/Nov/2015</div>
        <div class="tags"><a href="/tags.html#code">code</a></div>
      </div>
    </div>
  </div>

  <div class="content">
    <h2 class="h2 collapsible" onclick="toggle(this);">Introduction</h2>
<p class="nested active">Filetype identification is the process of scanning <a href="https://en.wikipedia.org/wiki/Magic_number_%28programming%29">respective</a> <a href="https://en.wikipedia.org/wiki/List_of_file_signatures">magicbytes</a> for each filetype within input streams. The mapping for various filetypes and their magicbytes are stored in different formats which is then queried by the identification library. If a match is found, input stream is classified to be of that type. In case of match collisions, a signature preference logic prioritizes matches. Tools like <a href="http://mark0.net/soft-trid-e.html">TrID</a> and <a href="http://www.forensicswiki.org/wiki/File_Format_Identification">others</a> use similar logic.</p>
<p class="nested active"><a href="https://github.com/7h3rAm/cigma">cigma</a> is a Python library to identify filetypes. It provides <a href="https://github.com/threatstack/libmagic">libmagic</a> like mimetype identification of a file or data buffer. This is similar to what the <code>file</code> command on *nix systems will provide:</p>
<pre class="nested active"><code>$ file cigma.py
cigma.py: Python script, ASCII text executable
$
$ file readme.md
readme.md: Python script, ASCII text executable, with very long lines
$
$ file /bin/ls
/bin/ls: ELF 64-bit LSB  executable, x86-64, version 1 (SYSV), dynamically linked (uses shared libs), for GNU/Linux 2.6.24, BuildID[sha1]=9d2a434c4ff55aad2ddd19348c0ac75971606483, stripped
$
$ file /etc/passwd
/etc/passwd: ASCII text
$
$ file /dev/sda
/dev/sda: block special
</code></pre>
<h2 class="h2 collapsible" onclick="toggle(this);">Usage and Usecases</h2>
<p class="nested active"><code>cigma</code> uses a custom JSON formatted signature file to stores filetype mappings. Let's try identifying a few files:</p>
<pre class="nested active"><code>$ python cigma.py /bin/ls
('/bin/ls',
 {'id': 29,
  'longname': 'Executable and Linkable Format (ELF)',
  'mimetype': 'application/x-executable',
  'patterns': [{'offset': 0, 'regex': '\\x7F\\x45\\x4C\\x46', 'size': 4}],
  'shortname': 'ELF'})
$
$ python cigma.py ~/toolbox/testfiles/binary/suspicious/35d249cdd501aeb5a5b39daeb4f275c41c73e91ef299a094d27edbfd0396715d.VXE
('/home/shiv/toolbox/testfiles/binary/suspicious/35d249cdd501aeb5a5b39daeb4f275c41c73e91ef299a094d27edbfd0396715d.VXE',
 {'id': 31,
  'longname': 'Windows Executable',
  'mimetype': 'application/x-dosexec',
  'patterns': [{'offset': 0, 'regex': '\\x4D\\x5A', 'size': 2}],
  'shortname': 'EXE'})
$
$ python cigma.py ~/toolbox/testfiles/pcaps/exploitkits/2015-04-03-Nuclear-EK-traffic.pcap
('/home/shiv/toolbox/testfiles/pcaps/exploitkits/2015-04-03-Nuclear-EK-traffic.pcap',
 {'id': 5,
  'longname': 'Packet Capture (winpcap)',
  'mimetype': 'application/vnd.tcpdump.pcap',
  'patterns': [{'offset': 0, 'regex': '\\xD4\\xC3\\xB2\\xA1', 'size': 4}],
  'shortname': 'PCAP'})
</code></pre>
<p class="nested active">If a match is found, <code>cigma</code> returns a <code>(source, resultdict)</code> tuple. Here is a snippet of few signatures from the current set:</p>
<pre class="nested active"><code>{
  &quot;meta&quot;: {
    &quot;rulescount&quot;: 72,
    &quot;version&quot;: 0.1
  },
  &quot;rules&quot;: [
    {
      &quot;id&quot;: 1,
      &quot;longname&quot;: &quot;PKZIP&quot;,
      &quot;mimetype&quot;: &quot;application/octet-stream&quot;,
      &quot;patterns&quot;: [
        {
          &quot;offset&quot;: 0,
          &quot;regex&quot;: &quot;\\x50\\x4B\\x05\\x06&quot;,
          &quot;size&quot;: 4
        }
      ],
      &quot;shortname&quot;: &quot;ZIP&quot;
    },
    {
      &quot;id&quot;: 5,
      &quot;longname&quot;: &quot;Packet Capture (winpcap)&quot;,
      &quot;mimetype&quot;: &quot;application/vnd.tcpdump.pcap&quot;,
      &quot;patterns&quot;: [
        {
          &quot;offset&quot;: 0,
          &quot;regex&quot;: &quot;\\xD4\\xC3\\xB2\\xA1&quot;,
          &quot;size&quot;: 4
        }
      ],
      &quot;shortname&quot;: &quot;PCAP&quot;
    },
    {
      &quot;id&quot;: 27,
      &quot;longname&quot;: &quot;Flash Video&quot;,
      &quot;mimetype&quot;: &quot;video/x-flv&quot;,
      &quot;patterns&quot;: [
        {
          &quot;offset&quot;: 0,
          &quot;regex&quot;: &quot;\\x46\\x4C\\x56&quot;,
          &quot;size&quot;: 3
        }
      ],
      &quot;shortname&quot;: &quot;FLV&quot;
    },
    {
      &quot;id&quot;: 29,
      &quot;longname&quot;: &quot;Executable and Linkable Format (ELF)&quot;,
      &quot;mimetype&quot;: &quot;application/x-executable&quot;,
      &quot;patterns&quot;: [
        {
          &quot;offset&quot;: 0,
          &quot;regex&quot;: &quot;\\x7F\\x45\\x4C\\x46&quot;,
          &quot;size&quot;: 4
        }
      ],
      &quot;shortname&quot;: &quot;ELF&quot;
    }
  ]
}
</code></pre>
<p class="nested active">Adding a new signature is really easy. Just edit the included <code>magicbytes.json</code> file and add a new node with an unique <code>id</code>. Each node should have a <code>patterns</code> list which should contain the <code>offset</code>, <code>regex</code> and <code>size</code> keys with respective values.</p>
<p class="nested active">Using <code>cigma</code> as a library is really easy:</p>
<pre class="nested active"><code class="language-python">from cigma import Cigma
</code></pre>
<p class="nested active">One this is done, you can identify a file buffer:</p>
<pre class="nested active"><code class="language-python">with open(&quot;/home/shiv/toolbox/testfiles/binary/crafted_corkami/gui.exe&quot;) as fo:
  filedata = fo.read()

Cigma(data=filedata).cigma()
('databuffer',
 {'longname': 'Windows Executable',
  'mimetype': 'application/x-dosexec',
  'patterns': [{'offset': 0, 'regex': '\\x4D\\x5A', 'size': 2}],
  'shortname': 'EXE'})
</code></pre>
<p class="nested active">Or else you can also identify a file itself:</p>
<pre class="nested active"><code class="language-python">Cigma(filename=&quot;/home/shiv/toolbox/testfiles/binary/crafted_corkami/gui.exe&quot;).cigma()
('/home/shiv/toolbox/testfiles/binary/crafted_corkami/gui.exe',
 {'longname': 'Windows Executable',
  'mimetype': 'application/x-dosexec',
  'patterns': [{'offset': 0, 'regex': '\\x4D\\x5A', 'size': 2}],
  'shortname': 'EXE'})
</code></pre>
<h2 class="h2 collapsible" onclick="toggle(this);">Conclusion</h2>
<p class="nested active">The primary purpose of <code>cigma</code> is to be able to identify mundane files at lightning speeds. It doesn't aim to provide exhaustive insight into each file by parsing and decoding it. Currently, there are 70+ signatures and identification for more filetypes will be available as the project grows.</p>
  </div>

  <nav class="post-nav" style="margin-top:1em;">
    <a class="nav-prev" href="/posts/20150802_capinfos.html"><span class="arrow">&lt;&lt;&lt;</span> <span class="nav-title">capinfos.py: Pure Python Pcap Statistics Tool</span></a>    <a class="nav-next" href="/posts/20160218_flareon2014-15.html"><span class="nav-title">FireEye FLARE On 2014 Challenges (1-5)</span> <span class="arrow">&gt;&gt;&gt;</span></a>  </nav>
</article>

<script>
document.addEventListener('DOMContentLoaded', function() {
  var content = document.querySelector('.content');
  if (content) {
    var headings = content.querySelectorAll('h2,h3,h4,h5,h6');
    headings.forEach(function(h) {
      var link = document.createElement('a');
      link.href = '#top';
      link.className = 'top-link';
      link.textContent = ' [^]';
      link.style.fontSize = '0.8em';
      link.style.color = 'var(--muted)';
      h.appendChild(link);
    });
  }
});
</script>

<footer>
  <p class="nested active">cc-by-sa-4.0</p>
</footer>

<script>hljs.configure({ignoreUnescapedHTML: true}); hljs.highlightAll(); hljs.initLineNumbersOnLoad();</script>
</body>
</html>