<!DOCTYPE html>
<html lang="en" data-theme-mode="light">
<head>
  <meta charset="utf-8">
  <meta name="author" content="Ankur Tyagi (7h3rAm)">
  <meta name="description" content="Personal Weblog">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Manthan</title>
  <link rel="icon" type="image/webp" sizes="32x32" href="/static/images/manthan-32x32.png.webp">
  <link rel="stylesheet" href="/static/css/base.css">
  <link rel="stylesheet" href="/static/css/atelier-forest-light.css">
  <script src="/static/js/theme.js"></script>
  <script src="/static/js/highlight.min.js"></script>
  <script src="/static/js/hljs-bash.min.js"></script>
  <script src="/static/js/hljs-python.min.js"></script>
  <script src="/static/js/hljs-sql.min.js"></script>
  <script src="/static/js/hljs-powershell.min.js"></script>
  <script src="/static/js/hljs-line-numbers.min.js"></script>
</head>
<body>

<header>
  <div class="header-top">
    <div class="title-wrapper">
      <h1 class="site-title"><a href="/" style="color:inherit;text-decoration:none;">manthan</a></h1>
      <span class="meta">security research | code | writeups</span>
    </div>
    <div class="nav-and-toggles">
      <div class="nav-links">
        <a href="/archive.html">archive</a>
        <a href="/tags.html">tags</a>
        <a href="/stats.html">stats</a>
      </div>
      <div class="toggle-buttons">
        <button class="toggle-btn toggle-theme" onclick="toggleThemeMode()">&#xf05a8;</button>
        <button class="toggle-btn toggle-density" onclick="toggleDensity()">&#xf084f;</button>
        <button class="toggle-btn toggle-width" onclick="toggleWidth()">&#xf084e;</button>
        <button class="toggle-btn toggle-justify" onclick="toggleJustify()">&#xf039;</button>
        <button class="toggle-btn toggle-collapse" onclick="toggleAllSections()">&#xf151;</button>
      </div>
    </div>
  </div>
</header>

<article id="top">
  <div class="post-header">
    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
      <div>
        <h1 class="post-title" style="margin:0; cursor:pointer;" onclick="toggleAllSections()">Little PDF Puzzle from Didier Stevens</h1>
      </div>
      <div class="meta" style="text-align:right;">
        <div>18/Sep/2014</div>
        <div class="tags"><a href="/tags.html#ctf">ctf</a>, <a href="/tags.html#reversing">reversing</a></div>
      </div>
    </div>
    
  </div>

  <div class="content">
    <h2 class="h2 collapsible" onclick="toggle(this);">Introduction</h2>
<p class="nested active">While reading an article about <a href="http://blog.didierstevens.com/2008/04/09/quickpost-about-the-physical-and-logical-structure-of-pdf-files/">Physical and Logical Structure of PDF Files</a> on Didier Stevens's blog, I came across an interesting <a href="http://blog.didierstevens.com/2008/05/06/a-little-pdf-puzzle/">puzzle</a>. You can download the <a href="/static/files/posts_little_pdf/pdf-puzzle.pdf">file</a> to follow along or read the <a href="http://blog.didierstevens.com/2008/05/07/solving-a-little-pdf-puzzle/">writeup</a> from the author itself.</p>
<h2 class="h2 collapsible" onclick="toggle(this);">Challenge Analysis and Testing</h2>
<p class="nested active">Still here, great! Let's get started. First thing is to check what <code>exiftool</code> has to tell us about this file:</p>
<pre class="nested active"><code>$ exiftool pdf-puzzle.pdf
ExifTool Version Number         : 9.46
File Name                       : pdf-puzzle.pdf
Directory                       : .
File Size                       : 1243 bytes
File Modification Date/Time     : 2014:09:18 17:00:16+05:30
File Access Date/Time           : 2014:09:18 17:00:19+05:30
File Inode Change Date/Time     : 2014:09:18 17:00:16+05:30
File Permissions                : rw-rw-r--
File Type                       : PDF
MIME Type                       : application/pdf
PDF Version                     : 1.1
Linearized                      : No
Page Count                      : 1
</code></pre>
<p class="nested active">All these attributes look standard and nothing suspicious pops out in the output. The author, Didier Stevens, hints that it is a simple challenge and can be solved using just Notepad or a standard PDF reader. Let's view contents of this file in a text editor:</p>
<p class="nested active"><img alt="littlepdf-texteditor" src="/static/files/posts_little_pdf/littlepdf-texteditor.png.webp" /></p>
<p class="nested active">If you have not read Didier Stevens's <a href="http://blog.didierstevens.com/2008/04/09/quickpost-about-the-physical-and-logical-structure-of-pdf-files/">Physical and Logical Structure of PDF Files</a> post I strongly recommend reading it before reading further. It will help you identify something out of the ordinary in above output. There are two copies of xref table and trailer in this file hinting that it is probably a PDF with <a href="https://en.wikipedia.org/wiki/Portable_Document_Format#File_structure">Incremental Updates</a>. The new content (after the first <code>%%EOF</code>) has redefined object 5 and updated the xref table to help renders know its new offset. If you open this file in a PDF viewer, you will see something like this:</p>
<p class="nested active"><img alt="littlepdf-pdfjs" src="/static/files/posts_little_pdf/littlepdf-pdfjs.png.webp" /></p>
<p class="nested active">The reader is using updated object and renders its content, thus overriding the older object definition. Since both object definitions contain <code>ASCII85Decode</code> encoded streams, we can manually decode and look at the raw content:</p>
<pre class="nested active"><code class="language-python">$ ipython --no-banner

&gt;&gt;&gt; import ascii85
&gt;&gt;&gt;
&gt;&gt;&gt; ascii85.ascii85decode(&quot;'\7PQ#@1a#b0+&gt;GQ(+?(u.+B2ko-rakk+E1b1F)Yf5@&lt;6!&amp;BlbD!=BJ[-=BJ[-=BJ[-=BJ[-=BI!p&lt;,*OE;u~&quot;)
'\x14h\xd5&quot;4 Tf 100 700 Td (The passphrase is XXXXXXXXXXXXXXXXXXX) Tj ET'
&gt;&gt;&gt;
&gt;&gt;&gt; ascii85.ascii85decode(&quot;'\7PQ#@1a#b0+&gt;GQ(+?(u.+B2ko-rakk+E1b1F)Yf5@&lt;6!&amp;BlbCgDI[]uD.RU,@;I&amp;dE+EC!ATK:C&lt;,*OE;u~&quot;)
'\x14h\xd5&quot;4 Tf 100 700 Td (The passphrase is Incremental Updates) Tj ET'
&gt;&gt;&gt;
</code></pre>
<h2 class="h2 collapsible" onclick="toggle(this);">Conclusion</h2>
<p class="nested active">Awesome! The older object stream, when decoded (I'm using the ascii85 decoder from <a href="https://github.com/euske/pdfminer/blob/master/pdfminer/ascii85.py">pdfminer</a>), shows the passphrase. As suggested by Didier Stevens in his <a href="http://blog.didierstevens.com/2008/05/07/solving-a-little-pdf-puzzle/">writeup</a>, you could also remove the updated object content and xref table from the file to view the passphrase.</p>
  </div>

  <nav class="post-nav" style="margin-top:1em;">
    <a class="nav-prev" href="/posts/20140618_pcapgentools-contentype-patch.html"><span class="arrow">&lt;&lt;&lt;</span> <span class="nav-title">PCAP-GenerationTools and Content-Type Identification Patch</span></a>    <a class="nav-next" href="/posts/20141115_pcapedit.html"><span class="nav-title">pcapedit: An Interactive Scapy-based Pcap Editor</span> <span class="arrow">&gt;&gt;&gt;</span></a>  </nav>
</article>

<script>
document.addEventListener('DOMContentLoaded', function() {
  var content = document.querySelector('.content');
  if (content) {
    var headings = content.querySelectorAll('h2,h3,h4,h5,h6');
    headings.forEach(function(h) {
      var link = document.createElement('a');
      link.href = '#top';
      link.className = 'top-link';
      link.textContent = ' [^]';
      link.style.fontSize = '0.8em';
      link.style.color = 'var(--muted)';
      h.appendChild(link);
    });
  }
});
</script>

<footer>
  <p class="nested active">cc-by-sa-4.0</p>
</footer>

<script>hljs.configure({ignoreUnescapedHTML: true}); hljs.highlightAll(); hljs.initLineNumbersOnLoad();</script>
</body>
</html>