<!DOCTYPE html>
<html lang="en" data-theme-mode="light">
<head>
  <meta charset="utf-8">
  <meta name="author" content="Ankur Tyagi (7h3rAm)">
  <meta name="description" content="Personal Weblog">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Manthan</title>
  <link rel="icon" type="image/webp" sizes="32x32" href="/static/images/manthan-32x32.png.webp">
  <link rel="stylesheet" href="/static/css/base.css">
  <link rel="stylesheet" href="/static/css/atelier-forest-light.css">
  <script src="/static/js/theme.js"></script>
  <script src="/static/js/highlight.min.js"></script>
  <script src="/static/js/hljs-bash.min.js"></script>
  <script src="/static/js/hljs-python.min.js"></script>
  <script src="/static/js/hljs-sql.min.js"></script>
  <script src="/static/js/hljs-powershell.min.js"></script>
  <script src="/static/js/hljs-line-numbers.min.js"></script>
</head>
<body>

<header>
  <div class="header-top">
    <div class="title-wrapper">
      <h1 class="site-title"><a href="/" style="color:inherit;text-decoration:none;">manthan</a></h1>
      <span class="meta">security research | code | writeups</span>
    </div>
    <div class="nav-and-toggles">
      <div class="nav-links">
        <a href="/archive.html">archive</a>
        <a href="/tags.html">tags</a>
        <a href="/stats.html">stats</a>
      </div>
      <div class="toggle-buttons">
        <button class="toggle-btn toggle-theme" onclick="toggleThemeMode()">&#xf05a8;</button>
        <button class="toggle-btn toggle-density" onclick="toggleDensity()">&#xf084f;</button>
        <button class="toggle-btn toggle-width" onclick="toggleWidth()">&#xf084e;</button>
        <button class="toggle-btn toggle-justify" onclick="toggleJustify()">&#xf039;</button>
        <button class="toggle-btn toggle-collapse" onclick="toggleAllSections()">&#xf151;</button>
      </div>
    </div>
  </div>
</header>

<article id="top">
  <div class="post-header">
    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
      <div>
        <h1 class="post-title" style="margin:0; cursor:pointer;" onclick="toggleAllSections()">Shellcode Detection Module in ChopShop</h1>
      </div>
      <div class="meta" style="text-align:right;">
        <div>12/Mar/2015</div>
        <div class="tags"><a href="/tags.html#code">code</a></div>
      </div>
    </div>
  </div>

  <div class="content">
    <h2 class="h2 collapsible" onclick="toggle(this);">Introduction</h2>
<p class="nested active">Around an year ago I submitted a pull request to the <a href="https://github.com/MITRECND/chopshop">ChopShop</a> project from <a href="https://github.com/MITRECND">MITRECND</a>. This request included a module that enabled shellcode detection for TCP streams and UDP packets. In this post I'll show how to use this module to identify shellcode within network streams. Here's the project description:</p>
<p class="nested active"><code>ChopShop is a MITRE developed framework to aid analysts in the creation and execution of pynids based decoders and detectors of APT tradecraft.</code></p>
<p class="nested active">It provides reliable network stream reassembly via libnids and provides an API to write plugins/modules that can operate upon the reassembled network data. The project is in active development since September 2012 and numerous interesting modules have been added to it recently.</p>
<h2 class="h2 collapsible" onclick="toggle(this);">Patch Contribution</h2>
<p class="nested active">Last year I submitted a <a href="https://github.com/MITRECND/chopshop/pull/29">shellcode detection module</a> that was merged in the project with few changes. This module leverages ChopShop APIs to obtain network data and inspects it using <a href="http://7h3ram.github.io/posts/20130306_libemu-shellcode-detection.html">Libemu to check if it contains shellcode</a>. I got this idea while working on one of my projects, <a href="/posts/20141127_flowinspect.html">Flowinspect</a>, which includes shellcode detection and other interesting ways of identifying suspicious network traffic.</p>
<p class="nested active">To invoke ChopShop you need to provide a pcapfile as input and then a list of modules to be invoked. Each module can be provided respective arguments as well. Let's have a look at the command line invocation and usage of the shellcode module:</p>
<pre class="nested active"><code>$ ./chopshop -f ~/toolbox/testfiles/pcaps/shellcode/shellcode-winexec-calc.pcap &quot;shellcode_detector -xp&quot;
Starting ChopShop
Initializing Modules ...
    Initializing module 'shellcode_detector'
Running Modules ...
[2015-03-12 23:31:31 IST]  TCP 56.86.97.100:57416 - 89.86.105.74:80 [NEW]
[2015-03-12 23:31:31 IST]  TCP 56.86.97.100:57416 -&gt; 89.86.105.74:80 (CTS: 123B)
[2015-03-12 23:31:31 IST]  TCP 56.86.97.100:57416 &lt;- 89.86.105.74:80 (STC: 227B)
[2015-03-12 23:31:31 IST]  TCP 56.86.97.100:57416 - 89.86.105.74:80 contains shellcode in STC[0:227] @ offset 107

0000000: e8 44 00 00 00 8b 45 3c 8b 7c 05 78 01 ef 8b 4f  |.D....E&lt;.|.x...O|
0000010: 18 8b 5f 20 01 eb 49 8b 34 8b 01 ee 31 c0 99 ac  |.._ ..I.4...1...|
0000020: 84 c0 74 07 c1 ca 0d 01 c2 eb f4 3b 54 24 04 75  |..t........;T$.u|
0000030: e5 8b 5f 24 01 eb 66 8b 0c 4b 8b 5f 1c 01 eb 8b  |.._$..f..K._....|
0000040: 1c 8b 01 eb 89 5c 24 04 c3 5f 31 f6 60 56 64 8b  |.....\$.._1.`Vd.|
0000050: 46 30 8b 40 0c 8b 70 1c ad 8b 68 08 89 f8 83 c0  |F0.@..p...h.....|
0000060: 6a 50 68 f0 8a 04 5f 68 98 fe 8a 0e 57 ff e7 63  |jPh..._h....W..c|
0000070: 61 6c 63 2e 65 78 65 00                          |alc.exe.        |


UINT WINAPI WinExec (
     LPCSTR = 0xc00f6f10 =&gt;
           = &quot;calc.exe&quot;;
     UINT uCmdShow = 0;
) =  0x20;
LPTOP_LEVEL_EXCEPTION_FILTER SetUnhandledExceptionFilter (
     LPTOP_LEVEL_EXCEPTION_FILTER = 0xc00f7190 =&gt;
         none;
) =  0x7c81cdda;

Shutting Down Modules ...
    Shutting Down shellcode_detector
Module Shutdown Complete ...
ChopShop Complete
</code></pre>
<p class="nested active">In the above example, ChopShop was invoked to execute the <code>shellcode_detector</code> module with its <code>-p</code> and <code>-x</code> arguments. The output confirms that shellcode was found in the STC stream of input pcap at offset 107. The module then display a hexdump of shellcode bytes as well as a profiled output highlighting the Windows API calls, arguments and their return types. This output is extremely useful as it tells that the shellcode will spawn a <code>calc.exe</code> process if it is successfully deployed on the victim system.</p>
<h2 class="h2 collapsible" onclick="toggle(this);">Conclusion</h2>
<p class="nested active">You can also have a look at the module <a href="https://github.com/MITRECND/chopshop/blob/master/modules/shellcode_detector.py">sourcecode</a>. I would strongly recommend reading the <a href="https://github.com/MITRECND/chopshop/tree/master/docs/chopshop_docs">project documentation</a> to familiarize yourself with architecture and terminology. Also checkout the <a href="https://github.com/MITRECND/chopshop/blob/master/docs/chopshop_docs/module_authoring.md">module authoring documentation</a> and <a href="http://www.mitre.org/capabilities/cybersecurity/overview/cybersecurity-blog/how-chopshop-modules-work">this</a> amazing post by <a href="https://github.com/wxsBSD">Wesley Shields</a>, who is one of the project authors, if you wish to write your own modules.</p>
  </div>

  <nav class="post-nav" style="margin-top:1em;">
    <a class="nav-prev" href="/posts/20141127_flowinspect.html"><span class="arrow">&lt;&lt;&lt;</span> <span class="nav-title">Flowinspect: A Network Inspection Tool</span></a>    <a class="nav-next" href="/posts/20150527_ebctf-bin100.html"><span class="nav-title">Eindbazen CTF Challenge: bin100</span> <span class="arrow">&gt;&gt;&gt;</span></a>  </nav>
</article>

<script>
document.addEventListener('DOMContentLoaded', function() {
  var content = document.querySelector('.content');
  if (content) {
    var headings = content.querySelectorAll('h2,h3,h4,h5,h6');
    headings.forEach(function(h) {
      var link = document.createElement('a');
      link.href = '#top';
      link.className = 'top-link';
      link.textContent = ' [^]';
      link.style.fontSize = '0.8em';
      link.style.color = 'var(--muted)';
      h.appendChild(link);
    });
  }
});
</script>

<footer>
  <p class="nested active">cc-by-sa-4.0</p>
</footer>

<script>hljs.configure({ignoreUnescapedHTML: true}); hljs.highlightAll(); hljs.initLineNumbersOnLoad();</script>
</body>
</html>