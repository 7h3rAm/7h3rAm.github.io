<!DOCTYPE html>
<html lang="en" data-theme-mode="light">
<head>
  <meta charset="utf-8">
  <meta name="author" content="Ankur Tyagi (@7h3rAm)">
  <meta name="description" content="Personal Weblog">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Manthan</title>
  <link rel="icon" type="image/webp" sizes="32x32" href="/static/images/manthan-32x32.png.webp">
  <link rel="stylesheet" href="/static/css/base.css">
  <link rel="stylesheet" href="/static/css/atelier-forest-light.css">
  <script src="/static/js/theme.js"></script>
  <script src="/static/js/highlight.min.js"></script>
  <script src="/static/js/hljs-bash.min.js"></script>
  <script src="/static/js/hljs-python.min.js"></script>
  <script src="/static/js/hljs-sql.min.js"></script>
  <script src="/static/js/hljs-powershell.min.js"></script>
  <script src="/static/js/hljs-line-numbers.min.js"></script>
</head>
<body>

<header>
  <div>
    <h1 class="site-title"><a href="/" style="color:inherit;text-decoration:none;">manthan</a></h1>
    <p class="meta">security research | code | writeups</p>
  </div>
</header>

<article id="top">
  <div class="post-header">
    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
      <div>
        <h1 class="post-title" style="margin:0; cursor:pointer;" onclick="toggleAllSections()">capinfos.py: Pure Python Pcap Statistics Tool</h1>
      </div>
      <div class="meta" style="text-align:right;">
        <div>02/Aug/2015</div>
        <div class="tags"><a href="/tags.html#code">code</a></div>
      </div>
    </div>
    <nav class="post-nav" style="margin-top:0.3em;">
      <a class="nav-prev" href="/posts/20150527_ebctf-bin100.html"><span class="arrow">&lt;&lt;&lt;</span> <span class="nav-title">Eindbazen CTF Challenge: bin100</span></a>      <a class="nav-next" href="/posts/20151122_cigma.html"><span class="nav-title">cigma: A Pure Python Filetype Identification Library</span> <span class="arrow">&gt;&gt;&gt;</span></a>    </nav>
  </div>

  <div class="content">
    <h2 class="h2 collapsible" onclick="toggle(this);">Introduction</h2>
<p class="nested active">The <a href="https://www.wireshark.org/docs/man-pages/capinfos.html">capinfos</a> tool from Wireshark parses a pcap file and displays useful statistics like packet count, bitrate, byterate, capture duration, etc. I needed a pure-Python parser to obtain these details and ended up with the following code:</p>
<pre class="nested active"><code class="language-python">from pprint import pprint
import datetime
import struct
import sys

def capinfos(filename):
  # generates wireshark's capinfos like stats
  # limited features
  # needs additional testing
  file_handle = open(filename, 'rb')
  data = file_handle.read()
  pcapstats = dict()
  endianness = None
  datalink_types = {
    0: 'DLT_NULL',
    1: 'DLT_EN10MB',
    2: 'DLT_EN3MB',
    3: 'DLT_AX25',
    4: 'DLT_PRONET',
    5: 'DLT_CHAOS',
    6: 'DLT_IEEE802',
    7: 'DLT_ARCNET',
    8: 'DLT_SLIP',
    9: 'DLT_PPP',
    10: 'DLT_FDDI',
    18: 'DLT_PFSYNC',
    105: 'DLT_IEEE802_11',
    113: 'DLT_LINUX_SLL',
    117: 'DLT_PFLOG',
    127: 'DLT_IEEE802_11_RADIO'
  }
  # extract pcap magic using host's native endianess
  (pcap_magic, ) = struct.unpack('=I', data[:4])
  # if the pcap is LE
  if pcap_magic == 0xa1b2c3d4:
    (pcap_magic, pcap_version_major, pcap_version_minor, pcap_thiszone, pcap_sigfigs, pcap_snaplen, pcap_network) = struct.unpack('&lt;IHHIIII', data[:24])
    endianness = 'LITTLE'
  # if the pcap is BE
  elif pcap_magic == 0xd4c3b2a1:
    (pcap_magic, pcap_version_major, pcap_version_minor, pcap_thiszone, pcap_sigfigs, pcap_snaplen, pcap_network) = struct.unpack('&gt;IHHIIII', data[:24])
    endianness = 'BIG'
  # for pcaps which are something else (0x4d3c2b1a)?
  else:
    return pcapstats
  starttime = None
  endtime = None
  s = 24
  e = s + 16
  packetscount = 0
  bytescount = 0
  while True:
    if endianness is 'LITTLE':
      (ts_sec, ts_usec, incl_len, orig_len) = struct.unpack('&lt;IIII', data[s:e])
    elif endianness is 'BIG':
      (ts_sec, ts_usec, incl_len, orig_len) = struct.unpack('&gt;IIII', data[s:e])
    packetscount += 1
    bytescount += incl_len
    if not starttime:
      starttime = datetime.datetime.fromtimestamp(ts_sec)
      bytescount += incl_len
    endtime = datetime.datetime.fromtimestamp(ts_sec)
    s = e + incl_len
    e = s + 16
    if e &gt; len(data):
      break
  totsecs = int((endtime - starttime).total_seconds())
  if totsecs &lt; 1:
    totsecs = 1
  pcapstats['totsecs'] = totsecs
  pcapstats['pcapmagic'] = '0x%08X' % pcap_magic
  pcapstats['version_major'] = pcap_version_major
  pcapstats['version_minor'] = pcap_version_minor
  pcapstats['snaplen'] = pcap_snaplen
  pcapstats['pcapencapsulation'] = datalink_types[pcap_network]
  pcapstats['packetscount'] = packetscount
  pcapstats['bytescount'] = bytescount
  pcapstats['capturestarttime'] = starttime.strftime('%c').strip()
  pcapstats['captureendtime'] = endtime.strftime('%c').strip()
  pcapstats['captureduration'] = (endtime - starttime).total_seconds()
  byterate = (bytescount / totsecs) if totsecs &gt; 0 else bytescount
  bitrate = ((bytescount * 8) / totsecs) if totsecs &gt; 0 else (bytescount * 8)
  pcapstats['byterate'] = byterate
  pcapstats['bitrate'] = bitrate
  avgpacketsize = (bytescount / packetscount) if packetscount &gt; 0 else bytescount
  avgpacketrate = (packetscount / totsecs) if totsecs &gt; 0 else packetscount
  pcapstats['avgpacketsize'] = avgpacketsize
  pcapstats['avgpacketrate'] = avgpacketrate
  return dict(pcapstats)


if __name__ == &quot;__main__&quot;:
  if len(sys.argv) != 2:
    print &quot;USAGE: %s &lt;filename&gt;&quot; % (sys.argv[0])
    sys.exit(1)

  pprint(capinfos(sys.argv[1]))
</code></pre>
<h2 class="h2 collapsible" onclick="toggle(this);">Usage</h2>
<p class="nested active">Let's try this script on a HTTP pcap:</p>
<pre class="nested active"><code>$ python capinfos.py /media/shiv/red_third/stoolbox/testfiles/pcaps/layer7/http_espn.pcap
{
 'avgpacketrate': 478,
 'avgpacketsize': 682,
 'bitrate': 2609012,
 'byterate': 326126,
 'bytescount': 652253,
 'captureduration': 2.0,
 'captureendtime': 'Wed Apr  7 22:59:31 2010',
 'capturestarttime': 'Wed Apr  7 22:59:29 2010',
 'packetscount': 956,
 'pcapencapsulation': 'DLT_EN10MB',
 'pcapmagic': '0xA1B2C3D4',
 'snaplen': 65535,
 'totsecs': 2,
 'version_major': 2,
 'version_minor': 4
}
</code></pre>
<h2 class="h2 collapsible" onclick="toggle(this);">Conclusion</h2>
<p class="nested active">The script accepts a pcap file as input and natively parse its structure to calculate required values. As can be seen in the output file, it shows a quick summary of statistics which could be quite useful for scripting and automation or to have a quick overview of input file. You can get this script <a href="https://gist.github.com/7h3rAm/225e36ad59729000e00e7814e9644622">here</a>.</p>
  </div>

  <nav class="post-nav" style="margin-top:1em;">
    <a class="nav-prev" href="/posts/20150527_ebctf-bin100.html"><span class="arrow">&lt;&lt;&lt;</span> <span class="nav-title">Eindbazen CTF Challenge: bin100</span></a>    <a class="nav-next" href="/posts/20151122_cigma.html"><span class="nav-title">cigma: A Pure Python Filetype Identification Library</span> <span class="arrow">&gt;&gt;&gt;</span></a>  </nav>
</article>

<script>
document.addEventListener('DOMContentLoaded', function() {
  var content = document.querySelector('.content');
  if (content) {
    var headings = content.querySelectorAll('h2,h3,h4,h5,h6');
    headings.forEach(function(h) {
      var link = document.createElement('a');
      link.href = '#top';
      link.className = 'top-link';
      link.textContent = ' [^]';
      link.style.fontSize = '0.8em';
      link.style.color = 'var(--muted)';
      h.appendChild(link);
    });
  }
});
</script>

<footer>
  <p class="nested active">cc-by-sa-4.0</p>
</footer>

<aside class="sidebar">
  <div class="sidebar-content">
    <h4 class="h4 collapsible" onclick="toggle(this);">navigation</h4>
    <a href="/">home</a>
    <a href="/archive.html">archive</a>
    <a href="/tags.html">tags</a>
    <a href="/stats.html">stats</a>
    <hr>
    <h4 class="h4 collapsible" onclick="toggle(this);">external</h4>
    <a href="https://github.com/@7h3rAm">github</a>
    <a href="https://twitter.com/@7h3rAm">twitter</a>
    <hr>
    <h4 class="h4 collapsible" onclick="toggle(this);">toggles</h4>
    <div class="toggle-group">
      <button class="toggle-btn toggle-theme" onclick="toggleThemeMode()" data-icon-on="&#xf186;" data-icon-off="&#xf185;"></button>
      <button class="toggle-btn toggle-density" onclick="toggleDensity()" data-icon-on="&#xf422;" data-icon-off="&#xf424;"></button>
      <button class="toggle-btn toggle-width" onclick="toggleWidth()" data-icon-on="&#xf337;" data-icon-off="&#xf338;"></button>
      <button class="toggle-btn toggle-justify" onclick="toggleJustify()" data-icon-on="&#xf039;" data-icon-off="&#xf036;"></button>
      <button class="toggle-btn toggle-collapse" onclick="toggleAllSections()" data-icon-on="&#xf0c9;" data-icon-off="&#xf0c9;"></button>
    </div>
  </div>
</aside>

<script>hljs.configure({ignoreUnescapedHTML: true}); hljs.highlightAll(); hljs.initLineNumbersOnLoad();</script>
</body>
</html>