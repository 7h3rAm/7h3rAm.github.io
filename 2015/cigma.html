<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta name="author" content="7h3rAm"/>
    <meta name="description" content="Personal Weblog"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <title>Grey Matter</title>

    <link href="/static/css/default.css" rel="stylesheet" type="text/css">
    <link href="/static/css/codehilite/perldoc.css" rel="stylesheet" type="text/css">

    <link href="/static/images/favicon-32x32.png" sizes="32x32" rel="icon" type="image/png"/>
  </head>
  <body>
    <section id="content" class="body">
              <div class="header">
          <table>
            <tr>
              <td class="blogtitle"><a href="/" style="color: rgb(102, 102, 102);">Grey Matter</a></td>
              <td class="blognavbar">
                [<a id="archive" href="/archive.html" style="color: rgb(70, 130, 180);">Archive</a>] [<a id="tags" href="/tags.html" style="color: rgb(255, 183, 69);">Tags</a>] [<a id="projects" href="/projects.html" style="color: rgb(0, 128, 128);">Projects</a>] [<a id="research" href="/research.html" style="color: rgb(242, 119, 122);">Research</a>]
              </td>
            </tr>
          </table>
        </div>
                  <article class="post">
  <div class="row">
    <div class="col-lg-12">
      <div class="panel panel-default section compact">
        <div class="body">
          <p class="heading">cigma: A Pure Python Filetype Identification Library</p>
                                                                                                                                                                                                                        <p class="date">
                  <a href="/2015/capinfos.html">&lt&lt;</a> published on 22/Nov/2015<a href="/2016/flareon2014-15.html"> &gt;&gt;</i></a><br/>
                </p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <div class="post-content">
          <p><a href="https://github.com/7h3rAm/cigma">cigma</a> is a Python library to identify filetypes. It provides <a href="https://github.com/threatstack/libmagic">libmagic</a> like mimetype identification of a file or data buffer. This is similar to what the <code>file</code> command on *nix systems will provide:</p>

<pre><code>$ file cigma.py
cigma.py: Python script, ASCII text executable
$
$ file readme.md
readme.md: Python script, ASCII text executable, with very long lines
$
$ file /bin/ls
/bin/ls: ELF 64-bit LSB  executable, x86-64, version 1 (SYSV), dynamically linked (uses shared libs), for GNU/Linux 2.6.24, BuildID[sha1]=9d2a434c4ff55aad2ddd19348c0ac75971606483, stripped
$
$ file /etc/passwd
/etc/passwd: ASCII text
$
$ file /dev/sda
/dev/sda: block special
</code></pre>

<p><code>cigma</code> uses a custom JSON formatted signature file to stores filetype mappings. Let&#8217;s try identifying a few files:</p>

<pre><code>$ python cigma.py /bin/ls
('/bin/ls',
 {'id': 29,
  'longname': 'Executable and Linkable Format (ELF)',
  'mimetype': 'application/x-executable',
  'patterns': [{'offset': 0, 'regex': '\\x7F\\x45\\x4C\\x46', 'size': 4}],
  'shortname': 'ELF'})
$
$ python cigma.py ~/toolbox/testfiles/binary/suspicious/35d249cdd501aeb5a5b39daeb4f275c41c73e91ef299a094d27edbfd0396715d.VXE
('/home/shiv/toolbox/testfiles/binary/suspicious/35d249cdd501aeb5a5b39daeb4f275c41c73e91ef299a094d27edbfd0396715d.VXE',
 {'id': 31,
  'longname': 'Windows Executable',
  'mimetype': 'application/x-dosexec',
  'patterns': [{'offset': 0, 'regex': '\\x4D\\x5A', 'size': 2}],
  'shortname': 'EXE'})
$
$ python cigma.py ~/toolbox/testfiles/pcaps/exploitkits/2015-04-03-Nuclear-EK-traffic.pcap
('/home/shiv/toolbox/testfiles/pcaps/exploitkits/2015-04-03-Nuclear-EK-traffic.pcap',
 {'id': 5,
  'longname': 'Packet Capture (winpcap)',
  'mimetype': 'application/vnd.tcpdump.pcap',
  'patterns': [{'offset': 0, 'regex': '\\xD4\\xC3\\xB2\\xA1', 'size': 4}],
  'shortname': 'PCAP'})
</code></pre>

<p>If a match is found, <code>cigma</code> returns a <code>(source, resultdict)</code> tuple. Here is a snippet of few signatures from the current set:</p>

<pre><code>{
  "meta": {
    "rulescount": 72,
    "version": 0.1
  },
  "rules": [
    {
      "id": 1,
      "longname": "PKZIP",
      "mimetype": "application/octet-stream",
      "patterns": [
        {
          "offset": 0,
          "regex": "\\x50\\x4B\\x05\\x06",
          "size": 4
        }
      ],
      "shortname": "ZIP"
    },
    {
      "id": 5,
      "longname": "Packet Capture (winpcap)",
      "mimetype": "application/vnd.tcpdump.pcap",
      "patterns": [
        {
          "offset": 0,
          "regex": "\\xD4\\xC3\\xB2\\xA1",
          "size": 4
        }
      ],
      "shortname": "PCAP"
    },
    {
      "id": 27,
      "longname": "Flash Video",
      "mimetype": "video/x-flv",
      "patterns": [
        {
          "offset": 0,
          "regex": "\\x46\\x4C\\x56",
          "size": 3
        }
      ],
      "shortname": "FLV"
    },
    {
      "id": 29,
      "longname": "Executable and Linkable Format (ELF)",
      "mimetype": "application/x-executable",
      "patterns": [
        {
          "offset": 0,
          "regex": "\\x7F\\x45\\x4C\\x46",
          "size": 4
        }
      ],
      "shortname": "ELF"
    }
  ]
}
</code></pre>

<p>Adding a new signature is really easy. Just edit the included <code>magicbytes.json</code> file and add a new node with an unique <code>id</code>. Each node should have a <code>patterns</code> list which should contain the <code>offset</code>, <code>regex</code> and <code>size</code> keys with respective values.</p>

<p>Using <code>cigma</code> as a library is really easy:</p>

<pre><code>from cigma import Cigma
</code></pre>

<p>One this is done, you can identify a file buffer:</p>

<pre><code>with open("/home/shiv/toolbox/testfiles/binary/crafted_corkami/gui.exe") as fo:
  filedata = fo.read()

Cigma(data=filedata).cigma()
('databuffer',
 {'longname': 'Windows Executable',
  'mimetype': 'application/x-dosexec',
  'patterns': [{'offset': 0, 'regex': '\\x4D\\x5A', 'size': 2}],
  'shortname': 'EXE'})
</code></pre>

<p>Or else you can also identify a file itself:</p>

<pre><code>Cigma(filename="/home/shiv/toolbox/testfiles/binary/crafted_corkami/gui.exe").cigma()
('/home/shiv/toolbox/testfiles/binary/crafted_corkami/gui.exe',
 {'longname': 'Windows Executable',
  'mimetype': 'application/x-dosexec',
  'patterns': [{'offset': 0, 'regex': '\\x4D\\x5A', 'size': 2}],
  'shortname': 'EXE'})
</code></pre>

<p>The primary purpose of <code>cigma</code> is to be able to identify mundane files at lightning speeds. It doesn&#8217;t aim to provide exhaustive insight into each file by parsing and decoding it. Currently, there are 70+ signatures and identification for more filetypes will be available as the project grows.</p>

        </div>
        <div class="meta">
          <hr/>
          <p>For comments, questions and suggestions use <a href="https://twitter.com/7h3rAm" target="_blank">twitter</a> or create an <a href="https://github.com/7h3rAm/7h3rAm.github.io/issues/new" target="_blank">issue</a> on blog repository.</p>
          <hr/>
                                                                                                                                                                                                        <table>
                <tr>
                  <td align="left">(share via <a href="mailto:?subject=cigma: A Pure Python Filetype Identification Library&body=http://7h3ram.github.io//2015/cigma.html" target="_blank" title="Share via Email">mail</a>, <a href="http://twitter.com/intent/tweet?text=cigma: A Pure Python Filetype Identification Library+http://7h3ram.github.io//2015/cigma.html&via=7h3rAm" target="_blank" title="Share on Twitter">twitter</a>, <a href="http://www.facebook.com/sharer/sharer.php?s=100&p[url]=http://7h3ram.github.io//2015/cigma.html&p[images][0]=&p[title]=cigma: A Pure Python Filetype Identification Library&p[summary]=Cigma is a minimal, pure Python filetype identification library I created as an alternative to various Python ports of libmagic that are floating around." target="_blank" title="Share on Facebook">facebook</a> or <a href="https://plus.google.com/share?url=http://7h3ram.github.io//2015/cigma.html" target="_blank" title="Share on Google Plus">google-plus</a>)</td>
                  <td align="right">(tagged <a href=/tags.html#code>code</a>)</td>
                </tr>
                <tr>
                                      <td align="left"><a href="/2015/capinfos.html">&lt;&lt; capinfos.py: Pure Python Pcap Statistics Tool &lt;&lt;</a></td>
                    <td align="right"><a href="/2016/flareon2014-15.html">&gt;&gt; FireEye FLARE On 2014 Challenges (1-5) &gt;&gt;</a></td>
                                  </tr>
              </table>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </div>
        </div>
      </div>
    </div>
  </div>
  </article>
              <div class="footer">
          <center>
            <a href="/rss.xml" target="_blank">rss</a> | <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" rel="license" target="_blank">license</a>
          </center>
        </div>
          </section>

    <script type="text/javascript">
      document.addEventListener("DOMContentLoaded", function() {
        var colors = ["#4B0082", "#3CB371", "#2E8B57", "#808000", "#20B2AA", "#008B8B", "#4682B4", "#B0C4DE", "#87CEFA", "#87CEEB", "#1E90FF", "#6495ED", "#000080", "#191970"];
        document.getElementById("element").style.color = colors[Math.floor(Math.random() * colors.length)];
      }, false);
    </script>

  </body>
</html>