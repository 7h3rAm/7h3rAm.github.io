<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta name="author" content="7h3rAm"/>
    <meta name="description" content="Personal Weblog"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <title>Grey Matter</title>

    <link href="/static/css/default.css" rel="stylesheet" type="text/css">
    <link href="/static/css/codehilite/perldoc.css" rel="stylesheet" type="text/css">

    <link href="/static/images/favicon-32x32.png" sizes="32x32" rel="icon" type="image/png"/>
  </head>
  <body>
    <section id="content" class="body">
              <div class="header">
          <table>
            <tr>
              <td class="blogtitle"><a href="/" style="color: rgb(102, 102, 102);">Grey Matter</a></td>
              <td class="blognavbar">
                [<a id="archive" href="/archive.html" style="color: rgb(70, 130, 180);">Archive</a>] [<a id="tags" href="/tags.html" style="color: rgb(255, 183, 69);">Tags</a>] [<a id="projects" href="/projects.html" style="color: rgb(0, 128, 128);">Projects</a>] [<a id="research" href="/research.html" style="color: rgb(242, 119, 122);">Research</a>]
              </td>
            </tr>
          </table>
        </div>
                  <article class="post">
  <div class="row">
    <div class="col-lg-12">
      <div class="panel panel-default section compact">
        <div class="body">
          <p class="heading">pcapedit: An Interactive Scapy-based Pcap Editor</p>
                                                                                                                                                                                                                                                                                                                                      <p class="date">
                  <a href="/2014/little-pdf.html">&lt&lt;</a> published on 15/Nov/2014<a href="/2014/flowinspect.html"> &gt;&gt;</i></a><br/>
                </p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <div class="post-content">
          <p><code>pcapedit</code> is a Python-based tool that allows users to enter commands to edit and save pcaps. It has a hard dependency on <code>Scapy</code> and <code>cmd2</code> modules so make sure these are installed. Here is a snippet from test run:</p>

<pre><code>$ ./pcapedit.py
PcapEdit - An Interactive Pcap Editor

&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; help

Documented commands (type help &lt;topic&gt;):
========================================
_load           commands  history  ls       r         shell
_relative_load  ed        l        outpcap  run       shortcuts
analyze         edit      li       pause    save      show
back            hexdump   list     pdfdump  Scapycmd  summary
cmdenvironment  hi        load     py       set       wireshark

Undocumented commands:
======================
EOF  eof  exit  help  q  quit

&gt;&gt;&gt; commands

  [01] analyze ......... load a pcap for analysis
  [02] ls .............. list packet details
  [03] summary ......... show summary of a packet
  [04] hexdump ......... show hexdump of a packet
  [05] pdfdump ......... dump packet to a PDF
  [06] Scapycmd ........ show Scapy command to generate a packet
  [07] wireshark ....... show a packet in Wireshark
  [08] edit ............ select a packet for set operations
  [09] outpcap ......... set name for output pcap
  [10] set ............. change value of a protocol field
  [11] save ............ save packets to a pcap

&gt;&gt;&gt; q
</code></pre>

<p>So we have a few commands to try out. Let&#8217;s assume that you have a <code>http.pcap</code> file that needs editing. Let&#8217;s see how pcapedit can be useful in this case:</p>

<pre><code>$ ./pcapedit.py
PcapEdit - An Interactive Pcap Editor

&gt;&gt;&gt; analyze http.cap
Read 43 packets from http.cap
(http.cap) &gt;&gt;&gt; summary
     0: 2004/05/13 15:47:07    145.254.160.237:3372 -&gt; 65.208.228.223:80       TCP S
     1: 2004/05/13 15:47:08       65.208.228.223:80 -&gt; 145.254.160.237:3372    TCP SA
     2: 2004/05/13 15:47:08    145.254.160.237:3372 -&gt; 65.208.228.223:80       TCP A
     3: 2004/05/13 15:47:08    145.254.160.237:3372 -&gt; 65.208.228.223:80       TCP PA (479 bytes)
     4: 2004/05/13 15:47:08       65.208.228.223:80 -&gt; 145.254.160.237:3372    TCP A
     5: 2004/05/13 15:47:08       65.208.228.223:80 -&gt; 145.254.160.237:3372    TCP A (1380 bytes)
     6: 2004/05/13 15:47:09    145.254.160.237:3372 -&gt; 65.208.228.223:80       TCP A
     7: 2004/05/13 15:47:09       65.208.228.223:80 -&gt; 145.254.160.237:3372    TCP A (1380 bytes)
     8: 2004/05/13 15:47:09    145.254.160.237:3372 -&gt; 65.208.228.223:80       TCP A
     9: 2004/05/13 15:47:09       65.208.228.223:80 -&gt; 145.254.160.237:3372    TCP A (1380 bytes)
    10: 2004/05/13 15:47:09       65.208.228.223:80 -&gt; 145.254.160.237:3372    TCP PA (1380 bytes)
    11: 2004/05/13 15:47:09    145.254.160.237:3372 -&gt; 65.208.228.223:80       TCP A
    12: 2004/05/13 15:47:09    145.254.160.237:3009 -&gt; 145.253.2.203:53        UDP (47 bytes)
    13: 2004/05/13 15:47:09       65.208.228.223:80 -&gt; 145.254.160.237:3372    TCP A (1380 bytes)
    14: 2004/05/13 15:47:10    145.254.160.237:3372 -&gt; 65.208.228.223:80       TCP A
    15: 2004/05/13 15:47:10       65.208.228.223:80 -&gt; 145.254.160.237:3372    TCP A (1380 bytes)
    16: 2004/05/13 15:47:10        145.253.2.203:53 -&gt; 145.254.160.237:3009    UDP (244 bytes)
    17: 2004/05/13 15:47:10    145.254.160.237:3371 -&gt; 216.239.59.99:80        TCP PA (721 bytes)
    18: 2004/05/13 15:47:10    145.254.160.237:3372 -&gt; 65.208.228.223:80       TCP A
    19: 2004/05/13 15:47:10       65.208.228.223:80 -&gt; 145.254.160.237:3372    TCP A (1380 bytes)
    20: 2004/05/13 15:47:10       65.208.228.223:80 -&gt; 145.254.160.237:3372    TCP PA (1380 bytes)
    21: 2004/05/13 15:47:10    145.254.160.237:3372 -&gt; 65.208.228.223:80       TCP A
    22: 2004/05/13 15:47:10       65.208.228.223:80 -&gt; 145.254.160.237:3372    TCP A (1380 bytes)
    23: 2004/05/13 15:47:10        216.239.59.99:80 -&gt; 145.254.160.237:3371    TCP A
    24: 2004/05/13 15:47:11    145.254.160.237:3372 -&gt; 65.208.228.223:80       TCP A
    25: 2004/05/13 15:47:11        216.239.59.99:80 -&gt; 145.254.160.237:3371    TCP PA (1430 bytes)
    26: 2004/05/13 15:47:11        216.239.59.99:80 -&gt; 145.254.160.237:3371    TCP PA (160 bytes)
    27: 2004/05/13 15:47:11    145.254.160.237:3371 -&gt; 216.239.59.99:80        TCP A
    28: 2004/05/13 15:47:11       65.208.228.223:80 -&gt; 145.254.160.237:3372    TCP PA (1380 bytes)
    29: 2004/05/13 15:47:11    145.254.160.237:3372 -&gt; 65.208.228.223:80       TCP A
    30: 2004/05/13 15:47:11       65.208.228.223:80 -&gt; 145.254.160.237:3372    TCP A (1380 bytes)
    31: 2004/05/13 15:47:11       65.208.228.223:80 -&gt; 145.254.160.237:3372    TCP A (1380 bytes)
    32: 2004/05/13 15:47:11    145.254.160.237:3372 -&gt; 65.208.228.223:80       TCP A
    33: 2004/05/13 15:47:11       65.208.228.223:80 -&gt; 145.254.160.237:3372    TCP A (1380 bytes)
    34: 2004/05/13 15:47:11    145.254.160.237:3372 -&gt; 65.208.228.223:80       TCP A
    35: 2004/05/13 15:47:12        216.239.59.99:80 -&gt; 145.254.160.237:3371    TCP PA (1430 bytes)
    36: 2004/05/13 15:47:12    145.254.160.237:3371 -&gt; 216.239.59.99:80        TCP A
    37: 2004/05/13 15:47:12       65.208.228.223:80 -&gt; 145.254.160.237:3372    TCP PA (424 bytes)
    38: 2004/05/13 15:47:12    145.254.160.237:3372 -&gt; 65.208.228.223:80       TCP A
    39: 2004/05/13 15:47:25       65.208.228.223:80 -&gt; 145.254.160.237:3372    TCP FA
    40: 2004/05/13 15:47:25    145.254.160.237:3372 -&gt; 65.208.228.223:80       TCP A
    41: 2004/05/13 15:47:37    145.254.160.237:3372 -&gt; 65.208.228.223:80       TCP FA
    42: 2004/05/13 15:47:37       65.208.228.223:80 -&gt; 145.254.160.237:3372    TCP A
(http.cap) &gt;&gt;&gt;
(http.cap) &gt;&gt;&gt; summary 6
     6: 2004/05/13 15:47:09    145.254.160.237:3372 -&gt; 65.208.228.223:80       TCP A
(http.cap) &gt;&gt;&gt;
</code></pre>

<p>The <code>summary</code> command displays a listing of all packets and their most common attributes. When provided an integer argument, it considers that to be the packet index and shows a one-line description for the packet itself. Let&#8217;s now assume you need to edit packet #6:</p>

<pre><code>(http.cap) &gt;&gt;&gt; edit 6
Editing packet id: 6
     6: 2004/05/13 15:47:09    145.254.160.237:3372 -&gt; 65.208.228.223:80       TCP A
(http.cap|#6) &gt;&gt;&gt;
(http.cap|#6) &gt;&gt;&gt; set ether.src 11:22:33:44:55
     6: Ether.src: 00:00:01:00:00:00 -&gt; 11:22:33:44:55
(http.cap|#6) &gt;&gt;&gt;
(http.cap|#6) &gt;&gt;&gt; set ether.dst 55:44:33:22:11
     6: Ether.dst: fe:ff:20:00:01:00 -&gt; 55:44:33:22:11
(http.cap|#6) &gt;&gt;&gt;
(http.cap|#6) &gt;&gt;&gt; set ether.type 2048
     6: Ether.type: 2048 -&gt; 2048
(http.cap|#6) &gt;&gt;&gt;
(http.cap|#6) &gt;&gt;&gt; set tcp.sport 1234
     6: TCP.sport: 3372 -&gt; 1234
(http.cap|#6) &gt;&gt;&gt;
(http.cap|#6) &gt;&gt;&gt; set tcp.dport 4321
     6: TCP.dport: 80 -&gt; 4321
(http.cap|#6) &gt;&gt;&gt;
(http.cap|#6) &gt;&gt;&gt; ls
dst        : DestMACField         = '55:44:33:22:11' (None)
src        : SourceMACField       = '11:22:33:44:55' (None)
type       : XShortEnumField      = 2048            (0)
--
version    : BitField             = 4L              (4)
ihl        : BitField             = 5L              (None)
tos        : XByteField           = 0               (0)
len        : ShortField           = 40              (None)
id         : ShortField           = 3910            (1)
flags      : FlagsField           = 2L              (0)
frag       : BitField             = 0L              (0)
ttl        : ByteField            = 128             (64)
proto      : ByteEnumField        = 6               (0)
chksum     : XShortField          = None            (None)
src        : Emph                 = '145.254.160.237' (None)
dst        : Emph                 = '65.208.228.223' ('127.0.0.1')
options    : PacketListField      = []              ([])
--
sport      : ShortEnumField       = 3372            (20)
dport      : ShortEnumField       = 4321            (80)
seq        : IntField             = 951058419       (0)
ack        : IntField             = 290219760       (0)
dataofs    : BitField             = 5L              (None)
reserved   : BitField             = 0L              (0)
flags      : FlagsField           = 16L             (2)
window     : ShortField           = 9660            (8192)
chksum     : XShortField          = None            (None)
urgptr     : ShortField           = 0               (0)
options    : TCPOptionsField      = {}              ({})
None
(http.cap|#6) &gt;&gt;&gt;
</code></pre>

<p>So we selected the packet id, provided the respective protocol field names, new values and used the <code>ls</code> command to glance over changes. Since all looks good, we can now request <code>pcapedit</code> to save these changes, which it will then write to a <code>filename.mod.pcap</code> named file (you can override the default name and provide new name via the <code>outpcap</code> command):</p>

<pre><code>(http.cap|#6) &gt;&gt;&gt; save
Wrote 1 packet(s) to http.mod.cap
(http.cap|#6) &gt;&gt;&gt;
(http.cap|#6) &gt;&gt;&gt; q
$
$ ls -l *.cap
-rwxrwxr-x 1 shiv shiv 25803 Nov 15 12:22 http.cap
-rw-rw-r-- 1 shiv shiv    94 Nov 15 14:31 http.mod.cap
</code></pre>

<p>One thing to note here is that the <code>save</code> command only write one packet (#6) to the file and skip the rest. This is because <code>pcapedit</code> is a context-sensitive tool, ie. <strong>it takes current context into consideration while executing commands</strong>. Since at the time of issuing <code>save</code> command, the user was in per-packet editing mode (for packet #6), it intentionally skipped other packets. This is an immensely powerful feature as packets can now be edited individually and extracted from source pcap file to a new pcap file. However, if one wishes to save all packets, all they have to do is issue the <code>back</code> command to exit per-packet editing mode and then issue <code>save</code> command which will now honor the context and work as expected:</p>

<pre><code>(http.cap|#6) &gt;&gt;&gt; back
(http.cap) &gt;&gt;&gt;
(http.cap) &gt;&gt;&gt; save
Wrote 43 packet(s) to http.mod.cap
(http.cap) &gt;&gt;&gt; q
$
$ ls -l *.cap
-rw-rw-r-- 1 shiv shiv 25803 Nov 15 12:22 http.cap
-rw-rw-r-- 1 shiv shiv 25901 Nov 15 14:09 http.mod.cap
</code></pre>

<p>Here&#8217;s a screenshot of Wireshark parsing and decoding the edited packet:</p>

<p><img src="/static/files/pcapedit-wireshark.png" alt="pcapedit-wireshark.png" /></p>

<p>So at this point we know how to edit individual packets and save them to a new file, but doing this for hundreds or thousands of packets would still remain a daunting task and something that needs automation. That&#8217;s where the <em>scriptfile</em> feature comes handy. You can save commands to a file and pass them as input to <code>pcapedit</code> and it will happily do as instructed:</p>

<pre><code>$ ./pcapedit.py &lt;tcpcmdstest.txt
PcapEdit - An Interactive Pcap Editor

&gt;&gt;&gt; Read 43 packets from http.cap
(http.cap) &gt;&gt;&gt;
(http.cap) &gt;&gt;&gt; Editing packet id: 6
     6: 2004/05/13 15:47:09    145.254.160.237:3372 -&gt; 65.208.228.223:80       TCP A
(http.cap|#6) &gt;&gt;&gt;
(http.cap|#6) &gt;&gt;&gt;      6: Ether.src: 00:00:01:00:00:00 -&gt; 11:22:33:44:55
(http.cap|#6) &gt;&gt;&gt;      6: Ether.dst: fe:ff:20:00:01:00 -&gt; 55:44:33:22:11
(http.cap|#6) &gt;&gt;&gt;      6: Ether.type: 2048 -&gt; 2048
(http.cap|#6) &gt;&gt;&gt;
(http.cap|#6) &gt;&gt;&gt;      6: IP.version: 4 -&gt; 88
(http.cap|#6) &gt;&gt;&gt;      6: IP.ihl: 5 -&gt; 56
(http.cap|#6) &gt;&gt;&gt;      6: IP.tos: 0 -&gt; 33
(http.cap|#6) &gt;&gt;&gt;      6: IP.len: 40 -&gt; 36
(http.cap|#6) &gt;&gt;&gt;      6: IP.id: 3910 -&gt; 12
(http.cap|#6) &gt;&gt;&gt;      6: IP.flags: 2 -&gt; 81
(http.cap|#6) &gt;&gt;&gt;      6: IP.frag: 0 -&gt; 22
(http.cap|#6) &gt;&gt;&gt;      6: IP.ttl: 128 -&gt; 27
(http.cap|#6) &gt;&gt;&gt;      6: IP.proto: 6 -&gt; 15
(http.cap|#6) &gt;&gt;&gt;      6: IP.chksum: None -&gt; 78
(http.cap|#6) &gt;&gt;&gt;      6: IP.src: 145.254.160.237 -&gt; 12
(http.cap|#6) &gt;&gt;&gt;      6: IP.dst: 65.208.228.223 -&gt; 21
(http.cap|#6) &gt;&gt;&gt;      6: IP.options: [] -&gt; ['99']
(http.cap|#6) &gt;&gt;&gt;
(http.cap|#6) &gt;&gt;&gt;      6: TCP.sport: 3372 -&gt; 1234
(http.cap|#6) &gt;&gt;&gt;      6: TCP.dport: 80 -&gt; 4321
(http.cap|#6) &gt;&gt;&gt;      6: TCP.seq: 951058419 -&gt; 11
(http.cap|#6) &gt;&gt;&gt;      6: TCP.ack: 290219760 -&gt; 12
(http.cap|#6) &gt;&gt;&gt;      6: TCP.dataofs: 5 -&gt; 1
(http.cap|#6) &gt;&gt;&gt;      6: TCP.reserved: 0 -&gt; 9
(http.cap|#6) &gt;&gt;&gt;      6: TCP.flags: 16 -&gt; 90
(http.cap|#6) &gt;&gt;&gt;      6: TCP.window: 9660 -&gt; 36
(http.cap|#6) &gt;&gt;&gt;      6: TCP.chksum: None -&gt; 88
(http.cap|#6) &gt;&gt;&gt;      6: TCP.urgptr: 0 -&gt; 67
(http.cap|#6) &gt;&gt;&gt;      6: TCP.options: {} -&gt; {}
(http.cap|#6) &gt;&gt;&gt;
(http.cap|#6) &gt;&gt;&gt;      6: 2004/05/13 15:47:09                 12:1234 -&gt; 21:4321                 TCP SPAE
(http.cap|#6) &gt;&gt;&gt;
(http.cap|#6) &gt;&gt;&gt; Wrote 11 packet(s) to http.mod.cap
(http.cap|#6) &gt;&gt;&gt;
(http.cap|#6) &gt;&gt;&gt; q
$
$ ls -l *.cap
-rwxrwxr-x 1 shiv shiv 25803 Nov 15 12:22 http.cap
-rw-rw-r-- 1 shiv shiv  6805 Nov 15 14:44 http.mod.cap
$
</code></pre>

<p>There are a few other nifty commands that will be useful and I strongly recommend you to give <code>pcapedit</code> a try.</p>

        </div>
        <div class="meta">
          <hr/>
          <p>For comments, questions and suggestions use <a href="https://twitter.com/7h3rAm" target="_blank">twitter</a> or create an <a href="https://github.com/7h3rAm/7h3rAm.github.io/issues/new" target="_blank">issue</a> on blog repository.</p>
          <hr/>
                                                                                                                                                                                                                                                                                                                      <table>
                <tr>
                  <td align="left">(share via <a href="mailto:?subject=pcapedit: An Interactive Scapy-based Pcap Editor&body=http://7h3ram.github.io//2014/pcapedit.html" target="_blank" title="Share via Email">mail</a>, <a href="http://twitter.com/intent/tweet?text=pcapedit: An Interactive Scapy-based Pcap Editor+http://7h3ram.github.io//2014/pcapedit.html&via=7h3rAm" target="_blank" title="Share on Twitter">twitter</a>, <a href="http://www.facebook.com/sharer/sharer.php?s=100&p[url]=http://7h3ram.github.io//2014/pcapedit.html&p[images][0]=&p[title]=pcapedit: An Interactive Scapy-based Pcap Editor&p[summary]=pcapedit is an interactive pcap editor. It provides quick shorthand over Scapy commands and aims to be useful for mundane pcap editing tasks. The interactive mode allows saving of command history to a script which can then be used to edit multiple files together." target="_blank" title="Share on Facebook">facebook</a> or <a href="https://plus.google.com/share?url=http://7h3ram.github.io//2014/pcapedit.html" target="_blank" title="Share on Google Plus">google-plus</a>)</td>
                  <td align="right">(tagged <a href=/tags.html#code>code</a>)</td>
                </tr>
                <tr>
                                      <td align="left"><a href="/2014/little-pdf.html">&lt;&lt; Little PDF Puzzle from Didier Stevens &lt;&lt;</a></td>
                    <td align="right"><a href="/2014/flowinspect.html">&gt;&gt; Flowinspect: A Network Inspection Tool &gt;&gt;</a></td>
                                  </tr>
              </table>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </div>
        </div>
      </div>
    </div>
  </div>
  </article>
              <div class="footer">
          <center>
            <a href="/rss.xml" target="_blank">rss</a> | <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" rel="license" target="_blank">license</a>
          </center>
        </div>
          </section>

    <script type="text/javascript">
      document.addEventListener("DOMContentLoaded", function() {
        var colors = ["#4B0082", "#3CB371", "#2E8B57", "#808000", "#20B2AA", "#008B8B", "#4682B4", "#B0C4DE", "#87CEFA", "#87CEEB", "#1E90FF", "#6495ED", "#000080", "#191970"];
        document.getElementById("element").style.color = colors[Math.floor(Math.random() * colors.length)];
      }, false);
    </script>

  </body>
</html>