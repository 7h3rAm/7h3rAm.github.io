<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta name="author" content="7h3rAm"/>
    <meta name="description" content="Personal Weblog"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <title>Grey Matter</title>

    <link href="/static/css/default.css" rel="stylesheet" type="text/css">
    <link href="/static/css/codehilite/perldoc.css" rel="stylesheet" type="text/css">

    <link href="/static/images/favicon-32x32.png" sizes="32x32" rel="icon" type="image/png"/>
  </head>
  <body>
    <section id="content" class="body">
              <div class="header">
          <table>
            <tr>
              <td class="blogtitle"><a href="/" style="color: rgb(102, 102, 102);">Grey Matter</a></td>
              <td class="blognavbar">
                <a href="/archive.html">[Archive]</a> <a href="/tags.html">[Tags]</a> <a href="/research.html">[Research]</a></a>
              </td>
            </tr>
          </table>
        </div>
                  <article class="post">
  <div class="row">
    <div class="col-lg-12">
      <div class="panel panel-default section compact">
        <div class="body">
          <p class="heading">reverse Challenge from Coursera's Malicious Software Course</p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <p class="date">
                  <a href="/2013/malsoftware-reverse-ex.html">&lt&lt;</a> published on 29/Aug/2013<a href="/2013/libnids-python-ids.html"> &gt;&gt;</i></a><br/>
                </p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <div class="post-content">
          <p>This post follows an earlier one: <a href="/2013/malsoftware-reverse-ex.html">reverse-ex Challenge from Coursera&#8217;s
Malicious Software Course</a>. If
you&#8217;ve not already read it, I would suggest you do so since both these
challenges share a few common concepts and I&#8217;ll be skipping detail if it
has been mentioned before.</p>

<p>The challenge file is hosted here:
<a href="/static/files/reverse-challenge">reverse-challenge</a>. The first thing to do is
to test it with <code>file</code> command:</p>

<div class="codehilite"><pre><span></span><code>$ file reverse-challenge
reverse-challenge: ELF <span class="m">32</span>-bit LSB executable, Intel <span class="m">80386</span>, version <span class="m">1</span> <span class="o">(</span>SYSV<span class="o">)</span>, dynamically linked <span class="o">(</span>uses shared libs<span class="o">)</span>, <span class="k">for</span> GNU/Linux <span class="m">2</span>.6.24, BuildID<span class="o">[</span>  sha1<span class="o">]=</span>0x2fe5f1647532449ffeef36a7fa31ae8319c8818d, stripped
$
$ file -i reverse-challenge
reverse-challenge: application/x-executable<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>binary
</code></pre></div>

<p>Like the previous challenge this is also a 32bit
<a href="http://en.wikipedia.org/wiki/Executable_and_Linkable_Format">ELF</a>
binary, <a href="http://stackoverflow.com/questions/1993390/static-linking-vs-dynamic-linking">dynamically
linked</a>,
but a significant difference is that it has <a href="http://unix.stackexchange.com/questions/2969/what-are-stripped-and-not-stripped-executables-in-unix">symbols
stripped</a>.
This means that debugging and symbol resolution information has <em>NOT</em>
been preserved within the binary. This loss of debugging information
would be evident when we move on to static analysis part later but first
let&#8217;s see what <code>strings</code> has to tell us about this file:</p>

<p>If you&#8217;ve read the previous post this output would certainly delight you
due to the discernible similarity between the two challenge files.
Similar looking status strings and a static flag indicate that this
program, like its predecessor, also uses some mutation mechanism (mostly
XOR, but we will validate it soon) and a static key which we can use to
reverse the algorithm. This time, let&#8217;s use IDA to disassemble and
analyze this program:</p>

<p><img src="/static/files/ida-start.png" alt="image" /></p>

<p>Since the program includes anti-reversing techniques, I tried to avoid
traversing the code manually and quickly searched for the section
referencing the flag we found in <code>strings</code> output: <code>xKZl_^_XCY^CIE</code>. It
was found that this flag was being referenced at location 0x08048694.
Before that, there was the code responsible for performing the mutation,
which in this case was also XOR. However, instead of using a static
value as a key, it was being computed at runtime. The
<code>mov dword ptr [ebp-10h], 0FAh</code> and <code>and edx, 2Bh</code> instructions at
locations 0x08048664 and 0x08048677 respectively initialized <code>edx</code> with
a value of 0x2a which is then used in a XOR operation at location
0x0804867A.</p>

<p><img src="/static/files/ida-checkkey.png" alt="image" /></p>

<p>Thus the per-byte XOR key for this program turns out to be 0x2a. Let&#8217;s
invoke the python script we used in previous post with <code>xKZl_^_XCY^CIE</code>
as the flag and 0x2a as the key and reverse the simple XOR mutation
logic:</p>

<div class="codehilite"><pre><span></span><code>$ ./xor.py xKZl_^_XCY^CIE 0x2a
xKZl_^_XCY^CIE ^ <span class="nv">0x2a</span> <span class="o">=</span>&gt; RapFuturistico
$
$ ./reverse-challenge
Are you feeling lucky today? BRapFuturistico
<span class="o">[</span>+<span class="o">]</span> WooT!: xKZl_^_XCY^CIE
</code></pre></div>

<p>As expected, <code>RapFuturistico</code> indeed is the right input string derived
from reversing the XOR-based mutation logic used in the program. Like
earlier, we could have also tried debugging this program but the
<code>Dude, no debugging ;-)</code> string from the <code>strings</code> output indicates
presence of anti-debugging measures and I refrained using it in this
challenge. It can be confirmed with a simple <code>strace</code> of the program:</p>

<div class="codehilite"><pre><span></span><code><span class="err">$</span> <span class="n">strace</span> <span class="p">.</span><span class="o">/</span><span class="n">reverse</span><span class="o">-</span><span class="n">challenge</span>
<span class="n">execve</span><span class="p">(</span><span class="s">&quot;./reverse-challenge&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;./reverse-challenge&quot;</span><span class="p">],</span> <span class="p">[</span><span class="cm">/* 63 vars */</span><span class="p">])</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">[</span> <span class="n">Process</span> <span class="n">PID</span><span class="o">=</span><span class="mi">22998</span> <span class="n">runs</span> <span class="n">in</span> <span class="mi">32</span> <span class="n">bit</span> <span class="n">mode</span><span class="p">.</span> <span class="p">]</span>
<span class="n">brk</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>                                  <span class="o">=</span> <span class="mh">0x9882000</span>
<span class="n">access</span><span class="p">(</span><span class="s">&quot;/etc/ld.so.nohwcap&quot;</span><span class="p">,</span> <span class="n">F_OK</span><span class="p">)</span>      <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="n">ENOENT</span> <span class="p">(</span><span class="n">No</span> <span class="n">such</span> <span class="n">file</span> <span class="n">or</span> <span class="n">directory</span><span class="p">)</span>
<span class="n">mmap2</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">8192</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="o">|</span><span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_PRIVATE</span><span class="o">|</span><span class="n">MAP_ANONYMOUS</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0xfffffffff76f5000</span>
<span class="n">access</span><span class="p">(</span><span class="s">&quot;/etc/ld.so.preload&quot;</span><span class="p">,</span> <span class="n">R_OK</span><span class="p">)</span>      <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="n">ENOENT</span> <span class="p">(</span><span class="n">No</span> <span class="n">such</span> <span class="n">file</span> <span class="n">or</span> <span class="n">directory</span><span class="p">)</span>
<span class="n">open</span><span class="p">(</span><span class="s">&quot;/etc/ld.so.cache&quot;</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="o">|</span><span class="n">O_CLOEXEC</span><span class="p">)</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">fstat64</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="p">{</span><span class="n">st_mode</span><span class="o">=</span><span class="n">S_IFREG</span><span class="o">|</span><span class="mo">0644</span><span class="p">,</span> <span class="n">st_size</span><span class="o">=</span><span class="mi">156058</span><span class="p">,</span> <span class="p">...})</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">mmap2</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">156058</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="p">,</span> <span class="n">MAP_PRIVATE</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0xfffffffff76ce000</span>
<span class="n">close</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>                                <span class="o">=</span> <span class="mi">0</span>
<span class="n">access</span><span class="p">(</span><span class="s">&quot;/etc/ld.so.nohwcap&quot;</span><span class="p">,</span> <span class="n">F_OK</span><span class="p">)</span>      <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="n">ENOENT</span> <span class="p">(</span><span class="n">No</span> <span class="n">such</span> <span class="n">file</span> <span class="n">or</span> <span class="n">directory</span><span class="p">)</span>
<span class="n">open</span><span class="p">(</span><span class="s">&quot;/lib/i386-linux-gnu/libc.so.6&quot;</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="o">|</span><span class="n">O_CLOEXEC</span><span class="p">)</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">read</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\177</span><span class="s">ELF</span><span class="se">\1\1\1\0\0\0\0\0\0\0\0\0\3\0\3\0\1\0\0\000</span><span class="s">0</span><span class="se">\226\1\000</span><span class="s">4</span><span class="se">\0\0\0</span><span class="s">&quot;</span><span class="p">...,</span> <span class="mi">512</span><span class="p">)</span> <span class="o">=</span> <span class="mi">512</span>
<span class="n">fstat64</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="p">{</span><span class="n">st_mode</span><span class="o">=</span><span class="n">S_IFREG</span><span class="o">|</span><span class="mo">0755</span><span class="p">,</span> <span class="n">st_size</span><span class="o">=</span><span class="mi">1734120</span><span class="p">,</span> <span class="p">...})</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">mmap2</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">1743580</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="o">|</span><span class="n">PROT_EXEC</span><span class="p">,</span> <span class="n">MAP_PRIVATE</span><span class="o">|</span><span class="n">MAP_DENYWRITE</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0xfffffffff7524000</span>
<span class="n">mmap2</span><span class="p">(</span><span class="mh">0xf76c8000</span><span class="p">,</span> <span class="mi">12288</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="o">|</span><span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_PRIVATE</span><span class="o">|</span><span class="n">MAP_FIXED</span><span class="o">|</span><span class="n">MAP_DENYWRITE</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mh">0x1a4</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0xfffffffff76c8000</span>
<span class="n">mmap2</span><span class="p">(</span><span class="mh">0xf76cb000</span><span class="p">,</span> <span class="mi">10972</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="o">|</span><span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_PRIVATE</span><span class="o">|</span><span class="n">MAP_FIXED</span><span class="o">|</span><span class="n">MAP_ANONYMOUS</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0xfffffffff76cb000</span>
<span class="n">close</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>                                <span class="o">=</span> <span class="mi">0</span>
<span class="n">mmap2</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="o">|</span><span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_PRIVATE</span><span class="o">|</span><span class="n">MAP_ANONYMOUS</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0xfffffffff7523000</span>
<span class="n">set_thread_area</span><span class="p">(</span><span class="mh">0xffbd0af0</span><span class="p">)</span>             <span class="o">=</span> <span class="mi">0</span>
<span class="n">mprotect</span><span class="p">(</span><span class="mh">0xf76c8000</span><span class="p">,</span> <span class="mi">8192</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="p">)</span>   <span class="o">=</span> <span class="mi">0</span>
<span class="n">mprotect</span><span class="p">(</span><span class="mh">0x8049000</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="p">)</span>    <span class="o">=</span> <span class="mi">0</span>
<span class="n">mprotect</span><span class="p">(</span><span class="mh">0xf7718000</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="p">)</span>   <span class="o">=</span> <span class="mi">0</span>
<span class="n">munmap</span><span class="p">(</span><span class="mh">0xf76ce000</span><span class="p">,</span> <span class="mi">156058</span><span class="p">)</span>              <span class="o">=</span> <span class="mi">0</span>
<span class="n">ptrace</span><span class="p">(</span><span class="n">PTRACE_TRACEME</span><span class="p">,</span> <span class="mi">4290579748</span><span class="p">,</span> <span class="mh">0xffbd0cb4</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="n">EPERM</span> <span class="p">(</span><span class="n">Operation</span> <span class="n">not</span> <span class="n">permitted</span><span class="p">)</span>
<span class="n">fstat64</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="n">st_mode</span><span class="o">=</span><span class="n">S_IFCHR</span><span class="o">|</span><span class="mo">0620</span><span class="p">,</span> <span class="n">st_rdev</span><span class="o">=</span><span class="n">makedev</span><span class="p">(</span><span class="mi">136</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="p">...})</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">mmap2</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="o">|</span><span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_PRIVATE</span><span class="o">|</span><span class="n">MAP_ANONYMOUS</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0xfffffffff76f4000</span>
<span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Dude, no debugging ;-)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">23</span><span class="n">Dude</span><span class="p">,</span> <span class="n">no</span> <span class="n">debugging</span> <span class="p">;</span><span class="o">-</span><span class="p">)</span>
<span class="p">)</span> <span class="o">=</span> <span class="mi">23</span>
<span class="n">exit_group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>                           <span class="o">=</span> <span class="o">?</span>
</code></pre></div>

<p>The program stopped since the <code>ptrace</code> system call returned <code>EPERM</code>
error code which indicates that the <code>PTRACE_TRACEME</code> operation is not
permitted. This is a very commonly used anti-debugging method and it
works since such program already invoke <code>ptrace</code> over them before
executing any other functions and as such when a user manually tries to
debug it (via <code>ptrace</code> calls), it fails since a trace session is already
active on the program and another cannot be initialized.</p>

<p>Anyways, like the previous challenge, this was also completed without
actually debugging the program. However, there are still ways in which
we can bypass the anti-debugging mechanisms and analyze the program via
dynamic analysis only. Rest on this in a future post. Stay tuned.</p>

        </div>
        <div class="meta">
          <hr/>
          <p>For comments, questions and suggestions use <a href="https://twitter.com/7h3rAm" target="_blank">twitter</a> or create an <a href="https://github.com/7h3rAm/7h3rAm.github.io/issues/new" target="_blank">issue</a> on blog repository.</p>
          <hr/>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <table>
                <tr>
                  <td align="left">(share via <a href="mailto:?subject=reverse Challenge from Coursera's Malicious Software Course&body=http://7h3ram.github.io//2013/malsoftware-reverse-challenge.html" target="_blank" title="Share via Email">mail</a>, <a href="http://twitter.com/intent/tweet?text=reverse Challenge from Coursera's Malicious Software Course+http://7h3ram.github.io//2013/malsoftware-reverse-challenge.html&via=7h3rAm" target="_blank" title="Share on Twitter">twitter</a>, <a href="http://www.facebook.com/sharer/sharer.php?s=100&p[url]=http://7h3ram.github.io//2013/malsoftware-reverse-challenge.html&p[images][0]=&p[title]=reverse Challenge from Coursera's Malicious Software Course&p[summary]=This post is a writeup on the reverse-challenge from recently concluded Malicious Software course on Coursera." target="_blank" title="Share on Facebook">facebook</a> or <a href="https://plus.google.com/share?url=http://7h3ram.github.io//2013/malsoftware-reverse-challenge.html" target="_blank" title="Share on Google Plus">google-plus</a>)</td>
                  <td align="right">(tagged <a href=/tags.html#reversing>reversing</a> and <a href=/tags.html#writeups>writeups</a>)</td>
                </tr>
                <tr>
                                      <td align="left"><a href="/2013/malsoftware-reverse-ex.html">&lt;&lt; reverse-ex Challenge from Coursera's Malicious Software Course &lt;&lt;</a></td>
                    <td align="right"><a href="/2013/libnids-python-ids.html">&gt;&gt; Developing a Minimal IPS from Scratch &gt;&gt;</a></td>
                                  </tr>
              </table>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </div>
        </div>
      </div>
    </div>
  </div>
  </article>
              <div class="footer">
          <center>
            <a href="/rss.xml" target="_blank">rss</a> | <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" rel="license" target="_blank">license</a>
          </center>
        </div>
          </section>
  </body>
</html>