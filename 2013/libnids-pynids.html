<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta name="author" content="7h3rAm"/>
    <meta name="description" content="Personal Weblog"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <title>Grey Matter</title>

    <link href="/static/css/default.css" rel="stylesheet" type="text/css">
    <link href="/static/css/codehilite/perldoc.css" rel="stylesheet" type="text/css">

    <link href="/static/images/favicon-32x32.png" sizes="32x32" rel="icon" type="image/png"/>
  </head>
  <body>
    <section id="content" class="body">
              <div class="header">
          <table>
            <tr>
              <td class="blogtitle"><a href="/" style="color: rgb(102, 102, 102);">Grey Matter</a></td>
              <td class="blognavbar">
                [<a id="archive" href="/archive.html" style="color: rgb(70, 130, 180);">Archive</a>] [<a id="tags" href="/tags.html" style="color: rgb(255, 183, 69);">Tags</a>] [<a id="projects" href="/projects.html" style="color: rgb(0, 128, 128);">Projects</a>] [<a id="research" href="/research.html" style="color: rgb(242, 119, 122);">Research</a>]
              </td>
            </tr>
          </table>
        </div>
                  <article class="post">
  <div class="row">
    <div class="col-lg-12">
      <div class="panel panel-default section compact">
        <div class="body">
          <p class="heading">Network Stream Reassembly and Defragmentation</p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <p class="date">
                  <a href="/2013/libemu-shellcode-detection.html">&lt&lt;</a> published on 18/Jun/2013<a href="/2013/malsoftware-reverse-ex.html"> &gt;&gt;</i></a><br/>
                </p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <div class="post-content">
          <p>We&#8217;ll be using the <a href="https://jon.oberheide.org/pynids/">pynids</a> Python
binding from <a href="https://jon.oberheide.org/">Jon Oberheide</a>. Installation
instructions are very well documented within the <code>README</code> file and I
suggest you read and follow them. Let&#8217;s have a look at an example
program to test pynids installation:</p>

<pre><code>#!/usr/bin/env python

import sys
import nids

end_states = (nids.NIDS_CLOSE, nids.NIDS_TIMEOUT, nids.NIDS_RESET)

def tcpcallback(tcp):
    if tcp.nids_state == nids.NIDS_JUST_EST:
        ((src, sport), (dst, dport)) = tcp.addr
        tcp.client.collect = 1
        tcp.server.collect = 1

    elif tcp.nids_state == nids.NIDS_DATA:
        tcp.discard(0)

    elif tcp.nids_state in end_states:
        ((src, sport), (dst, dport)) = tcp.addr
        print "[+] %s:%s - %s:%s (CTS: %dB | STC: %dB)" % (src, sport, dst, dport,
                len(tcp.server.data[:tcp.server.count]),
                len(tcp.client.data[:tcp.client.count]))

def main():
    if len(sys.argv) == 2:
        nids.param("filename", sys.argv[1])

    nids.init()
    nids.register_tcp(tcpcallback)

    try:
        nids.run()
    except nids.error, e:
        print "[-] Error: %s" % (e)
    except Exception, e:
        print "[-] Exception: %s" % (e)

if __name__ == '__main__':
    main()
</code></pre>

<p>Above program initializes Libnids and registers a TCP callback that
would be called for each TCP packet seen by the library. For each new
connection, the callback function requests Libnids to collect both
client-to-server (CTS) and server-to-client (STC) flowing traffic. When
the connection is closed/terminated/timed out, the above program dumps
total bytes of data seen on both directions for the closed stream:</p>

<pre><code>$ python nidstest.py ~/toolbox/testfiles/pcaps/http_witp_jpegs.cap
[+] 10.1.1.101:3177 - 10.1.1.1:80 (CTS: 476B | STC: 435B)
[+] 10.1.1.101:3188 - 10.1.1.1:80 (CTS: 574B | STC: 4601B)
[+] 10.1.1.101:3189 - 10.1.1.1:80 (CTS: 597B | STC: 8566B)
[+] 10.1.1.101:3190 - 10.1.1.1:80 (CTS: 600B | STC: 9330B)
[+] 10.1.1.101:3195 - 10.1.1.1:80 (CTS: 601B | STC: 692B)
[+] 10.1.1.101:3196 - 10.1.1.1:80 (CTS: 614B | STC: 1540B)
[+] 10.1.1.101:3197 - 10.1.1.1:80 (CTS: 622B | STC: 2509B)
[+] 10.1.1.101:3198 - 10.1.1.1:80 (CTS: 632B | STC: 9248B)
[+] 10.1.1.101:3199 - 10.1.1.1:80 (CTS: 632B | STC: 10990B)
[+] 10.1.1.101:3200 - 10.1.1.1:80 (CTS: 637B | STC: 191777B)
</code></pre>

<p>Let&#8217;s have a look at the content of each stream and see what data will
the TCP layer present as payload to application layer:</p>

<pre><code>$ python nidsstream.py ~/toolbox/testfiles/pcaps/http.cap
[+] 145.254.160.237:3372 - 65.208.228.223:80 (CTS: 479B | STC: 18364B)

GET /download.html HTTP/1.1
Host: www.ethereal.com
User-Agent: Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.6) Gecko/20040113
Accept: text/xml,application/xml,application/xhtml+xml,text/html
Accept-Language: en-us,en;q=0.5
Accept-Encoding: gzip,deflate
Accept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7
Keep-Alive: 300
Connection: keep-alive
Referer: http://www.ethereal.com/development.html


HTTP/1.1 200 OK
Date: Thu, 13 May 2004 10:17:12 GMT
Server: Apache
Last-Modified: Tue, 20 Apr 2004 13:17:00 GMT
ETag: "9a01a-4696-7e354b00"
Accept-Ranges: bytes
Content-Length: 18070
Keep-Alive: timeout=15, max=100
Connection: Keep-Alive
Content-Type: text/html; charset=ISO-8859-1

&lt;?xml version="1.0" encoding="UTF-8"?&gt;
</code></pre>

<p>The test pcap contains an HTTP session and the program dumps CTS and STC
content (limited to first ~300B) and this is exactly what the
applications at layer 7 will send/receive while interacting with lower
layers. Gaining direct access to this data opens up a number of
possibilities for us to explore. Network inspection tools, primarily
Intrusion Detection and Prevention Systems, will reassemble TCP packets
and to create this buffer and then inspect this buffer in various ways
to identify if it contains malicious content. One of the very common
practices is to carry out signature based inspection on network streams
to identify if they contain exploit traffic.</p>

<p>In an <a href="/2013/libnids-python-ids.html">upcoming post</a>, I&#8217;ll try to explain how pynids and native Python
modules can be used to develop a minimal IDS from scratch. Stay tuned.</p>

        </div>
        <div class="meta">
          <hr/>
          <p>For comments, questions and suggestions use <a href="https://twitter.com/7h3rAm" target="_blank">twitter</a> or create an <a href="https://github.com/7h3rAm/7h3rAm.github.io/issues/new" target="_blank">issue</a> on blog repository.</p>
          <hr/>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <table>
                <tr>
                  <td align="left">(share via <a href="mailto:?subject=Network Stream Reassembly and Defragmentation&body=http://7h3ram.github.io//2013/libnids-pynids.html" target="_blank" title="Share via Email">mail</a>, <a href="http://twitter.com/intent/tweet?text=Network Stream Reassembly and Defragmentation+http://7h3ram.github.io//2013/libnids-pynids.html&via=7h3rAm" target="_blank" title="Share on Twitter">twitter</a>, <a href="http://www.facebook.com/sharer/sharer.php?s=100&p[url]=http://7h3ram.github.io//2013/libnids-pynids.html&p[images][0]=&p[title]=Network Stream Reassembly and Defragmentation&p[summary]=Libnids is a library that emulates Linux kernel 2.0.x TCP/IP stack to offer IP defragmentation, TCP reassembly and port scan detection features. This post talks about the Python wrapper and how to use it." target="_blank" title="Share on Facebook">facebook</a> or <a href="https://plus.google.com/share?url=http://7h3ram.github.io//2013/libnids-pynids.html" target="_blank" title="Share on Google Plus">google-plus</a>)</td>
                  <td align="right">(tagged <a href=/tags.html#code>code</a>)</td>
                </tr>
                <tr>
                                      <td align="left"><a href="/2013/libemu-shellcode-detection.html">&lt;&lt; x86 Emulation and Shellcode Detection &lt;&lt;</a></td>
                    <td align="right"><a href="/2013/malsoftware-reverse-ex.html">&gt;&gt; reverse-ex Challenge from Coursera's Malicious Software Course &gt;&gt;</a></td>
                                  </tr>
              </table>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </div>
        </div>
      </div>
    </div>
  </div>
  </article>
              <div class="footer">
          <center>
            <a href="/rss.xml" target="_blank">rss</a> | <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" rel="license" target="_blank">license</a>
          </center>
        </div>
          </section>

    <script type="text/javascript">
      document.addEventListener("DOMContentLoaded", function() {
        var colors = ["#4B0082", "#3CB371", "#2E8B57", "#808000", "#20B2AA", "#008B8B", "#4682B4", "#B0C4DE", "#87CEFA", "#87CEEB", "#1E90FF", "#6495ED", "#000080", "#191970"];
        document.getElementById("element").style.color = colors[Math.floor(Math.random() * colors.length)];
      }, false);
    </script>

  </body>
</html>