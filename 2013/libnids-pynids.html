<!DOCTYPE html>
<html lang="en">
  <head>
    <title>7h3rAm's Infosec Ramblings</title>
    <meta charset="utf-8"/>
    <meta content="7h3rAm" name="author"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>

    <script src="/static/js/jquery/jquery-1.10.2.js"></script>
    <link href="/static/css/bootstrap/bootstrap.3.3.6.min.css" rel="stylesheet" type="text/css">
    <link href="/static/css/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="/static/css/morrisjs/morris.css" rel="stylesheet" type="text/css">
    <link href="/static/css/timeline/timeline.css" rel="stylesheet" type="text/css">
    <link href="/static/css/main.css" rel="stylesheet" type="text/css">
    <link href="/static/css/codehilite/zenburn.css" rel="stylesheet" type="text/css">
    <link href="/static/images/favicon.ico" rel="icon" type="image/x-icon"/>

    <!-- Google Analytics -->
    <script>
    window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
    ga('create', 'UA-50288765-1', '7h3rAm.github.io');
    ga('send', 'pageview');
    </script>
    <script async src='http://www.google-analytics.com/analytics.js'></script>
    <!-- End Google Analytics -->

  </head>
  <body id="index" class="home">
    <header class="header">
      <nav>
        <ul>
          <li><a href="/"><i class="fa fa-home"></i> Home</a></li>
          <li><a href="/archive.html"><i class="fa fa-archive"></i> Archive</a></li>
          <li><a href="/tags.html"><i class="fa fa-tags"></i> Tags</a></li>
          <li><a href="/dashboard.html"><i class="fa fa-bar-chart"></i> Dashboard</a></li>
          <li><a href="/research.html"><i class="fa fa-list-alt"></i> Research</a></li>
        </ul>
      </nav>
    </header>
    <section id="content" class="body">
      
  
  
  <article class="post">
  <div class="row">
    <div class="col-lg-12">
      <div class="panel panel-default">
        <div class="panel-heading post-title">
          Network Stream Reassembly and Defragmentation
        </div>
        <div class="panel-body">
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
              
                
                
              
              
                
                
              
              
                <p class="post-date">
                  <a href="/2013/libemu-shellcode-detection.html"><i class="fa fa-angle-double-left"></i></a> published on June 18, 2013<a href="/2013/malsoftware-reverse-ex.html"> <i class="fa fa-angle-double-right"></i></a><br/>
                  readtime: 9 minutes and 24 seconds (view <a href="https://raw.githubusercontent.io/7h3rAm/7h3rAm.github.io/master/_posts/libnids-pynids.md">source</a>)
                </p>
              
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        <div class="post-summary">Libnids is a library that emulates Linux kernel 2.0.x TCP/IP stack to offer IP defragmentation, TCP reassembly and port scan detection features. This post talks about the Python wrapper and how to use it.</div>
        <div class="post-content">
          <p><a href="http://libnids.sourceforge.net/">Libnids</a> is a library that emulates
Linux kernel 2.0.x TCP/IP stack to offer IP defragmentation, TCP
reassembly and port scan detection features. It allows programs to
accept arbitrary packet data, either from a packet capture file or
directly from a network interface and extract TCP streams out of it.
This stream is what layer 7 applications will process and as such it is
a very good source for inspection tools to look for malicious content in
it. In this post, we&#8217;ll be seeing how Libnids and its Python binding can
be used to create a nifty network inspection utility.</p>

<p>We&#8217;ll be using the <a href="https://jon.oberheide.org/pynids/">pynids</a> Python
binding from <a href="https://jon.oberheide.org/">Jon Oberheide</a>. Installation
instructions are very well documented within the <code>README</code> file and I
suggest you read and follow them. Let&#8217;s have a look at an example
program to test pynids installation:</p>

<div class="codehilite"><pre><code><span class="c">#!/usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">nids</span>

<span class="n">end_states</span> <span class="o">=</span> <span class="p">(</span><span class="n">nids</span><span class="o">.</span><span class="n">NIDS_CLOSE</span><span class="p">,</span> <span class="n">nids</span><span class="o">.</span><span class="n">NIDS_TIMEOUT</span><span class="p">,</span> <span class="n">nids</span><span class="o">.</span><span class="n">NIDS_RESET</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">tcpcallback</span><span class="p">(</span><span class="n">tcp</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">tcp</span><span class="o">.</span><span class="n">nids_state</span> <span class="o">==</span> <span class="n">nids</span><span class="o">.</span><span class="n">NIDS_JUST_EST</span><span class="p">:</span>
        <span class="p">((</span><span class="n">src</span><span class="p">,</span> <span class="n">sport</span><span class="p">),</span> <span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">dport</span><span class="p">))</span> <span class="o">=</span> <span class="n">tcp</span><span class="o">.</span><span class="n">addr</span>
        <span class="n">tcp</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">collect</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">tcp</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">collect</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">elif</span> <span class="n">tcp</span><span class="o">.</span><span class="n">nids_state</span> <span class="o">==</span> <span class="n">nids</span><span class="o">.</span><span class="n">NIDS_DATA</span><span class="p">:</span>
        <span class="n">tcp</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">tcp</span><span class="o">.</span><span class="n">nids_state</span> <span class="ow">in</span> <span class="n">end_states</span><span class="p">:</span>
        <span class="p">((</span><span class="n">src</span><span class="p">,</span> <span class="n">sport</span><span class="p">),</span> <span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">dport</span><span class="p">))</span> <span class="o">=</span> <span class="n">tcp</span><span class="o">.</span><span class="n">addr</span>
        <span class="k">print</span> <span class="s">&quot;[+] </span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s"> - </span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s"> (CTS: </span><span class="si">%d</span><span class="s">B | STC: </span><span class="si">%d</span><span class="s">B)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">sport</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">dport</span><span class="p">,</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">tcp</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span><span class="n">tcp</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">count</span><span class="p">]),</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">tcp</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span><span class="n">tcp</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">count</span><span class="p">]))</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">nids</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s">&quot;filename&quot;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">nids</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
    <span class="n">nids</span><span class="o">.</span><span class="n">register_tcp</span><span class="p">(</span><span class="n">tcpcallback</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">nids</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">nids</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;[-] Error: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;[-] Exception: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>

<p>Above program initializes Libnids and registers a TCP callback that
would be called for each TCP packet seen by the library. For each new
connection, the callback function requests Libnids to collect both
client-to-server (CTS) and server-to-client (STC) flowing traffic. When
the connection is closed/terminated/timed out, the above program dumps
total bytes of data seen on both directions for the closed stream:</p>

<div class="codehilite"><pre><code><span class="nv">$ </span>python nidstest.py ~/toolbox/testfiles/pcaps/http_witp_jpegs.cap
<span class="o">[</span>+<span class="o">]</span> 10.1.1.101:3177 - 10.1.1.1:80 <span class="o">(</span>CTS: 476B <span class="p">|</span> STC: 435B<span class="o">)</span>
<span class="o">[</span>+<span class="o">]</span> 10.1.1.101:3188 - 10.1.1.1:80 <span class="o">(</span>CTS: 574B <span class="p">|</span> STC: 4601B<span class="o">)</span>
<span class="o">[</span>+<span class="o">]</span> 10.1.1.101:3189 - 10.1.1.1:80 <span class="o">(</span>CTS: 597B <span class="p">|</span> STC: 8566B<span class="o">)</span>
<span class="o">[</span>+<span class="o">]</span> 10.1.1.101:3190 - 10.1.1.1:80 <span class="o">(</span>CTS: 600B <span class="p">|</span> STC: 9330B<span class="o">)</span>
<span class="o">[</span>+<span class="o">]</span> 10.1.1.101:3195 - 10.1.1.1:80 <span class="o">(</span>CTS: 601B <span class="p">|</span> STC: 692B<span class="o">)</span>
<span class="o">[</span>+<span class="o">]</span> 10.1.1.101:3196 - 10.1.1.1:80 <span class="o">(</span>CTS: 614B <span class="p">|</span> STC: 1540B<span class="o">)</span>
<span class="o">[</span>+<span class="o">]</span> 10.1.1.101:3197 - 10.1.1.1:80 <span class="o">(</span>CTS: 622B <span class="p">|</span> STC: 2509B<span class="o">)</span>
<span class="o">[</span>+<span class="o">]</span> 10.1.1.101:3198 - 10.1.1.1:80 <span class="o">(</span>CTS: 632B <span class="p">|</span> STC: 9248B<span class="o">)</span>
<span class="o">[</span>+<span class="o">]</span> 10.1.1.101:3199 - 10.1.1.1:80 <span class="o">(</span>CTS: 632B <span class="p">|</span> STC: 10990B<span class="o">)</span>
<span class="o">[</span>+<span class="o">]</span> 10.1.1.101:3200 - 10.1.1.1:80 <span class="o">(</span>CTS: 637B <span class="p">|</span> STC: 191777B<span class="o">)</span>
</code></pre></div>

<p>Let&#8217;s have a look at the content of each stream and see what data will
the TCP layer present as payload to application layer:</p>

<div class="codehilite"><pre><code><span class="nv">$ </span>python nidsstream.py ~/toolbox/testfiles/pcaps/http.cap
<span class="o">[</span>+<span class="o">]</span> 145.254.160.237:3372 - 65.208.228.223:80 <span class="o">(</span>CTS: 479B <span class="p">|</span> STC: 18364B<span class="o">)</span>

GET /download.html HTTP/1.1
Host: www.ethereal.com
User-Agent: Mozilla/5.0 <span class="o">(</span>Windows<span class="p">;</span> U<span class="p">;</span> Windows NT 5.1<span class="p">;</span> en-US<span class="p">;</span> rv:1.6<span class="o">)</span> Gecko/20040113
Accept: text/xml,application/xml,application/xhtml+xml,text/html
Accept-Language: en-us,en<span class="p">;</span><span class="nv">q</span><span class="o">=</span>0.5
Accept-Encoding: gzip,deflate
Accept-Charset: ISO-8859-1,utf-8<span class="p">;</span><span class="nv">q</span><span class="o">=</span>0.7,*<span class="p">;</span><span class="nv">q</span><span class="o">=</span>0.7
Keep-Alive: 300
Connection: keep-alive
Referer: http://www.ethereal.com/development.html


HTTP/1.1 <span class="m">200</span> OK
Date: Thu, <span class="m">13</span> May <span class="m">2004</span> 10:17:12 GMT
Server: Apache
Last-Modified: Tue, <span class="m">20</span> Apr <span class="m">2004</span> 13:17:00 GMT
ETag: <span class="s2">&quot;9a01a-4696-7e354b00&quot;</span>
Accept-Ranges: bytes
Content-Length: 18070
Keep-Alive: <span class="nv">timeout</span><span class="o">=</span>15, <span class="nv">max</span><span class="o">=</span>100
Connection: Keep-Alive
Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>ISO-8859-1

&lt;?xml <span class="nv">version</span><span class="o">=</span><span class="s2">&quot;1.0&quot;</span> <span class="nv">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span>?&gt;
</code></pre></div>

<p>The test pcap contains an HTTP session and the program dumps CTS and STC
content (limited to first ~300B) and this is exactly what the
applications at layer 7 will send/receive while interacting with lower
layers. Gaining direct access to this data opens up a number of
possibilities for us to explore. Network inspection tools, primarily
Intrusion Detection and Prevention Systems, will reassemble TCP packets
and to create this buffer and then inspect this buffer in various ways
to identify if it contains malicious content. One of the very common
practices is to carry out signature based inspection on network streams
to identify if they contain exploit traffic.</p>

<p>In an <a href="/2013/libnids-python-ids.html">upcoming post</a>, I&#8217;ll try to explain how pynids and native Python
modules can be used to develop a minimal IDS from scratch. Stay tuned.</p>

        </div>
        <div class="post-bottomline">
          <hr/>
          <p>For comments, questions and suggestions use <a href="https://twitter.com/7h3rAm" target="_blank"><i class="fa fa-twitter"></i></a> or create an <a href="https://github.com/7h3rAm/7h3rAm.github.io/issues/new" target="_blank"><i class="fa fa-exclamation-circle"></i> issue</a> on blog reporsitory.</p>
          <hr/>
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
              
                
                
              
              
                
                
              
              <table>
                <tr>
                  <td align="left">(share via <a href="mailto:?subject=Network Stream Reassembly and Defragmentation&body=/2013/libnids-pynids.html" target="_blank" title="Share via Email"><i class="fa fa-inbox"></i></a> <a href="http://twitter.com/intent/tweet?text=Network Stream Reassembly and Defragmentation+/2013/libnids-pynids.html&via=7h3rAm" target="_blank" title="Share on Twitter"><i class="fa fa-twitter"></i></a> <a href="http://www.facebook.com/sharer/sharer.php?s=100&p[url]=/2013/libnids-pynids.html&p[images][0]=&p[title]=Network Stream Reassembly and Defragmentation&p[summary]=Libnids is a library that emulates Linux kernel 2.0.x TCP/IP stack to offer IP defragmentation, TCP reassembly and port scan detection features. This post talks about the Python wrapper and how to use it." target="_blank" title="Share on Facebook"><i class="fa fa-facebook"></i></a> <a href="https://plus.google.com/share?url=/2013/libnids-pynids.html" target="_blank" title="Share on Google Plus"><i class="fa fa-google-plus"></i></a>)</td>
                  <td align="right">(tagged <a href=/tags.html#code>code</a>)</td>
                </tr>
                <tr>
                  
                    <td align="left"><a href="/2013/libemu-shellcode-detection.html"><i class="fa fa-angle-double-left"></i> x86 Emulation and Shellcode Detection <i class="fa fa-angle-double-left"></i></a></td>
                    <td align="right"><a href="/2013/malsoftware-reverse-ex.html"><i class="fa fa-angle-double-right"></i> reverse-ex Challenge from Coursera's Malicious Software Course <i class="fa fa-angle-double-right"></i></a></td>
                  
                </tr>
              </table>
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-12">
      <div class="panel panel-default">
        <div class="panel-heading post-title">
          Related Posts
        </div>
        <div class="panel-body">
          
            1. <a href="/2016/flareon2014-15.html">FireEye FLARE On 2014 Challenges (1-5)</a>
            <div class="overview-date">February 18, 2016</div>
            <br/>
          
            2. <a href="/2014/pcapgentools-contentype-patch.html">PCAP-GenerationTools and Content-Type Identification Patch</a>
            <div class="overview-date">June 18, 2014</div>
            <br/>
          
            3. <a href="/2013/regex-to-dotgraph.html">Visualizing (non-POSIX) Regular Expressions</a>
            <div class="overview-date">November 27, 2013</div>
            <br/>
          
        </div>
      </div>
    </div>
  </div>

  </article>

    </section>
    <footer class="footer">
      <b><a href="/">Ankur Tyagi</a></b> (<b><a href="https://twitter.com/7h3rAm" target="_blank"><i class="fa fa-at"></i>7h3rAm</a></b>)
      <br/>
      Last updated on October 20, 2016 (<b><a href="/rss.xml"><i class="fa fa-rss"></i> rss</a></b> <b><a href="/sitemap.xml"><i class="fa fa-sitemap"></i> sitemap</a></b>)
      <br/>
      Published under <b><a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" rel="license" target="_blank">by-nc-sa</a></b> and powered by <b><a alt="Linux" href="https://www.kernel.org/" target="_blank"><i class="fa fa-linux"></i></a></b>, <b><a alt="Kalpi" href="https://github.com/7h3rAm/kalpi/" target="_blank">kalpi</a></b>, <b><a href="http://git-scm.com/" target="_blank"><i class="fa fa-git"></i></a></b> and <b><a href="https://github.com/7h3rAm/7h3ram.github.io" target="_blank"><i class="fa fa-github"></i></a></b>
    </footer>

    <script src="/static/js/bootstrap/bootstrap.3.3.6.min.js"></script>
    <script src="/static/js/raphael/raphael-min.js"></script>
    <script src="/static/js/morrisjs/morris.min.js"></script>
    <script src="/static/files/chart-data.js"></script>
    <script src="/static/js/sprintf/sprintf.js"></script>
    <script src="/static/js/underscore/underscore-min.js"></script>

  </body>
</html>