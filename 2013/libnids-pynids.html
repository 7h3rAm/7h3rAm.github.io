<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta name="author" content="7h3rAm"/>
    <meta name="description" content="Personal Weblog"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <title>Grey Matter</title>

    <link href="/static/css/default.css" rel="stylesheet" type="text/css">
    <link href="/static/css/codehilite/perldoc.css" rel="stylesheet" type="text/css">

    <link href="/static/images/favicon-32x32.png" sizes="32x32" rel="icon" type="image/png"/>
  </head>
  <body>
    <section id="content" class="body">
              <div class="header">
          <table>
            <tr>
              <td class="blogtitle"><a href="/" style="color: rgb(102, 102, 102);">Grey Matter</a></td>
              <td class="blognavbar">
                <a href="/archive.html">[Archive]</a> <a href="/tags.html">[Tags]</a> <a href="/research.html">[Research]</a></a>
              </td>
            </tr>
          </table>
        </div>
                  <article class="post">
  <div class="row">
    <div class="col-lg-12">
      <div class="panel panel-default section compact">
        <div class="body">
          <p class="heading">Network Stream Reassembly and Defragmentation</p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <p class="date">
                  <a href="/2013/libemu-shellcode-detection.html">&lt&lt;</a> published on 18/Jun/2013<a href="/2013/malsoftware-reverse-ex.html"> &gt;&gt;</i></a><br/>
                </p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <div class="post-content">
          <p><a href="http://libnids.sourceforge.net/">Libnids</a> is a library that emulates
Linux kernel 2.0.x TCP/IP stack to offer IP defragmentation, TCP
reassembly and port scan detection features. It allows programs to
accept arbitrary packet data, either from a packet capture file or
directly from a network interface and extract TCP streams out of it.
This stream is what layer 7 applications will process and as such it is
a very good source for inspection tools to look for malicious content in
it. In this post, we&#8217;ll be seeing how Libnids and its Python binding can
be used to create a nifty network inspection utility.</p>

<p>We&#8217;ll be using the <a href="https://jon.oberheide.org/pynids/">pynids</a> Python
binding from <a href="https://jon.oberheide.org/">Jon Oberheide</a>. Installation
instructions are very well documented within the <code>README</code> file and I
suggest you read and follow them. Let&#8217;s have a look at an example
program to test pynids installation:</p>

<div class="codehilite"><pre><span></span><code><span class="ch">#!/usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">nids</span>

<span class="n">end_states</span> <span class="o">=</span> <span class="p">(</span><span class="n">nids</span><span class="o">.</span><span class="n">NIDS_CLOSE</span><span class="p">,</span> <span class="n">nids</span><span class="o">.</span><span class="n">NIDS_TIMEOUT</span><span class="p">,</span> <span class="n">nids</span><span class="o">.</span><span class="n">NIDS_RESET</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">tcpcallback</span><span class="p">(</span><span class="n">tcp</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">tcp</span><span class="o">.</span><span class="n">nids_state</span> <span class="o">==</span> <span class="n">nids</span><span class="o">.</span><span class="n">NIDS_JUST_EST</span><span class="p">:</span>
        <span class="p">((</span><span class="n">src</span><span class="p">,</span> <span class="n">sport</span><span class="p">),</span> <span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">dport</span><span class="p">))</span> <span class="o">=</span> <span class="n">tcp</span><span class="o">.</span><span class="n">addr</span>
        <span class="n">tcp</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">collect</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">tcp</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">collect</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">elif</span> <span class="n">tcp</span><span class="o">.</span><span class="n">nids_state</span> <span class="o">==</span> <span class="n">nids</span><span class="o">.</span><span class="n">NIDS_DATA</span><span class="p">:</span>
        <span class="n">tcp</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">tcp</span><span class="o">.</span><span class="n">nids_state</span> <span class="ow">in</span> <span class="n">end_states</span><span class="p">:</span>
        <span class="p">((</span><span class="n">src</span><span class="p">,</span> <span class="n">sport</span><span class="p">),</span> <span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">dport</span><span class="p">))</span> <span class="o">=</span> <span class="n">tcp</span><span class="o">.</span><span class="n">addr</span>
        <span class="k">print</span> <span class="s2">&quot;[+] </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2"> - </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2"> (CTS: </span><span class="si">%d</span><span class="s2">B | STC: </span><span class="si">%d</span><span class="s2">B)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">sport</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">dport</span><span class="p">,</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">tcp</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span><span class="n">tcp</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">count</span><span class="p">]),</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">tcp</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span><span class="n">tcp</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">count</span><span class="p">]))</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">nids</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s2">&quot;filename&quot;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">nids</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
    <span class="n">nids</span><span class="o">.</span><span class="n">register_tcp</span><span class="p">(</span><span class="n">tcpcallback</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">nids</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">nids</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span> <span class="s2">&quot;[-] Error: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span> <span class="s2">&quot;[-] Exception: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>

<p>Above program initializes Libnids and registers a TCP callback that
would be called for each TCP packet seen by the library. For each new
connection, the callback function requests Libnids to collect both
client-to-server (CTS) and server-to-client (STC) flowing traffic. When
the connection is closed/terminated/timed out, the above program dumps
total bytes of data seen on both directions for the closed stream:</p>

<div class="codehilite"><pre><span></span><code>$ python nidstest.py ~/toolbox/testfiles/pcaps/http_witp_jpegs.cap
<span class="o">[</span>+<span class="o">]</span> <span class="m">10</span>.1.1.101:3177 - <span class="m">10</span>.1.1.1:80 <span class="o">(</span>CTS: 476B <span class="p">|</span> STC: 435B<span class="o">)</span>
<span class="o">[</span>+<span class="o">]</span> <span class="m">10</span>.1.1.101:3188 - <span class="m">10</span>.1.1.1:80 <span class="o">(</span>CTS: 574B <span class="p">|</span> STC: 4601B<span class="o">)</span>
<span class="o">[</span>+<span class="o">]</span> <span class="m">10</span>.1.1.101:3189 - <span class="m">10</span>.1.1.1:80 <span class="o">(</span>CTS: 597B <span class="p">|</span> STC: 8566B<span class="o">)</span>
<span class="o">[</span>+<span class="o">]</span> <span class="m">10</span>.1.1.101:3190 - <span class="m">10</span>.1.1.1:80 <span class="o">(</span>CTS: 600B <span class="p">|</span> STC: 9330B<span class="o">)</span>
<span class="o">[</span>+<span class="o">]</span> <span class="m">10</span>.1.1.101:3195 - <span class="m">10</span>.1.1.1:80 <span class="o">(</span>CTS: 601B <span class="p">|</span> STC: 692B<span class="o">)</span>
<span class="o">[</span>+<span class="o">]</span> <span class="m">10</span>.1.1.101:3196 - <span class="m">10</span>.1.1.1:80 <span class="o">(</span>CTS: 614B <span class="p">|</span> STC: 1540B<span class="o">)</span>
<span class="o">[</span>+<span class="o">]</span> <span class="m">10</span>.1.1.101:3197 - <span class="m">10</span>.1.1.1:80 <span class="o">(</span>CTS: 622B <span class="p">|</span> STC: 2509B<span class="o">)</span>
<span class="o">[</span>+<span class="o">]</span> <span class="m">10</span>.1.1.101:3198 - <span class="m">10</span>.1.1.1:80 <span class="o">(</span>CTS: 632B <span class="p">|</span> STC: 9248B<span class="o">)</span>
<span class="o">[</span>+<span class="o">]</span> <span class="m">10</span>.1.1.101:3199 - <span class="m">10</span>.1.1.1:80 <span class="o">(</span>CTS: 632B <span class="p">|</span> STC: 10990B<span class="o">)</span>
<span class="o">[</span>+<span class="o">]</span> <span class="m">10</span>.1.1.101:3200 - <span class="m">10</span>.1.1.1:80 <span class="o">(</span>CTS: 637B <span class="p">|</span> STC: 191777B<span class="o">)</span>
</code></pre></div>

<p>Let&#8217;s have a look at the content of each stream and see what data will
the TCP layer present as payload to application layer:</p>

<div class="codehilite"><pre><span></span><code>$ python nidsstream.py ~/toolbox/testfiles/pcaps/http.cap
<span class="o">[</span>+<span class="o">]</span> <span class="m">145</span>.254.160.237:3372 - <span class="m">65</span>.208.228.223:80 <span class="o">(</span>CTS: 479B <span class="p">|</span> STC: 18364B<span class="o">)</span>

GET /download.html HTTP/1.1
Host: www.ethereal.com
User-Agent: Mozilla/5.0 <span class="o">(</span>Windows<span class="p">;</span> U<span class="p">;</span> Windows NT <span class="m">5</span>.1<span class="p">;</span> en-US<span class="p">;</span> rv:1.6<span class="o">)</span> Gecko/20040113
Accept: text/xml,application/xml,application/xhtml+xml,text/html
Accept-Language: en-us,en<span class="p">;</span><span class="nv">q</span><span class="o">=</span><span class="m">0</span>.5
Accept-Encoding: gzip,deflate
Accept-Charset: ISO-8859-1,utf-8<span class="p">;</span><span class="nv">q</span><span class="o">=</span><span class="m">0</span>.7,*<span class="p">;</span><span class="nv">q</span><span class="o">=</span><span class="m">0</span>.7
Keep-Alive: <span class="m">300</span>
Connection: keep-alive
Referer: http://www.ethereal.com/development.html


HTTP/1.1 <span class="m">200</span> OK
Date: Thu, <span class="m">13</span> May <span class="m">2004</span> <span class="m">10</span>:17:12 GMT
Server: Apache
Last-Modified: Tue, <span class="m">20</span> Apr <span class="m">2004</span> <span class="m">13</span>:17:00 GMT
ETag: <span class="s2">&quot;9a01a-4696-7e354b00&quot;</span>
Accept-Ranges: bytes
Content-Length: <span class="m">18070</span>
Keep-Alive: <span class="nv">timeout</span><span class="o">=</span><span class="m">15</span>, <span class="nv">max</span><span class="o">=</span><span class="m">100</span>
Connection: Keep-Alive
Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>ISO-8859-1

&lt;?xml <span class="nv">version</span><span class="o">=</span><span class="s2">&quot;1.0&quot;</span> <span class="nv">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span>?&gt;
</code></pre></div>

<p>The test pcap contains an HTTP session and the program dumps CTS and STC
content (limited to first ~300B) and this is exactly what the
applications at layer 7 will send/receive while interacting with lower
layers. Gaining direct access to this data opens up a number of
possibilities for us to explore. Network inspection tools, primarily
Intrusion Detection and Prevention Systems, will reassemble TCP packets
and to create this buffer and then inspect this buffer in various ways
to identify if it contains malicious content. One of the very common
practices is to carry out signature based inspection on network streams
to identify if they contain exploit traffic.</p>

<p>In an <a href="/2013/libnids-python-ids.html">upcoming post</a>, I&#8217;ll try to explain how pynids and native Python
modules can be used to develop a minimal IDS from scratch. Stay tuned.</p>

        </div>
        <div class="meta">
          <hr/>
          <p>For comments, questions and suggestions use <a href="https://twitter.com/7h3rAm" target="_blank">twitter</a> or create an <a href="https://github.com/7h3rAm/7h3rAm.github.io/issues/new" target="_blank">issue</a> on blog repository.</p>
          <hr/>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <table>
                <tr>
                  <td align="left">(share via <a href="mailto:?subject=Network Stream Reassembly and Defragmentation&body=http://7h3ram.github.io//2013/libnids-pynids.html" target="_blank" title="Share via Email">mail</a>, <a href="http://twitter.com/intent/tweet?text=Network Stream Reassembly and Defragmentation+http://7h3ram.github.io//2013/libnids-pynids.html&via=7h3rAm" target="_blank" title="Share on Twitter">twitter</a>, <a href="http://www.facebook.com/sharer/sharer.php?s=100&p[url]=http://7h3ram.github.io//2013/libnids-pynids.html&p[images][0]=&p[title]=Network Stream Reassembly and Defragmentation&p[summary]=Libnids is a library that emulates Linux kernel 2.0.x TCP/IP stack to offer IP defragmentation, TCP reassembly and port scan detection features. This post talks about the Python wrapper and how to use it." target="_blank" title="Share on Facebook">facebook</a> or <a href="https://plus.google.com/share?url=http://7h3ram.github.io//2013/libnids-pynids.html" target="_blank" title="Share on Google Plus">google-plus</a>)</td>
                  <td align="right">(tagged <a href=/tags.html#code>code</a>)</td>
                </tr>
                <tr>
                                      <td align="left"><a href="/2013/libemu-shellcode-detection.html">&lt;&lt; x86 Emulation and Shellcode Detection &lt;&lt;</a></td>
                    <td align="right"><a href="/2013/malsoftware-reverse-ex.html">&gt;&gt; reverse-ex Challenge from Coursera's Malicious Software Course &gt;&gt;</a></td>
                                  </tr>
              </table>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </div>
        </div>
      </div>
    </div>
  </div>
  </article>
              <div class="footer">
          <center>
            <a href="/rss.xml" target="_blank">rss</a> | <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" rel="license" target="_blank">license</a>
          </center>
        </div>
          </section>
  </body>
</html>