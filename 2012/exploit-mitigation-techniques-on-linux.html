<!DOCTYPE html>
<html lang="en">
  <head>
    <title>7h3rAm's Infosec Ramblings</title>
    <meta charset="utf-8"/>
    <meta content="7h3rAm" name="author"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>

    <script src="/static/js/jquery/jquery-1.10.2.js"></script>
    <link href="/static/css/bootstrap/bootstrap.3.3.6.min.css" rel="stylesheet" type="text/css">
    <link href="/static/css/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="/static/css/morrisjs/morris.css" rel="stylesheet" type="text/css">
    <link href="/static/css/timeline/timeline.css" rel="stylesheet" type="text/css">
    <link href="/static/css/main.css" rel="stylesheet" type="text/css">
    <link href="/static/css/codehilite/zenburn.css" rel="stylesheet" type="text/css">
    <link href="/static/images/favicon.ico" rel="icon" type="image/x-icon"/>

    <!-- Google Analytics -->
    <script>
    window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
    ga('create', 'UA-50288765-1', '7h3rAm.github.io');
    ga('send', 'pageview');
    </script>
    <script async src='http://www.google-analytics.com/analytics.js'></script>
    <!-- End Google Analytics -->

  </head>
  <body id="index" class="home">
    <header class="header">
      <nav>
        <ul>
          <li><a href="/"><i class="fa fa-home"></i> Home</a></li>
          <li><a href="/archive.html"><i class="fa fa-archive"></i> Archive</a></li>
          <li><a href="/tags.html"><i class="fa fa-tags"></i> Tags</a></li>
          <li><a href="/dashboard.html"><i class="fa fa-bar-chart"></i> Dashboard</a></li>
          <li><a href="/research.html"><i class="fa fa-list-alt"></i> Research</a></li>
        </ul>
      </nav>
    </header>
    <section id="content" class="body">
      
  
  
  <article class="post">
  <div class="row">
    <div class="col-lg-12">
      <div class="panel panel-default">
        <div class="panel-heading post-title">
          Exploit Mitigation Techniques on Linux Systems
        </div>
        <div class="panel-body">
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
              
                
                
              
              
                
                
              
              
                <p class="post-date">
                  published on July 10, 2012<a href="/2012/geras-wuos-stack1-solutions.html"> <i class="fa fa-angle-double-right"></i></a><br/>
                  readtime: 26 minutes and 1 second (view <a href="https://raw.githubusercontent.io/7h3rAm/7h3rAm.github.io/master/_posts/exploit-mitigation-techniques-on-linux.md">source</a>)
                </p>
              
            
          
        <div class="post-summary">This post discusses various exploit mitigation techniques like NX, ASLR, PIE and SSP available on modern Linux distributions.</div>
        <div class="post-content">
          <p>Each year we see phenomenal research work being presented in a number of
security conferences and events around the world. Vendors/communities
present solutions for existing issues and those on the offensive side
present workarounds against these solutions. Eventually this race,
between those working on either sides of the coin, helps to make our
world a safer place.</p>

<p>Over the last decade, reliable exploitation of memory corruption bugs
has become extremely difficult. This has happened, primarily, due to the
introduction of various exploit mitigation techniques. In this post,
we&#8217;ll be looking at the current state of exploitation within the Linux
environment.The following security/mitigation techniques are commonly
available on most recent distributions:</p>

<ol>
<li>ASLR</li>
<li>NX</li>
<li>Stack Canaries</li>
<li>FORTIFY_SOURCE</li>
<li>RELRO</li>
<li>PIE</li>
</ol>

<p>Except for ASLR, which effects system-wide configuration, all of the
other techniques are user-space mitigation features that have to be
enabled on a per-binary basis. Here is the sample program that we&#8217;ll be
using for our tests:</p>

<div class="codehilite"><pre><code><span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;string.h&gt;</span>

<span class="kt">int</span> <span class="nf">main</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="n">array</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>
  <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;&amp;array: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">array</span><span class="p">);</span>
  <span class="n">gets</span> <span class="p">(</span><span class="n">array</span><span class="p">);</span>
  <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;*array: {</span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">array</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>Let&#8217;s have a detailed look at each of the above techniques:</p>

<h2>Address Space Layout Randomization - ASLR</h2>

<p>Enables randomization ofÂ  various memory allocation segments (<code>stack</code>,
<code>mmap</code>, <code>exec</code>, <code>brk</code>, and <code>vdso</code>). When enabled, each invocation of a
binary will have its memory allocations randomized within the available
virtual address space on the system. As such, an exploit technique like
<a href="http://en.wikipedia.org/wiki/Return-to-libc_attack">Ret2libc</a>, that
requires static memory addresses of common library functions, is no
longer effective:</p>

<div class="codehilite"><pre><code><span class="c"># sysctl kernel.randomize_va_space</span>
kernel.randomize_va_space <span class="o">=</span> 2
<span class="c">#</span>
<span class="c"># sysctl -w kernel.randomize_va_space=0</span>
kernel.randomize_va_space <span class="o">=</span> 0
<span class="c">#</span>
<span class="c"># cat /proc/sys/kernel/randomize_va_space</span>
0
<span class="c"># echo 2 &gt; /proc/sys/kernel/randomize_va_space</span>
</code></pre></div>

<p>The randomize<em>va</em>space kernel parameter defines system-wide
configuration setting for ASLR. This parameter could be set to the
following values:</p>

<ul>
<li>0: ASLR is turned OFF</li>
<li>1: ASLR is turned ON (stack randomization)</li>
<li>2: ASLR is turned ON (stack, heap, and mmap allocation randomization)</li>
</ul>

<p>Once enabled, each invocation of a program will have different memory
locations assigned to it:</p>

<div class="codehilite"><pre><code><span class="c"># cat /proc/self/maps</span>
08048000-08054000 r-xp <span class="m">00000000</span> 08:01 <span class="m">261660</span>     /bin/cat
08054000-08055000 r--p 0000b000 08:01 <span class="m">261660</span>     /bin/cat
08055000-08056000 rw-p 0000c000 08:01 <span class="m">261660</span>     /bin/cat
0827b000-0829c000 rw-p <span class="m">00000000</span> 00:00 <span class="m">0</span>          <span class="o">[</span>heap<span class="o">]</span>
b7588000-b75c7000 r--p <span class="m">00000000</span> 08:01 <span class="m">415795</span>     /usr/lib/locale/en_US.utf8/LC_CTYPE
b75c7000-b75c8000 r--p <span class="m">00000000</span> 08:01 <span class="m">415800</span>     /usr/lib/locale/en_US.utf8/LC_NUMERIC
b75c8000-b76e6000 r--p <span class="m">00000000</span> 08:01 <span class="m">415794</span>     /usr/lib/locale/en_US.utf8/LC_COLLATE
b76e6000-b76e7000 rw-p <span class="m">00000000</span> 00:00 0
b76e7000-b783a000 r-xp <span class="m">00000000</span> 08:01 <span class="m">5428</span>       /lib/tls/i686/cmov/libc-2.11.1.so
b783a000-b783b000 ---p <span class="m">00153000</span> 08:01 <span class="m">5428</span>       /lib/tls/i686/cmov/libc-2.11.1.so
b783b000-b783d000 r--p <span class="m">00153000</span> 08:01 <span class="m">5428</span>       /lib/tls/i686/cmov/libc-2.11.1.so
b783d000-b783e000 rw-p <span class="m">00155000</span> 08:01 <span class="m">5428</span>       /lib/tls/i686/cmov/libc-2.11.1.so
b783e000-b7841000 rw-p <span class="m">00000000</span> 00:00 0
b7841000-b7842000 r--p <span class="m">00000000</span> 08:01 <span class="m">415834</span>     /usr/lib/locale/en_US.utf8/LC_TIME
b7842000-b7843000 r--p <span class="m">00000000</span> 08:01 <span class="m">415833</span>     /usr/lib/locale/en_US.utf8/LC_MONETARY
b7843000-b7844000 r--p <span class="m">00000000</span> 08:01 <span class="m">415837</span>     /usr/lib/locale/en_US.utf8/LC_MESSAGES/SYS_LC_MESSAGES
b7844000-b7845000 r--p <span class="m">00000000</span> 08:01 <span class="m">415710</span>     /usr/lib/locale/en_US.utf8/LC_PAPER
b7845000-b7846000 r--p <span class="m">00000000</span> 08:01 <span class="m">415669</span>     /usr/lib/locale/en_US.utf8/LC_NAME
b7846000-b7847000 r--p <span class="m">00000000</span> 08:01 <span class="m">415832</span>     /usr/lib/locale/en_US.utf8/LC_ADDRESS
b7847000-b7848000 r--p <span class="m">00000000</span> 08:01 <span class="m">415838</span>     /usr/lib/locale/en_US.utf8/LC_TELEPHONE
b7848000-b7849000 r--p <span class="m">00000000</span> 08:01 <span class="m">415667</span>     /usr/lib/locale/en_US.utf8/LC_MEASUREMENT
b7849000-b7850000 r--s <span class="m">00000000</span> 08:01 <span class="m">294899</span>     /usr/lib/gconv/gconv-modules.cache
b7850000-b7851000 r--p <span class="m">00000000</span> 08:01 <span class="m">415835</span>     /usr/lib/locale/en_US.utf8/LC_IDENTIFICATION
b7851000-b7853000 rw-p <span class="m">00000000</span> 00:00 0
b7853000-b7854000 r-xp <span class="m">00000000</span> 00:00 <span class="m">0</span>          <span class="o">[</span>vdso<span class="o">]</span>
b7854000-b786f000 r-xp <span class="m">00000000</span> 08:01 <span class="m">969</span>        /lib/ld-2.11.1.so
b786f000-b7870000 r--p 0001a000 08:01 <span class="m">969</span>        /lib/ld-2.11.1.so
b7870000-b7871000 rw-p 0001b000 08:01 <span class="m">969</span>        /lib/ld-2.11.1.so
bfa54000-bfa75000 rw-p <span class="m">00000000</span> 00:00 <span class="m">0</span>          <span class="o">[</span>stack<span class="o">]</span>
</code></pre></div>

<div class="codehilite"><pre><code><span class="cp"># cat /proc/self/maps</span>
<span class="mi">08048000</span><span class="o">-</span><span class="mi">08054000</span> <span class="n">r</span><span class="o">-</span><span class="n">xp</span> <span class="mo">00000000</span> <span class="mi">08</span><span class="o">:</span><span class="mo">01</span> <span class="mi">261660</span>     <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">cat</span>
<span class="mi">08054000</span><span class="o">-</span><span class="mi">08055000</span> <span class="n">r</span><span class="o">--</span><span class="n">p</span> <span class="mo">0000</span><span class="n">b000</span> <span class="mi">08</span><span class="o">:</span><span class="mo">01</span> <span class="mi">261660</span>     <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">cat</span>
<span class="mi">08055000</span><span class="o">-</span><span class="mi">08056000</span> <span class="n">rw</span><span class="o">-</span><span class="n">p</span> <span class="mo">0000</span><span class="n">c000</span> <span class="mi">08</span><span class="o">:</span><span class="mo">01</span> <span class="mi">261660</span>     <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">cat</span>
<span class="mf">08f</span><span class="mi">09000</span><span class="o">-</span><span class="mf">08f</span><span class="mi">2</span><span class="n">a000</span> <span class="n">rw</span><span class="o">-</span><span class="n">p</span> <span class="mo">00000000</span> <span class="mo">00</span><span class="o">:</span><span class="mo">00</span> <span class="mi">0</span>          <span class="p">[</span><span class="n">heap</span><span class="p">]</span>
<span class="n">b755b000</span><span class="o">-</span><span class="n">b759a000</span> <span class="n">r</span><span class="o">--</span><span class="n">p</span> <span class="mo">00000000</span> <span class="mi">08</span><span class="o">:</span><span class="mo">01</span> <span class="mi">415795</span>     <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">locale</span><span class="o">/</span><span class="n">en_US</span><span class="p">.</span><span class="n">utf8</span><span class="o">/</span><span class="n">LC_CTYPE</span>
<span class="n">b759a000</span><span class="o">-</span><span class="n">b759b000</span> <span class="n">r</span><span class="o">--</span><span class="n">p</span> <span class="mo">00000000</span> <span class="mi">08</span><span class="o">:</span><span class="mo">01</span> <span class="mi">415800</span>     <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">locale</span><span class="o">/</span><span class="n">en_US</span><span class="p">.</span><span class="n">utf8</span><span class="o">/</span><span class="n">LC_NUMERIC</span>
<span class="n">b759b000</span><span class="o">-</span><span class="n">b76b9000</span> <span class="n">r</span><span class="o">--</span><span class="n">p</span> <span class="mo">00000000</span> <span class="mi">08</span><span class="o">:</span><span class="mo">01</span> <span class="mi">415794</span>     <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">locale</span><span class="o">/</span><span class="n">en_US</span><span class="p">.</span><span class="n">utf8</span><span class="o">/</span><span class="n">LC_COLLATE</span>
<span class="n">b76b9000</span><span class="o">-</span><span class="n">b76ba000</span> <span class="n">rw</span><span class="o">-</span><span class="n">p</span> <span class="mo">00000000</span> <span class="mo">00</span><span class="o">:</span><span class="mo">00</span> <span class="mi">0</span>
<span class="n">b76ba000</span><span class="o">-</span><span class="n">b780d000</span> <span class="n">r</span><span class="o">-</span><span class="n">xp</span> <span class="mo">00000000</span> <span class="mi">08</span><span class="o">:</span><span class="mo">01</span> <span class="mi">5428</span>       <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">tls</span><span class="o">/</span><span class="n">i686</span><span class="o">/</span><span class="n">cmov</span><span class="o">/</span><span class="n">libc</span><span class="o">-</span><span class="mf">2.11.1</span><span class="p">.</span><span class="n">so</span>
<span class="n">b780d000</span><span class="o">-</span><span class="n">b780e000</span> <span class="o">---</span><span class="n">p</span> <span class="mo">00153000</span> <span class="mi">08</span><span class="o">:</span><span class="mo">01</span> <span class="mi">5428</span>       <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">tls</span><span class="o">/</span><span class="n">i686</span><span class="o">/</span><span class="n">cmov</span><span class="o">/</span><span class="n">libc</span><span class="o">-</span><span class="mf">2.11.1</span><span class="p">.</span><span class="n">so</span>
<span class="n">b780e000</span><span class="o">-</span><span class="n">b7810000</span> <span class="n">r</span><span class="o">--</span><span class="n">p</span> <span class="mo">00153000</span> <span class="mi">08</span><span class="o">:</span><span class="mo">01</span> <span class="mi">5428</span>       <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">tls</span><span class="o">/</span><span class="n">i686</span><span class="o">/</span><span class="n">cmov</span><span class="o">/</span><span class="n">libc</span><span class="o">-</span><span class="mf">2.11.1</span><span class="p">.</span><span class="n">so</span>
<span class="n">b7810000</span><span class="o">-</span><span class="n">b7811000</span> <span class="n">rw</span><span class="o">-</span><span class="n">p</span> <span class="mo">00155000</span> <span class="mi">08</span><span class="o">:</span><span class="mo">01</span> <span class="mi">5428</span>       <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">tls</span><span class="o">/</span><span class="n">i686</span><span class="o">/</span><span class="n">cmov</span><span class="o">/</span><span class="n">libc</span><span class="o">-</span><span class="mf">2.11.1</span><span class="p">.</span><span class="n">so</span>
<span class="n">b7811000</span><span class="o">-</span><span class="n">b7814000</span> <span class="n">rw</span><span class="o">-</span><span class="n">p</span> <span class="mo">00000000</span> <span class="mo">00</span><span class="o">:</span><span class="mo">00</span> <span class="mi">0</span>
<span class="n">b7814000</span><span class="o">-</span><span class="n">b7815000</span> <span class="n">r</span><span class="o">--</span><span class="n">p</span> <span class="mo">00000000</span> <span class="mi">08</span><span class="o">:</span><span class="mo">01</span> <span class="mi">415834</span>     <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">locale</span><span class="o">/</span><span class="n">en_US</span><span class="p">.</span><span class="n">utf8</span><span class="o">/</span><span class="n">LC_TIME</span>
<span class="n">b7815000</span><span class="o">-</span><span class="n">b7816000</span> <span class="n">r</span><span class="o">--</span><span class="n">p</span> <span class="mo">00000000</span> <span class="mi">08</span><span class="o">:</span><span class="mo">01</span> <span class="mi">415833</span>     <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">locale</span><span class="o">/</span><span class="n">en_US</span><span class="p">.</span><span class="n">utf8</span><span class="o">/</span><span class="n">LC_MONETARY</span>
<span class="n">b7816000</span><span class="o">-</span><span class="n">b7817000</span> <span class="n">r</span><span class="o">--</span><span class="n">p</span> <span class="mo">00000000</span> <span class="mi">08</span><span class="o">:</span><span class="mo">01</span> <span class="mi">415837</span>     <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">locale</span><span class="o">/</span><span class="n">en_US</span><span class="p">.</span><span class="n">utf8</span><span class="o">/</span><span class="n">LC_MESSAGES</span><span class="o">/</span><span class="n">SYS_LC_MESSAGES</span>
<span class="n">b7817000</span><span class="o">-</span><span class="n">b7818000</span> <span class="n">r</span><span class="o">--</span><span class="n">p</span> <span class="mo">00000000</span> <span class="mi">08</span><span class="o">:</span><span class="mo">01</span> <span class="mi">415710</span>     <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">locale</span><span class="o">/</span><span class="n">en_US</span><span class="p">.</span><span class="n">utf8</span><span class="o">/</span><span class="n">LC_PAPER</span>
<span class="n">b7818000</span><span class="o">-</span><span class="n">b7819000</span> <span class="n">r</span><span class="o">--</span><span class="n">p</span> <span class="mo">00000000</span> <span class="mi">08</span><span class="o">:</span><span class="mo">01</span> <span class="mi">415669</span>     <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">locale</span><span class="o">/</span><span class="n">en_US</span><span class="p">.</span><span class="n">utf8</span><span class="o">/</span><span class="n">LC_NAME</span>
<span class="n">b7819000</span><span class="o">-</span><span class="n">b781a000</span> <span class="n">r</span><span class="o">--</span><span class="n">p</span> <span class="mo">00000000</span> <span class="mi">08</span><span class="o">:</span><span class="mo">01</span> <span class="mi">415832</span>     <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">locale</span><span class="o">/</span><span class="n">en_US</span><span class="p">.</span><span class="n">utf8</span><span class="o">/</span><span class="n">LC_ADDRESS</span>
<span class="n">b781a000</span><span class="o">-</span><span class="n">b781b000</span> <span class="n">r</span><span class="o">--</span><span class="n">p</span> <span class="mo">00000000</span> <span class="mi">08</span><span class="o">:</span><span class="mo">01</span> <span class="mi">415838</span>     <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">locale</span><span class="o">/</span><span class="n">en_US</span><span class="p">.</span><span class="n">utf8</span><span class="o">/</span><span class="n">LC_TELEPHONE</span>
<span class="n">b781b000</span><span class="o">-</span><span class="n">b781c000</span> <span class="n">r</span><span class="o">--</span><span class="n">p</span> <span class="mo">00000000</span> <span class="mi">08</span><span class="o">:</span><span class="mo">01</span> <span class="mi">415667</span>     <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">locale</span><span class="o">/</span><span class="n">en_US</span><span class="p">.</span><span class="n">utf8</span><span class="o">/</span><span class="n">LC_MEASUREMENT</span>
<span class="n">b781c000</span><span class="o">-</span><span class="n">b7823000</span> <span class="n">r</span><span class="o">--</span><span class="n">s</span> <span class="mo">00000000</span> <span class="mi">08</span><span class="o">:</span><span class="mo">01</span> <span class="mi">294899</span>     <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">gconv</span><span class="o">/</span><span class="n">gconv</span><span class="o">-</span><span class="n">modules</span><span class="p">.</span><span class="n">cache</span>
<span class="n">b7823000</span><span class="o">-</span><span class="n">b7824000</span> <span class="n">r</span><span class="o">--</span><span class="n">p</span> <span class="mo">00000000</span> <span class="mi">08</span><span class="o">:</span><span class="mo">01</span> <span class="mi">415835</span>     <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">locale</span><span class="o">/</span><span class="n">en_US</span><span class="p">.</span><span class="n">utf8</span><span class="o">/</span><span class="n">LC_IDENTIFICATION</span>
<span class="n">b7824000</span><span class="o">-</span><span class="n">b7826000</span> <span class="n">rw</span><span class="o">-</span><span class="n">p</span> <span class="mo">00000000</span> <span class="mo">00</span><span class="o">:</span><span class="mo">00</span> <span class="mi">0</span>
<span class="n">b7826000</span><span class="o">-</span><span class="n">b7827000</span> <span class="n">r</span><span class="o">-</span><span class="n">xp</span> <span class="mo">00000000</span> <span class="mo">00</span><span class="o">:</span><span class="mo">00</span> <span class="mi">0</span>          <span class="p">[</span><span class="n">vdso</span><span class="p">]</span>
<span class="n">b7827000</span><span class="o">-</span><span class="n">b7842000</span> <span class="n">r</span><span class="o">-</span><span class="n">xp</span> <span class="mo">00000000</span> <span class="mi">08</span><span class="o">:</span><span class="mo">01</span> <span class="mi">969</span>        <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ld</span><span class="o">-</span><span class="mf">2.11.1</span><span class="p">.</span><span class="n">so</span>
<span class="n">b7842000</span><span class="o">-</span><span class="n">b7843000</span> <span class="n">r</span><span class="o">--</span><span class="n">p</span> <span class="mo">0001</span><span class="n">a000</span> <span class="mi">08</span><span class="o">:</span><span class="mo">01</span> <span class="mi">969</span>        <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ld</span><span class="o">-</span><span class="mf">2.11.1</span><span class="p">.</span><span class="n">so</span>
<span class="n">b7843000</span><span class="o">-</span><span class="n">b7844000</span> <span class="n">rw</span><span class="o">-</span><span class="n">p</span> <span class="mo">0001</span><span class="n">b000</span> <span class="mi">08</span><span class="o">:</span><span class="mo">01</span> <span class="mi">969</span>        <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ld</span><span class="o">-</span><span class="mf">2.11.1</span><span class="p">.</span><span class="n">so</span>
<span class="n">bfb89000</span><span class="o">-</span><span class="n">bfbaa000</span> <span class="n">rw</span><span class="o">-</span><span class="n">p</span> <span class="mo">00000000</span> <span class="mo">00</span><span class="o">:</span><span class="mo">00</span> <span class="mi">0</span>          <span class="p">[</span><span class="n">stack</span><span class="p">]</span>
</code></pre></div>

<p>In the above output note thatÂ all the segments of the <code>/bin/cat</code> process
are mapped at different memory locations with each invocation. However,
closer look provides an interesting observation. The first three
segments that contain <code>.text</code> section of the binary (notice the r-x
permissions) are still mapped at similar locations each time. We have
enabled <em>ASLR</em> and it is indeed active, so why aren&#8217;t the <code>.text</code>
segments not mapped randomly? We will talk about this behavior in much
detail within the <em>PIE</em> section.</p>

<h2>Non-Executable Bit (NX)</h2>

<p>This feature disallows code execution from marked memory pages/segments.
It is also referred to as <em>W\^X</em> (W XOR X) due to the fact that the
pages marked with this feature could either be writable or executable
but not both at the same time. When enabled, a process&#8217;s memory
allocations, that do not contain instructions, will have only rw-
permissions assigned to them by default. As such, even if an attacker
successfully injects code into a writable memory region through an
overflow bug, an attempt to execute code from this section would still
fail. <em>NX</em> is enabled through the MMU by setting bit 63 of the <em>page
directory entry</em>. Important thing to note here is that this feature is
available only on those systems that have 64bit capability or on those
systems that use a PAE-enabled kernel. This is because on a regular
32bit kernel without PAE support, a <em>page directory entry</em> is just 32bit
wide and hence there is no room to store additional meta-information
about memory pages it points to. The <em>Execshield</em> and <em>Grsecurity</em> set
of kernel patches could also be used to simulate this behavior when the
above requirements could not be met:</p>

<div class="codehilite"><pre><code><span class="c"># gcc -o test test.c 2&gt;/dev/null &amp;&amp; readelf -l test | grep GNU_STACK</span>
  GNU_STACK      0x000000 0x00000000 0x00000000 0x00000 0x00000 RW  0x4
<span class="c">#</span>
<span class="c"># gcc -z execstack -o test test.c 2&gt;/dev/null &amp;&amp; readelf -l test | grep GNU_STACK</span>
  GNU_STACK      0x000000 0x00000000 0x00000000 0x00000 0x00000 RWE 0x4
<span class="c">#</span>
<span class="c"># gcc -z noexecstack -o test test.c 2&gt;/dev/null &amp;&amp; readelf -l test | grep GNU_STACK</span>
  GNU_STACK      0x000000 0x00000000 0x00000000 0x00000 0x00000 RW  0x4
</code></pre></div>

<ul>
<li><code>-z execstack</code>: request the linker to mark program stack as executable</li>
<li><code>-z noexecstack</code>: request the linker to mark program stack as non-executable (recommended)</li>
</ul>

<p>Note the permissions of the <code>GNU_STACK</code> section in the above output.
When we request executable stack through the linker option, GCC marks
the stack as executable with RWE permissions. On my test system, which
is an Ubuntu 10.04 derivative with GCC version 4.4.3, the default
command-line disables executable stack markings as evident in the output
of first command-line. This behavior of implicitly enabling safeguards
makes an application immune to stack-based execution and other such
attacks even if the developer fails to include them during compilation.</p>

<h2>Stack Canaries / Stack-Smashing Protection (SSP)</h2>

<p>Stack Canaries are a protection feature that safeguard critical program
metadata information located on call stack. When enabled, a random
canary value is placed on the stack, just below the saved registers from
the function prologue. Before a program returns control to its parent,
the saved canary value is checked. Any attempts to overwrite the saved
return address on the stack will also overwrite the saved cookie and as
such the above check would fail. In such cases, the <code>__stack_chk_fail</code>
function is called, which displays a friendly <em>stack smashing detected</em>
message and aborts the execution of the program.This mitigation
technique also reorders the placement of local variables on the stack.
This is done to ensure that any variable, that directly influences the
program control and redirects its normal flow, is placed below a buffer
that accepts user-supplied input. Such a placement prevents overwriting
of variables placed adjacent to buffers. To read more about other such
novel ideas implemented in this protection technique, visit this link:
SSP</p>

<div class="codehilite"><pre><code><span class="c"># gcc -fstack-protector -o test test.c 2&gt;/dev/null &amp;&amp; readelf -r test | grep _chk</span>
0804a010  <span class="m">00000507</span> R_386_JUMP_SLOT   <span class="m">00000000</span>   __stack_chk_fail
<span class="c">#</span>
<span class="c"># gcc -fstack-protector-all -o test test.c 2&gt;/dev/null &amp;&amp; readelf -r test | grep _chk</span>
0804a010  <span class="m">00000507</span> R_386_JUMP_SLOT   <span class="m">00000000</span>   __stack_chk_fail
<span class="c">#</span>
<span class="c"># gcc -fno-stack-protector -o test test.c 2&gt;/dev/null &amp;&amp; readelf -r test | grep _chk</span>
</code></pre></div>

<p>The following options enable/disable this check:</p>

<ul>
<li><code>-fstack-protector</code>: enable checks for functions with character buffers of size 8B or higher</li>
<li><code>-fstack-protector-all</code>: enable checks for all functions (recommended)</li>
<li><code>-fno-stack-protector</code>: disable stack protection checks</li>
<li><code>-Wstack-protector</code>: emit warnings for all unprotected functions (recommended)</li>
<li><code>--param=ssp-buffer-size=&lt;size_in_bytes&gt;</code>: modifies the default 8B buffer lengthGCC versions 4.x include SSP techniques in their native implementations. Prior 3.x versions had this feature enabled through a patch.</li>
</ul>

<h2>FORTIFY_SOURCE</h2>

<p>There are cases when a compiler can correctly estimate the size of a
destination operand used in a certain string operation. For such cases,
the compiler could be requested to replace any vulnerable function calls
in the program source with their equivalent safer counterparts. This
would eventually make the compiled binary resilient to most overflow
attempts without significantly impacting its performance:</p>

<div class="codehilite"><pre><code><span class="c"># gcc -O1 -D_FORTIFY_SOURCE=2 -o test test.c 2&gt;/dev/null &amp;&amp; readelf -r test | grep _chk</span>
0804a004  <span class="m">00000207</span> R_386_JUMP_SLOT   <span class="m">00000000</span>   __printf_chk
0804a008  <span class="m">00000307</span> R_386_JUMP_SLOT   <span class="m">00000000</span>   __gets_chk
0804a010  <span class="m">00000507</span> R_386_JUMP_SLOT   <span class="m">00000000</span>   __stack_chk_fail
</code></pre></div>

<p>In the above output you could see that the GCC option <code>-D_FORIFY_SOURCE</code>
has been used to include fortifying checks. The call for function
<code>printf</code> and <code>gets</code> were replaced with their safer equivalents,
<code>printf_chk</code> and <code>gets_chk</code> respectively. This option can accept two
values:</p>

<ul>
<li><code>-D_FORIFY_SOURCE=1</code>: to enable checks against buffer overflow attacks</li>
<li><code>-D_FORIFY_SOURCE=2</code>: to enable checks against buffer overflow and format string attacks (recommended)</li>
</ul>

<h2>RELocation Read-Only (RELRO)</h2>

<p>Another mitigation technique that safeguard against those exploits that
require <em>Global Offset Table (GOT)</em> modifications. For this to work, all
dynamic symbol resolutions, requested by a binary, have to be carried
out before the program execution begins. Once this is done, the GOT
could be marked as read-only, thus preventing any runtime modifications.</p>

<p>By default, when we use the GCC linker option <code>-Wl,-z,relro</code>, <em>PLT
(Procedure Linking Table)</em> entries, which include references for library
functions within a process&#8217;s memory allocation, are marked as writable
(lazy-linking). All other GOT entries apart from PLT remain read-only,
providing what is know as <em>Partial-RELRO</em> support:</p>

<div class="codehilite"><pre><code><span class="c"># gcc -Wl,-z,norelro -o test test.c 2&gt;/dev/null &amp;&amp; readelf -l test | grep GNU_RELRO</span>
<span class="c">#</span>
<span class="c"># gcc -Wl,-z,relro -o test test.c 2&gt;/dev/null &amp;&amp; readelf -l test | grep GNU_RELRO</span>
  GNU_RELRO      0x000f0c 0x08049f0c 0x08049f0c 0x000f4 0x000f4 R   0x1
<span class="c">#</span>
<span class="c"># gcc -Wl,-z,relro,-z,now -o test test.c 2&gt;/dev/null &amp;&amp; readelf -l test | grep GNU_RELRO &amp;&amp; readelf -d test | grep BIND_NOW</span>
  GNU_RELRO      0x000ee8 0x08049ee8 0x08049ee8 0x00118 0x00118 R   0x1
 0x00000018 <span class="o">(</span>BIND_NOW<span class="o">)</span>
</code></pre></div>

<p>The <code>-z,now</code> option ensures that PLT entries are resolved immediately
before execution, thus allowing the entire GOT to be marked as
read-only. This ensure that <code>Full-RELRO</code> support is enabled for the
compiled program. The summary for these options is:</p>

<ul>
<li><code>-Wl,-z,relro</code>: enables Partial RELRO support</li>
<li><code>-Wl,-z,relro,-z,now</code>: enables Full-RELRO support (recommended)</li>
</ul>

<h2>Position-Independent Executable (PIE)</h2>

<p>This feature helps to load a program at a random memory location on each
invocation. With <em>ASLR</em> enabled, the stack, heap, and mmap allocations
are automatically randomized. However, like we saw earlier with the
<em>/bin/cat</em> binary, the <code>.text</code> and other sections of a program are still
loaded at static addresses. To make all sections of a program to load at
random addresses, we need to compile it with PIE support:</p>

<div class="codehilite"><pre><code><span class="cp"># gcc -o test test.c 2&gt;/dev/null | file test | cut -d, -f1</span>
<span class="nl">test</span><span class="p">:</span> <span class="n">ELF</span> <span class="mi">32</span><span class="o">-</span><span class="n">bit</span> <span class="n">LSB</span> <span class="n">executable</span>
<span class="cp">#</span>
<span class="cp"># gcc -fpie -pie -o test test.c 2&gt;/dev/null | file test | cut -d, -f1</span>
<span class="nl">test</span><span class="p">:</span> <span class="n">ELF</span> <span class="mi">32</span><span class="o">-</span><span class="n">bit</span> <span class="n">LSB</span> <span class="n">executable</span>
</code></pre></div>

<p>The following GCC options could be used to enable PIE support as evident
from the above output: <code>-fpie -pie</code> (recommended). Programs compiled
with this feature are marked as shared relocatable, much similar to
shared object libraries used in dynamic linking. To read more, visit
this link:
<a href="http://blog.fpmurphy.com/2008/06/position-independent-executables.html">PIE</a></p>

<p>Enabling these mitigation techniques will definitely improve the overall
security posture of a system, it still does not make it bullet-proof.
Some of these techniques might break compatibility with legacy
applications, while others might not work as expected. Different
distributions use different default configuration settings and as such
you can not simply standardize. The most suitable option would be to
test your application code first hand with each of these options,
carefully considering the tradeoffs and using only those that provide
that rare mix of security and usability.</p>

        </div>
        <div class="post-bottomline">
          <hr/>
          <p>For comments, questions and suggestions use <a href="https://twitter.com/7h3rAm" target="_blank"><i class="fa fa-twitter"></i></a> or create an <a href="https://github.com/7h3rAm/7h3rAm.github.io/issues/new" target="_blank"><i class="fa fa-exclamation-circle"></i> issue</a> on blog reporsitory.</p>
          <hr/>
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
              
                
                
              
              
                
                
              
              <table>
                <tr>
                  <td align="left">(share via <a href="mailto:?subject=Exploit Mitigation Techniques on Linux Systems&body=/2012/exploit-mitigation-techniques-on-linux.html" target="_blank" title="Share via Email"><i class="fa fa-inbox"></i></a> <a href="http://twitter.com/intent/tweet?text=Exploit Mitigation Techniques on Linux Systems+/2012/exploit-mitigation-techniques-on-linux.html&via=7h3rAm" target="_blank" title="Share on Twitter"><i class="fa fa-twitter"></i></a> <a href="http://www.facebook.com/sharer/sharer.php?s=100&p[url]=/2012/exploit-mitigation-techniques-on-linux.html&p[images][0]=&p[title]=Exploit Mitigation Techniques on Linux Systems&p[summary]=This post discusses various exploit mitigation techniques like NX, ASLR, PIE and SSP available on modern Linux distributions." target="_blank" title="Share on Facebook"><i class="fa fa-facebook"></i></a> <a href="https://plus.google.com/share?url=/2012/exploit-mitigation-techniques-on-linux.html" target="_blank" title="Share on Google Plus"><i class="fa fa-google-plus"></i></a>)</td>
                  <td align="right">(tagged <a href=/tags.html#exploit>exploit</a> and <a href=/tags.html#mitigations>mitigations</a>)</td>
                </tr>
                <tr>
                  
                    <td align="right" colspan="2"><a href="/2012/geras-wuos-stack1-solutions.html"><i class="fa fa-angle-double-right"></i> Gera's Warming Up on Stack #1 - Solutions <i class="fa fa-angle-double-right"></i></a></td>
                  
                </tr>
              </table>
            
          
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-12">
      <div class="panel panel-default">
        <div class="panel-heading post-title">
          Related Posts
        </div>
        <div class="panel-body">
          
            1. <a href="/2013/geras-wuos-stack4-solutions.html">Gera's Warming Up on Stack #4 - Solutions</a>
            <div class="overview-date">January 4, 2013</div>
            <br/>
          
            2. <a href="/2012/geras-wuos-stack1-solutions.html">Gera's Warming Up on Stack #1 - Solutions</a>
            <div class="overview-date">August 27, 2012</div>
            <br/>
          
            3. <a href="/2012/word-list-builder-dic-file-parsing-seh.html">Word List Builder .dic File Parsing SEH Overflow</a>
            <div class="overview-date">September 2, 2012</div>
            <br/>
          
        </div>
      </div>
    </div>
  </div>

  </article>

    </section>
    <footer class="footer">
      <b><a href="/">Ankur Tyagi</a></b> (<b><a href="https://twitter.com/7h3rAm" target="_blank"><i class="fa fa-at"></i>7h3rAm</a></b>)
      <br/>
      Last updated on October 20, 2016 (<b><a href="/rss.xml"><i class="fa fa-rss"></i> rss</a></b> <b><a href="/sitemap.xml"><i class="fa fa-sitemap"></i> sitemap</a></b>)
      <br/>
      Published under <b><a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" rel="license" target="_blank">by-nc-sa</a></b> and powered by <b><a alt="Linux" href="https://www.kernel.org/" target="_blank"><i class="fa fa-linux"></i></a></b>, <b><a alt="Kalpi" href="https://github.com/7h3rAm/kalpi/" target="_blank">kalpi</a></b>, <b><a href="http://git-scm.com/" target="_blank"><i class="fa fa-git"></i></a></b> and <b><a href="https://github.com/7h3rAm/7h3ram.github.io" target="_blank"><i class="fa fa-github"></i></a></b>
    </footer>

    <script src="/static/js/bootstrap/bootstrap.3.3.6.min.js"></script>
    <script src="/static/js/raphael/raphael-min.js"></script>
    <script src="/static/js/morrisjs/morris.min.js"></script>
    <script src="/static/files/chart-data.js"></script>
    <script src="/static/js/sprintf/sprintf.js"></script>
    <script src="/static/js/underscore/underscore-min.js"></script>

  </body>
</html>