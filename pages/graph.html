<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>QEDR Threat Score Decision Tree</title>
    <style>
      * { font: 12px FiraCode Nerd Font; }
      .node circle {
        fill: #e8e6d5;
        stroke: #999999;
        stroke-width: 2px;
      }
      .link {
        fill: none;
        stroke: #8897f4;
        stroke-width: 2px;
      }
    </style>
  </head>
  <body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>
    <script>
      var margin = {top: 100, right: 120, bottom: 50, left: 120}, width = 1500 - margin.right - margin.left, height = 1200 - margin.top - margin.bottom;
      var i = 0, duration = 750, root;
      var tree = d3.layout.tree().size([height, width]);
      var diagonal = d3.svg.diagonal().projection(function(d) { return [d.x, d.y]; });
      var svg = d3.select("body").append("svg").attr("width", width + margin.right + margin.left).attr("height", height + margin.top + margin.bottom).append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");
      svg.append("text").attr("x", (width / 2)).attr("y", 0 - (margin.top / 2)).attr("text-anchor", "middle").style("font-size", "18px").text("QEDR Threat Scoring Decision Tree");
      d3.json("summary.json", function(error, summary) { root = summary.tree; root.x0 = height / 2; root.y0 = 0; update(root); });
      d3.select(self.frameElement).style("height", "3000px");
      var force = d3.layout.force().nodes(nodes).size([width, height]).gravity(0).charge(0).on("tick", tick).start();
      var circle = svg.selectAll("circle").data(nodes).enter().append("circle").attr("r", function(d) { return d.radius; }).style("fill", function(d) { return color(d.cluster); }).call(force.drag);
      function tick(e) { circle.each(cluster(10 * e.alpha * e.alpha)).each(collide(.5)).attr("cx", function(d) { return d.x; }).attr("cy", function(d) { return d.y; }); }
      force.nodes(nodes).start();
      force.on("tick", function() {
        text.attr("x", function(d) { return d.x + 6; }).attr("y", function(d) { return d.y + 4; });
        node.attr("cx", function(d) { return d.x; }).attr("cy", function(d) { return d.y; });
      });
      function update(source) {
        var nodes = tree.nodes(root).reverse(), links = tree.links(nodes);
        nodes.forEach(function(d) { d.y = d.depth * 90; });
        var node = svg.selectAll("g.node").data(nodes, function(d) { return d.id || (d.id = ++i); });

        var nodeEnter = node.enter().append("g").attr("class", "node").attr("transform", function(d) { return "translate(" + source.x0 + "," + source.y0 + ")"; }).on("click", click);
        nodeEnter.append("circle").attr("r", function(d) { return d.size*2; }).style("stroke", function(d) { return d.nodecolor; }).style("fill", function(d) { return d.fillcolor; }).append("svg:title").text(function(d, i) { return d.tooltip; });
        nodeEnter.append("text").attr("y", function(d) { return d.children || d._children ? 0 : 0; }).attr("dy", ".35em").attr("text-anchor", "middle").style("fill-opacity", 1).text(function(d) { return d.value; });
        nodeEnter.append("text").attr("y", function(d) { return d.children || d._children ? -30 : 30; }).attr("dy", ".35em").attr("text-anchor", "middle").text(function(d) { return d.outlabel; }).style("fill-opacity", 1);

        var nodeUpdate = node.transition().duration(duration).attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
        nodeEnter.append("circle").attr("r", function(d) { return d.size*2; }).style("stroke", function(d) { return d.nodecolor; }).style("fill", function(d) { return d.fillcolor; }).append("svg:title").text(function(d, i) { return d.tooltip; });
        nodeEnter.append("text").attr("y", function(d) { return d.children || d._children ? 0 : 0; }).attr("dy", ".35em").attr("text-anchor", "middle").text(function(d) { return d.inlabel; }).style("fill-opacity", 1);
        nodeEnter.append("text").attr("y", function(d) { return d.children || d._children ? -30 : 30; }).attr("dy", ".35em").attr("text-anchor", "middle").text(function(d) { return d.outlabel; }).style("fill-opacity", 1);

        var nodeExit = node.exit().transition().duration(duration).attr("transform", function(d) { return "translate(" + source.x + "," + source.y + ")"; }).remove();
        nodeExit.select("circle").attr("r", 1e-6);
        nodeExit.select("text").style("fill-opacity", 1e-6);

        var link = svg.selectAll("path.link").data(links, function(d) { return d.target.id; });
        link.enter().insert("path", "g").attr("class", "link").style("stroke", function(d) { return d.target.edgecolor; }).attr("d", function(d) {var o = {x: source.x0, y: source.y0}; return diagonal({source: o, target: o}); });
        link.transition().duration(duration).attr("d", diagonal);
        link.exit().transition().duration(duration).attr("d", function(d) {var o = {x: source.x, y: source.y}; return diagonal({source: o, target: o}); }).remove();
        nodes.forEach(function(d) { d.x0 = d.x; d.y0 = d.y; });
      }
      function click(d) {
        if (d.children) {
          d._children = d.children;
          d.children = null;
        } else {
          d.children = d._children;
          d._children = null;
        }
        update(d);
      }
    </script>
  </body>
</html>
